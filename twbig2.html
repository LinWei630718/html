<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>BIG2å¤§è€äºŒå–®äººç«¶æŠ€(å°ç£è¦å‰‡ç‰ˆ)</title>

<style>
/* ===== å…¨å±€èˆ‡èƒŒæ™¯è¨­å®š ===== */
body {
    margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: radial-gradient(circle, #0f5132, #063d25);
    color: white; text-align: center; overflow-x: hidden;
}
/* æ–°å¢ï¼šè¢å¹•éœ‡å‹•ç‰¹æ•ˆ */
@keyframes shake {
    0% { transform: translate(1px, 1px) rotate(0deg); }
    10% { transform: translate(-3px, -2px) rotate(-1deg); }
    20% { transform: translate(-3px, 0px) rotate(1deg); }
    30% { transform: translate(3px, 2px) rotate(0deg); }
    40% { transform: translate(1px, -1px) rotate(1deg); }
    50% { transform: translate(-1px, 2px) rotate(-1deg); }
    60% { transform: translate(-3px, 1px) rotate(0deg); }
    70% { transform: translate(3px, 1px) rotate(-1deg); }
    80% { transform: translate(-1px, -1px) rotate(1deg); }
    90% { transform: translate(1px, 2px) rotate(0deg); }
    100% { transform: translate(1px, -2px) rotate(-1deg); }
}
.shake-screen { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }

h2 { margin-top: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); font-size: 22px; }
#info { margin-top: 5px; font-size: 16px; font-weight: bold; color: #ffc107; height: 24px; }

/* ===== é ‚éƒ¨æ§åˆ¶åˆ— (è¨˜åˆ†æ¿èˆ‡æŒ‰éˆ•) ===== */
.top-panel {
    background: rgba(0, 0, 0, 0.4); border-radius: 8px; padding: 10px; margin: 10px auto;
    width: 90%; max-width: 600px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); z-index: 20; position: relative;
}
.scoreboard-title { color: #ffc300; font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 3px; font-size: 14px; }
#scoreDisplay { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px 15px; font-size: 14px; margin-top: 5px; }
.score-positive { color: #4ade80; } .score-negative { color: #f87171; }
.btn-small { background: #0f5132; color: white; border: 1px solid #4ade80; padding: 4px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; margin: 5px; }

/* ===== å°æ‰‹è³‡è¨Šåˆ— (HUD) ===== */
.opponents-hud { display: flex; justify-content: space-around; align-items: center; width: 90%; max-width: 600px; margin: 10px auto 5px auto; }
.opp-box { background: rgba(0, 0, 0, 0.3); border: 1px solid #555; border-radius: 10px; padding: 8px 12px; width: 25%; transition: 0.3s; }
.opp-box.active { border-color: #ffc300; background: rgba(255, 195, 0, 0.15); transform: scale(1.05); }
.opp-name { font-size: 13px; color: #ddd; margin-bottom: 4px; }
.opp-count { font-size: 18px; font-weight: bold; color: #fff; }

/* ===== éŠæˆ²å€åŸŸ ===== */
#table { min-height: 120px; margin: 5px auto 20px auto; display: flex; justify-content: center; flex-wrap: wrap; background: rgba(0,0,0,0.2); border-radius: 15px; width: 90%; max-width: 600px; padding: 20px 0; }
.hand { display: flex; justify-content: flex-start; overflow-x: auto; padding: 15px 10px 20px 10px; width: 95%; max-width: 800px; margin: 0 auto; }

/* ===== å¡ç‰Œè¨­è¨ˆ ===== */
.card { flex: 0 0 auto; width: 65px; height: 95px; background: #fdfdfd; border-radius: 8px; margin: 0 -10px; position: relative; cursor: pointer; transition: transform 0.2s; box-shadow: -2px 0 8px rgba(0,0,0,0.4); border: 1px solid #ccc; user-select: none; }
.card:first-child { margin-left: 0; }
.card:hover { transform: translateY(-10px); }
.card.selected { transform: translateY(-20px); box-shadow: 0 10px 20px rgba(0,0,0,0.6); border: 2px solid #ffc300; }
.corner { position: absolute; font-size: 14px; font-weight: 900; z-index: 2; }
.top-left { top: 4px; left: 6px; }
.bottom-right { bottom: 4px; right: 6px; transform: rotate(180deg); }
.center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 28px; z-index: 2; width: 100%; }
.watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 65px; opacity: 0.1; z-index: 1; pointer-events: none; }
.face-card-text { font-family: 'Georgia', serif; font-size: 32px; font-weight: bold; line-height: 0.9; }
.face-card-suit { font-size: 18px; display: block; margin-top: 2px; }
.red { color: #d90429; } .black { color: #111111; }
.card.back { background: repeating-linear-gradient(45deg, #0f5132, #0f5132 10px, #063d25 10px, #063d25 20px); border: 2px solid #fff; }

/* ===== å‹•ç•«ç‰¹æ•ˆ (æ´—ç‰Œèˆ‡å½©å¸¶) ===== */
#shuffleOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; display: flex; flex-direction: column; justify-content: center; align-items: center; }
.shuffle-cards { display: flex; gap: 10px; margin-bottom: 20px; }
.shuffle-card { width: 50px; height: 75px; background: white; border-radius: 5px; animation: shuffleAnim 0.5s infinite alternate; }
.shuffle-card:nth-child(2) { animation-delay: 0.2s; } .shuffle-card:nth-child(3) { animation-delay: 0.4s; }
@keyframes shuffleAnim { from { transform: translateY(0); } to { transform: translateY(-20px); } }

#confetti-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 99; display: none; overflow: hidden; }
.confetti { position: absolute; top: -20px; width: 10px; height: 20px; animation: fall linear forwards; opacity: 0.9; border-radius: 2px; }
@keyframes fall { to { transform: translateY(110vh) rotate(720deg); } }

/* ===== åº•éƒ¨æ§åˆ¶é¢æ¿ ===== */
.controls { position: fixed; bottom: 0; width: 100%; background: rgba(6, 61, 37, 0.95); padding: 12px 0; box-shadow: 0 -4px 10px rgba(0,0,0,0.4); z-index: 50; }
button { padding: 10px 25px; margin: 0 10px; font-size: 16px; font-weight: bold; border-radius: 20px; border: none; cursor: pointer; transition: 0.2s; }
.btn-play { background: #ffc300; color: #333; } .btn-pass { background: #e0e0e0; color: #333; }
.copyright { font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 15px; padding-bottom: 80px; }

/* ===== Modal å°è©±æ¡† ===== */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: none; justify-content: center; align-items: center; z-index: 100; }
.modal-content { background: #fff; color: #333; padding: 25px; border-radius: 15px; width: 85%; max-width: 400px; text-align: center; }
.rules-text { text-align: left; font-size: 14px; line-height: 1.6; max-height: 60vh; overflow-y: auto; padding: 10px; background: #f1f1f1; border-radius: 8px; margin-bottom: 15px; }
.btn-restart { background: #0f5132; color: white; width: 100%; padding: 12px; margin-bottom: 10px; }
.btn-close { background: #555; color: white; width: 100%; padding: 10px; }
</style>
</head>
<body>

<div id="shuffleOverlay">
    <div class="shuffle-cards">
        <div class="shuffle-card back"></div>
        <div class="shuffle-card back"></div>
        <div class="shuffle-card back"></div>
    </div>
    <h3 style="color: #ffc300;">æ´—ç‰Œèˆ‡ç™¼ç‰Œä¸­...</h3>
</div>

<div id="confetti-container"></div>

<div class="top-panel" id="scoreboard">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <span class="scoreboard-title">ğŸ† ç´¯è¨ˆç©åˆ†æ¿ (å…ˆé” 100 åˆ†è€…å¥ªå† )</span>
        <div>
            <button class="btn-small" onclick="document.getElementById('rulesModal').style.display='flex'">ğŸ“– å°ç£ç©æ³•è¦å‰‡</button>
            <select id="diffSelect" class="btn-small" onchange="changeDifficulty(this.value)">
                <option value="easy">ğŸŒŸ ç°¡å–®</option>
                <option value="hard" selected>ğŸ”¥ å›°é›£</option>
            </select>
        </div>
    </div>
    <div id="scoreDisplay"></div>
</div>

<h2>ğŸ‚¡ BIG2å¤§è€äºŒå°ç£å–®æ©Ÿç«¶æŠ€ç‰ˆ ğŸ‚¡</h2>
<div id="info">æº–å‚™ç™¼ç‰Œ...</div>

<div id="opponentsHUD" class="opponents-hud"></div>
<div id="table"></div>
<div id="player" class="hand"></div>

<div class="copyright">&copy; 2026 LinWei's Big2 Taiwan Rules</div>

<div class="controls">
    <button class="btn-play" onclick="play()">å‡ºç‰Œ</button>
    <button class="btn-pass" onclick="pass()">Pass</button>
</div>

<div id="rulesModal" class="modal-overlay">
    <div class="modal-content">
        <h2>ğŸ“œ å°ç£ç©æ³•è¦å‰‡</h2>
        <div class="rules-text">
            1. æœ€å°å¼µç‰Œç‚º <b>æ¢…èŠ±3</b>ã€‚<br>
            2. åŒèŠ±è‰²å¤§å°ï¼š<b>é»‘æ¡ƒ > ç´…å¿ƒ > æ–¹å¡Š > æ¢…èŠ±</b>ã€‚<br>
            3. å¯å‡ºçµ„åˆï¼šå–®å¼µã€ä¸€å°ã€ä¸‰æ¢ã€é †å­ã€è‘«è˜†ã€éµæ”¯ã€åŒèŠ±é †ã€ä¸€æ¢é¾ã€‚<br>
            4. <b>ä¸å¯å‡ºåŒèŠ±</b>ã€‚<br>
            5. å‡ºä¸€å°æ™‚åªèƒ½å‡ºä¸€å°æ¥ï¼Œé †å­åªèƒ½æ¥é †å­ï¼Œè‘«è˜†æ¥è‘«è˜†ã€‚<br>
            6. é¦–å±€å‡ºç‰Œå¿…é ˆåŒ…å« <b>æ¢…èŠ±3</b>ã€‚<br>
            7. æ•¸å­—å„ªå…ˆæ–¼èŠ±è‰² (å¦‚ç´…å¿ƒ5 > é»‘æ¡ƒ4)ã€‚<br>
            8. <b>æ€ªç‰©ç‰Œç‰¹æ¬Š</b>ï¼šä¸è«–è©²è¼ªå‡ºä»€éº¼ï¼Œéƒ½å¯ä»¥å‡ºæ€ªç‰©ç‰Œå£“åˆ¶ã€‚<br>
            9. æ€ªç‰©ç‰Œå¤§å°ï¼š<b>ä¸€æ¢é¾ > åŒèŠ±é † > éµæ”¯</b>ã€‚
        </div>
        <button class="btn-close" onclick="document.getElementById('rulesModal').style.display='none'">æˆ‘çŸ¥é“äº†</button>
    </div>
</div>

<div id="scoreModal" class="modal-overlay">
    <div class="modal-content">
        <h2 id="modalTitle">éŠæˆ²çµæŸ</h2>
        <div id="modalScores" class="rules-text"></div>
        <button class="btn-restart" onclick="location.reload()">ç¹¼çºŒä¸‹ä¸€å±€</button>
        <button class="btn-close" onclick="resetScores()">æ¸…é™¤ç©åˆ†ä¸¦é‡æ–°é–‹å§‹</button>
    </div>
</div>

<script>
/* ===== ç³»çµ±ç‹€æ…‹èˆ‡éŸ³æ•ˆ ===== */
const sndPlayCard = new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'); 
const sndWin = new Audio('https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3');      
function playSound(snd) { snd.currentTime = 0; snd.play().catch(e => console.log(e)); }

const suits = ["â™£", "â™¦", "â™¥", "â™ "];
const suitValue = {"â™£":1, "â™¦":2, "â™¥":3, "â™ ":4};
const ranks = [3, 4, 5, 6, 7, 8, 9, 10, "J", "Q", "K", "A", 2];
const rankValue = {3:3, 4:4, 5:5, 6:6, 7:7, 8:8, 9:9, 10:10, J:11, Q:12, K:13, A:14, 2:15};

let deck = [], players = [[], [], [], []];
let current = 0, selected = [], last = null;
let consecutivePasses = 0, lastPlayer = -1, isFirstTurn = true;    

let aiDifficulty = localStorage.getItem("big2_diff") || "hard";
document.getElementById("diffSelect").value = aiDifficulty;
function changeDifficulty(val) { aiDifficulty = val; localStorage.setItem("big2_diff", val); }

let totalScores = JSON.parse(localStorage.getItem("big2_scores")) || [0, 0, 0, 0];

function renderScoreboard() {
    let display = document.getElementById("scoreDisplay"); let html = "";
    for(let i=0; i<4; i++){
        let colorClass = totalScores[i] >= 0 ? 'score-positive' : 'score-negative';
        html += `<div>${i===0?"ä½ ":`é›»è…¦${i}`}: <span class="${colorClass}">${totalScores[i]>0?"+":""}${totalScores[i]}</span></div>`;
    }
    display.innerHTML = html;
}

function renderOpponents() {
    let hud = document.getElementById("opponentsHUD"); let html = "";
    for (let i = 1; i <= 3; i++) {
        let count = players[i].length;
        html += `<div class="opp-box ${current===i?"active":""}"><div class="opp-name">é›»è…¦ ${i}</div><div class="opp-count ${count===1?"warning":""}">ğŸ‚  ${count}</div></div>`;
    }
    hud.innerHTML = html;
}

function createDeck(){ deck = []; for(let r of ranks) for(let s of suits) deck.push({rank: r, suit: s}); }
function shuffle(){ for (let i = deck.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [deck[i], deck[j]] = [deck[j], deck[i]]; } }
function deal(){ for(let i=0; i<52; i++) players[i%4].push(deck[i]); players.forEach(p => p.sort((a,b) => rankValue[a.rank] == rankValue[b.rank] ? suitValue[a.suit] - suitValue[b.suit] : rankValue[a.rank] - rankValue[b.rank])); }
function findStarter(){ for(let i=0; i<4; i++) if(players[i].some(c => c.rank == 3 && c.suit == "â™£")) current = i; }

function buildCardHTML(card){
    let color = (card.suit == "â™¥" || card.suit == "â™¦") ? "red" : "black";
    let center = (card.rank === "J" || card.rank === "Q" || card.rank === "K") ? `<div class="face-card-text">${card.rank}<span class="face-card-suit">${card.suit}</span></div>` : card.suit;
    return `<div class="corner top-left ${color}">${card.rank}${card.suit}</div><div class="watermark ${color}">${card.suit}</div><div class="center ${color}">${center}</div><div class="corner bottom-right ${color}">${card.rank}${card.suit}</div>`;
}

function renderPlayer(){
    let area = document.getElementById("player"); area.innerHTML = "";
    players[0].forEach((c, i) => {
        let div = document.createElement("div"); div.className = "card";
        if(selected.includes(i)) div.classList.add("selected");
        div.innerHTML = buildCardHTML(c); div.onclick = () => toggle(i); area.appendChild(div);
    });
}

function renderTable(cards){
    let t = document.getElementById("table"); t.innerHTML = "";
    cards.forEach((c, i) => {
        let div = document.createElement("div"); div.className = "card"; div.style.zIndex = i; div.style.margin = "0 -15px"; 
        div.innerHTML = buildCardHTML(c); t.appendChild(div);
    });
}

function toggle(i){ if(selected.includes(i)) selected = selected.filter(x => x != i); else selected.push(i); renderPlayer(); }
function updateInfo(msg){ document.getElementById("info").innerText = msg; }

/* ===== å°ç£è¦å‰‡ç‰Œå‹æ¼”ç®—æ³• ===== */
function getRankCounts(cards) { let counts = {}; cards.forEach(c => { counts[c.rank] = (counts[c.rank] || 0) + 1; }); return counts; }
function getPower(card){ return rankValue[card.rank] * 10 + suitValue[card.suit]; }
function sameRank(cards){ return cards.every(c => c.rank == cards[0].rank); }

function isStraight(cards) {
    let sorted = [...cards].sort((a,b) => rankValue[a.rank] - rankValue[b.rank]); let isNormal = true;
    for(let i = 1; i < 5; i++) if(rankValue[sorted[i].rank] !== rankValue[sorted[i-1].rank] + 1) { isNormal = false; break; }
    if (isNormal) return sorted[4];
    let ranks = sorted.map(c => c.rank);
    if (ranks.includes("A") && ranks.includes(2) && ranks.includes(3) && ranks.includes(4) && ranks.includes(5)) return cards.find(c => c.rank === 2); 
    return null;
}

function evaluate(cards){
    let sorted = [...cards].sort((a,b) => rankValue[a.rank] - rankValue[b.rank]);
    // 13å¼µï¼šä¸€æ¢é¾ (æ€ªç‰©ç‰Œç­‰ç´š 3)
    if(cards.length === 13) {
        let isDragon = true;
        for(let i=0; i<13; i++) if(rankValue[sorted[i].rank] !== i+3) isDragon = false;
        if(isDragon) return { type: 13, monsterLevel: 3, value: 900000, name: "ä¸€æ¢é¾" };
    }
    // 1~3å¼µ
    if(cards.length == 1) return {type: 1, subType: "single", monsterLevel: 0, value: getPower(cards[0])};
    if(cards.length == 2 && sameRank(cards)) return {type: 2, subType: "pair", monsterLevel: 0, value: getPower(cards[1])}; // å–èŠ±è‰²å¤§çš„
    if(cards.length == 3 && sameRank(cards)) return {type: 3, subType: "three", monsterLevel: 0, value: getPower(cards[0])};
    // 5å¼µçµ„åˆ
    if(cards.length == 5) {
        let counts = getRankCounts(cards), countVals = Object.values(counts);
        let straightMax = isStraight(cards);
        let isFlush = cards.every(c => c.suit === cards[0].suit);
        
        // åŒèŠ±é † (æ€ªç‰©ç‰Œç­‰ç´š 2)
        if (straightMax && isFlush) return { type: 5, subType: "straightflush", monsterLevel: 2, value: 80000 + getPower(straightMax), name: "åŒèŠ±é †" };
        // éµæ”¯ (æ€ªç‰©ç‰Œç­‰ç´š 1)
        if (countVals.includes(4)) {
            let fourRank = Object.keys(counts).find(k => counts[k] === 4);
            return { type: 5, subType: "four", monsterLevel: 1, value: 70000 + rankValue[fourRank] * 10, name: "éµæ”¯" };
        }
        // è‘«è˜†
        if (countVals.includes(3) && countVals.includes(2)) {
            let threeRank = Object.keys(counts).find(k => counts[k] === 3);
            return { type: 5, subType: "fullhouse", monsterLevel: 0, value: 30000 + rankValue[threeRank] * 10, name: "è‘«è˜†" };
        }
        // é †å­ (å°ç£è¦å‰‡ä¸å…è¨±ç´”åŒèŠ±)
        if (straightMax) return { type: 5, subType: "straight", monsterLevel: 0, value: 10000 + getPower(straightMax), name: "é †å­" };
    } 
    return null;
}
function getCombinations(array, size) { let result = []; function p(t, i) { if (t.length === size) { result.push(t); return; } if (i + 1 > array.length) return; p(t.concat(array[i]), i + 1); p(t, i + 1); } p([], 0); return result; }

/* ===== æ™ºèƒ½ AI èˆ‡å‡ºç‰Œé©—è­‰ ===== */
// åˆ¤å®š Bç‰Œå‹ æ˜¯å¦å¯ä»¥åˆæ³•å£“é Aç‰Œå‹ (last)
function canBeat(playEval, lastEval) {
    if (!lastEval) return true;
    // æ€ªç‰©ç‰Œç‰¹æ¬Šæ©Ÿåˆ¶ï¼šåªè¦æ€ªç‰©ç­‰ç´šæ¯”ç•¶å‰ç›¤é¢é«˜ï¼Œç„¡è¦–å¼µæ•¸èˆ‡ç‰Œå‹ç›´æ¥å£“åˆ¶
    if (playEval.monsterLevel > 0 && playEval.monsterLevel > lastEval.monsterLevel) return true;
    // æ­£å¸¸å‡ºç‰Œï¼šå¼µæ•¸(type)èˆ‡å­ç‰Œå‹(subType)å¿…é ˆå®Œå…¨ç›¸åŒï¼Œä¸”æ•¸å€¼æ›´å¤§
    if (playEval.type === lastEval.type && playEval.subType === lastEval.subType && playEval.value > lastEval.value) return true;
    return false;
}

function executePlay(cards, r, isPlayer) {
    playSound(sndPlayCard); players[current] = players[current].filter(c => !cards.includes(c)); last = r; lastPlayer = current; consecutivePasses = 0; 
    updateInfo(`ç©å®¶ ${current} å‡ºäº† ${last.name || (last.type + " å¼µç‰Œ")}`); renderTable(cards); renderOpponents(); 
    
    // è§¸ç™¼æ€ªç‰©ç‰Œéœ‡å‹•ç‰¹æ•ˆ
    if(r.monsterLevel > 0) {
        document.body.classList.remove("shake-screen");
        void document.body.offsetWidth; // è§¸ç™¼é‡ç¹ª
        document.body.classList.add("shake-screen");
    }

    if (isPlayer) { selected = []; renderPlayer(); } next();
}

function aiPlay(){
    let hand = players[current]; if(hand.length == 0) return; let chosenCards = null;
    let allPlays = []; 
    // AI çµ„åˆç”¢ç”Ÿ
    allPlays.push(...hand.map(c => [c])); 
    allPlays.push(...getCombinations(hand, 2).filter(c => evaluate(c)?.type === 2)); 
    allPlays.push(...getCombinations(hand, 3).filter(c => evaluate(c)?.type === 3)); 
    if (hand.length >= 5) {
        let fives = getCombinations(hand, 5).filter(c => evaluate(c) !== null);
        allPlays.push(...fives);
    }
    
    if(last == null){
        if (isFirstTurn) { allPlays = allPlays.filter(play => play.some(c => c.rank == 3 && c.suit == "â™£")); isFirstTurn = false; }
        allPlays.sort((a, b) => evaluate(a).value - evaluate(b).value); // ç°¡å–®æ‰“å‡ºæœ€å°ç‰Œ
        if(allPlays.length > 0) chosenCards = allPlays[0];
    } else {
        let validPlays = allPlays.filter(combo => {
            let evalC = evaluate(combo);
            return evalC && canBeat(evalC, last);
        });
        if (validPlays.length > 0) {
            validPlays.sort((a, b) => evaluate(a).value - evaluate(b).value);
            chosenCards = validPlays[0]; 
        }
    }
    if(chosenCards) executePlay(chosenCards, evaluate(chosenCards), false); else executePass();
}

function play(){
    if(current != 0) return; if(selected.length == 0) return; 
    let cards = selected.map(i => players[0][i]); let r = evaluate(cards);
    if(!r){ updateInfo("âš ï¸ é•åå°ç£è¦å‰‡ï¼šç„¡æ•ˆç‰Œå‹æˆ–ä¸å…è¨±å‡ºç´”åŒèŠ±ï¼"); return; }
    if(last == null){ 
        if(isFirstTurn && !cards.some(c => c.rank == 3 && c.suit == "â™£")){ updateInfo("âš ï¸ é¦–å±€å¿…é ˆåŒ…å«æ¢…èŠ± 3ï¼"); return; } 
        isFirstTurn = false; 
    } else { 
        if(!canBeat(r, last)){ updateInfo("âš ï¸ ç‰Œå‹ä¸ç¬¦æˆ–é»æ•¸å¤ªå°ï¼(æç¤º: é †åªèƒ½æ¥é †ï¼Œè‘«è˜†æ¥è‘«è˜†)"); return; } 
    }
    executePlay(cards, r, true);
}

function pass(){ if(current != 0) return; if(last == null){ updateInfo("âš ï¸ æ“æœ‰ç‰Œæ¬Šæ™‚ä¸èƒ½ Passï¼"); return; } selected = []; renderPlayer(); executePass(); }
function executePass(){
    consecutivePasses++; updateInfo(`ç©å®¶ ${current} é¸æ“‡ Pass`);
    if(consecutivePasses >= 3){ last = null; consecutivePasses = 0; current = lastPlayer; renderTable([]); updateInfo(`ğŸ”„ ç‰Œæ¬Šå›åˆ° ç©å®¶ ${current}`); renderOpponents(); if(current === 0) updateInfo("âœ¨ é‡æ–°ç²å¾—ç‰Œæ¬Šï¼Œè«‹è‡ªç”±å‡ºç‰Œ"); else setTimeout(()=>{ aiPlay(); }, 1200); } 
    else { current = (current + 1) % 4; renderOpponents(); if(current != 0) setTimeout(()=>{ aiPlay(); }, 1200); }
}

/* ===== æ»¿åˆ†æ…¶ç¥ç‰¹æ•ˆ ===== */
function shootConfetti() {
    const container = document.getElementById('confetti-container');
    container.style.display = 'block';
    const colors = ['#ffc300', '#d90429', '#4ade80', '#3b82f6', '#a855f7', '#ff007f'];
    for (let i = 0; i < 200; i++) {
        let conf = document.createElement('div');
        conf.className = 'confetti';
        conf.style.left = Math.random() * 100 + 'vw';
        conf.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        conf.style.animationDuration = (Math.random() * 3 + 2) + 's';
        conf.style.animationDelay = (Math.random() * 1.5) + 's';
        container.appendChild(conf);
    }
}

/* ===== çµç®—æ©Ÿåˆ¶ ===== */
function showScoreModal(winnerIndex) {
    let roundScores = [0, 0, 0, 0]; let winnerEarnings = 0;
    for (let i = 0; i < 4; i++) {
        if (i !== winnerIndex) {
            let remain = players[i].length; let penalty = remain;
            if (remain === 13) penalty *= 3; else if (remain >= 10) penalty *= 2;
            roundScores[i] -= penalty; winnerEarnings += penalty; 
        }
    }
    roundScores[winnerIndex] += winnerEarnings;
    
    let hasUltimate = false;
    for (let i = 0; i < 4; i++) { 
        totalScores[i] += roundScores[i]; 
        if (totalScores[i] >= 100) hasUltimate = true;
    }
    localStorage.setItem("big2_scores", JSON.stringify(totalScores));

    if (hasUltimate) shootConfetti();
    document.getElementById("modalTitle").innerHTML = hasUltimate ? `ğŸ‘‘ ç¸½å† è»èª•ç”Ÿï¼` : (winnerIndex === 0 ? `ğŸ† ä½ è´äº†ï¼(+${winnerEarnings})` : `ğŸ˜¢ é›»è…¦ ${winnerIndex} ç²å‹`);
    
    let scoresHtml = "";
    for (let i = 0; i < 4; i++) scoresHtml += `<div style="padding:5px">â¤ ${i===0?"ä½ ":`é›»è…¦${i}`}ï¼š${i===winnerIndex?"è´å®¶":`å‰© ${players[i].length} å¼µ`} <span style="float:right">${roundScores[i]} (ç¸½åˆ†: ${totalScores[i]})</span></div>`;
    
    document.getElementById("modalScores").innerHTML = scoresHtml; 
    document.getElementById("scoreModal").style.display = "flex";
}

function resetScores() { localStorage.removeItem("big2_scores"); location.reload(); }
function next(){ if(players[current].length === 0){ setTimeout(() => { showScoreModal(current); }, 500); return; } current = (current + 1) % 4; renderOpponents(); if(current != 0) setTimeout(()=>{ aiPlay(); }, 1200); }

/* ===== åˆå§‹åŒ– ===== */
function init(){
    renderScoreboard(); createDeck(); shuffle(); deal(); findStarter(); renderPlayer(); renderOpponents();
    // æ´—ç‰Œéå ´å‹•ç•«æ§åˆ¶
    setTimeout(() => {
        document.getElementById("shuffleOverlay").style.display = "none";
        isFirstTurn = true; lastPlayer = current; updateInfo(`âœ¨ éŠæˆ²é–‹å§‹ï¼ç”± ç©å®¶ ${current} å…ˆå‡ºç‰Œ`);
        if(current !== 0) setTimeout(()=>{ aiPlay(); }, 1500);
    }, 2000);
}
init();
</script>
</body>
</html>