<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬èˆ˜ç›´æ’­ - å…¨çƒé€£ç·šPROç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-deep: #0a0a0f;
            --cyber-cyan: #00f2ff;
            --cyber-purple: #bc13fe;
            --neon-red: #ff0055;
            --text-main: #e0e0e0;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --gold: #ffd700;
            --success-green: #00ff88;
            --signal-excellent: #00ff88;
            --signal-good: #ffd700;
            --signal-poor: #ff6b00;
            --signal-bad: #ff0055;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-deep);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 242, 255, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(188, 19, 254, 0.05) 0%, transparent 20%);
            color: var(--text-main);
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        header { 
            width: 100%; 
            padding: 15px; 
            text-align: center; 
            border-bottom: 1px solid var(--glass-border);
            background: rgba(10, 10, 15, 0.8);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .live-tag { 
            color: var(--neon-red); 
            font-weight: bold; 
            font-size: 0.8rem; 
            letter-spacing: 2px; 
            text-shadow: 0 0 10px rgba(255, 0, 85, 0.5);
            animation: pulse 2s infinite; 
            margin-bottom: 5px;
            display: inline-block;
        }
        @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }

        h1 {
            margin: 0;
            letter-spacing: 2px;
            font-size: 1.5rem;
        }

        .tabs { 
            display: flex; 
            gap: 10px; 
            margin: 15px 0; 
            background: var(--glass); 
            padding: 5px; 
            border-radius: 12px; 
            border: 1px solid var(--glass-border);
        }
        .tab-btn { 
            background: none; 
            border: none; 
            color: var(--text-main); 
            padding: 8px 20px; 
            cursor: pointer; 
            border-radius: 8px; 
            transition: 0.3s; 
            font-size: 0.95rem;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.05); }
        .tab-btn.active { 
            background: var(--cyber-cyan); 
            color: var(--bg-deep); 
            font-weight: bold; 
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.3);
        }

        /* èª¿æ•´ä¸»å®¹å™¨å¯¬åº¦é…ç½® */
        .main-container { 
            width: 99%; 
            max-width: 100%; 
            display: grid; 
            grid-template-columns: 1fr 350px; 
            gap: 15px; 
            padding: 0 10px 20px 10px;
            flex: 1;
        }
        @media (max-width: 900px) { 
            .main-container { 
                grid-template-columns: 1fr; 
            } 
        }

        /* è¦–è¨Šå®¹å™¨ */
        .video-box { 
            background: #000; 
            border-radius: 20px; 
            position: relative; 
            border: 1px solid var(--glass-border); 
            overflow: visible; 
            aspect-ratio: 16/9;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            transition: border-color 0.3s;
            width: 100%; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .video-box.active { 
            border-color: var(--cyber-cyan); 
            box-shadow: 0 0 20px rgba(0,242,255,0.1); 
        }
        
        /* å…¨è¢å¹•æ¨¡å¼æ¨£å¼ */
        .video-box:fullscreen {
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .video-box:-webkit-full-screen {
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .video-box:-moz-full-screen {
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        video { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            background: #111; 
            border-radius: 20px;
        }
        
        .video-box:fullscreen video,
        .video-box:-webkit-full-screen video,
        .video-box:-moz-full-screen video {
            border-radius: 0;
        }
        
        /* é ‚éƒ¨è³‡è¨Šåˆ— */
        .top-bar {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 30;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .status-bar { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            background: rgba(0,0,0,0.8); 
            backdrop-filter: blur(8px);
            padding: 8px 16px; 
            border-radius: 50px; 
            font-size: 0.9rem; 
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .viewer-count {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.9rem;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            color: var(--cyber-cyan);
            font-weight: bold;
        }
        
        .viewer-count .icon {
            font-size: 1.1rem;
        }
        
        /* é€£ç·šå“è³ªæŒ‡ç¤ºå™¨ */
        .connection-quality {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.85rem;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .signal-icon {
            font-size: 1.1rem;
        }
        
        .quality-text {
            font-weight: bold;
        }
        
        .quality-excellent { color: var(--signal-excellent); }
        .quality-good { color: var(--signal-good); }
        .quality-poor { color: var(--signal-poor); }
        .quality-bad { color: var(--signal-bad); }
        
        .quality-details {
            font-size: 0.75rem;
            color: #999;
            margin-left: 4px;
        }
        
        .dot { 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            background: #666; 
            transition: 0.3s; 
        }
        .dot.live { 
            background: var(--cyber-cyan); 
            box-shadow: 0 0 10px var(--cyber-cyan); 
        }
        .dot.rec { 
            background: var(--neon-red); 
            animation: pulse 1s infinite; 
        }

        /* åº•éƒ¨æ§åˆ¶åˆ— */
        .bottom-controls {
            position: absolute;
            bottom: 15px;
            left: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
            z-index: 30;
            justify-content: flex-end;
        }
        
        .control-btn {
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .control-btn:hover {
            background: rgba(0,242,255,0.3);
            border-color: var(--cyber-cyan);
            transform: scale(1.1);
        }
        
        .control-btn:active {
            transform: scale(0.95);
        }

        /* æ’­æ”¾æŒ‰éˆ•é®ç½© */
        .play-overlay {
            position: absolute;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 35;
            cursor: pointer;
            backdrop-filter: blur(2px);
            border-radius: 20px;
        }
        .play-icon {
            font-size: 3rem;
            color: var(--cyber-cyan);
            background: rgba(255,255,255,0.1);
            width: 80px; 
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--cyber-cyan);
            box-shadow: 0 0 20px rgba(0,242,255,0.3);
            transition: 0.3s;
        }
        .play-overlay:hover .play-icon { 
            transform: scale(1.1); 
            background: rgba(0,242,255,0.2); 
        }

        /* ç›´æ’­é å‘Šé®ç½© */
        .countdown-overlay {
            position: absolute;
            top: 0; left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 40;
            backdrop-filter: blur(5px);
            border-radius: 20px;
            pointer-events: none;
        }
        
        .countdown-title {
            font-size: 1.5rem;
            color: var(--cyber-cyan);
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(0,242,255,0.5);
        }
        
        .countdown-timer {
            font-size: 3rem;
            font-weight: bold;
            color: var(--gold);
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 20px rgba(255,215,0,0.5);
            margin-bottom: 20px;
        }
        
        .countdown-message {
            font-size: 1rem;
            color: #999;
        }

        .panel { 
            background: var(--glass); 
            backdrop-filter: blur(15px); 
            padding: 20px; 
            border-radius: 20px; 
            border: 1px solid var(--glass-border); 
            margin-bottom: 15px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        
        .panel::-webkit-scrollbar {
            width: 8px;
        }
        .panel::-webkit-scrollbar-thumb {
            background: var(--glass-border);
            border-radius: 4px;
        }
        .panel::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.2);
        }
        
        h3 { 
            margin-top: 0; 
            color: var(--cyber-cyan); 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            padding-bottom: 10px; 
            font-size: 1.1rem; 
        }

        .input-group { margin-bottom: 15px; }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #999;
        }
        
        /* å¯è¤‡è£½çš„IDè¼¸å…¥æ¡†æ¨£å¼ */
        .id-input-wrapper {
            position: relative;
        }
        
        .input-style { 
            background: rgba(0,0,0,0.3); 
            border: 1px solid var(--glass-border); 
            padding: 10px; 
            border-radius: 8px; 
            color: #fff; 
            width: 100%; 
            font-size: 0.95rem;
            transition: 0.3s;
        }
        
        .input-style.clickable {
            cursor: pointer;
            padding-right: 40px;
        }
        
        .input-style.clickable:hover {
            background: rgba(0,0,0,0.5);
            border-color: var(--cyber-cyan);
        }
        
        .input-style:focus { 
            outline: none; 
            border-color: var(--cyber-cyan); 
            background: rgba(0,0,0,0.5); 
        }
        
        /* è¤‡è£½åœ–ç¤º */
        .copy-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--cyber-cyan);
            font-size: 1.2rem;
            pointer-events: none;
            opacity: 0.7;
            transition: 0.3s;
        }
        
        .input-style.clickable:hover + .copy-icon {
            opacity: 1;
            transform: translateY(-50%) scale(1.1);
        }
        
        /* è¤‡è£½æˆåŠŸæç¤º */
        .copy-tooltip {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background: var(--success-green);
            color: var(--bg-deep);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: bold;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0, 255, 136, 0.3);
        }
        
        .copy-tooltip.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .copy-tooltip::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid var(--success-green);
        }
        
        /* ç•«è³ªé¸æ“‡å™¨æ¨£å¼ */
        .quality-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .quality-btn {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            padding: 10px 5px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: 0.3s;
            text-align: center;
        }
        
        .quality-btn:hover {
            background: rgba(255,255,255,0.05);
            border-color: var(--cyber-cyan);
        }
        
        .quality-btn.active {
            background: var(--cyber-cyan);
            color: var(--bg-deep);
            font-weight: bold;
            border-color: var(--cyber-cyan);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.3);
        }

        /* è§€çœ¾åå–®æ¨£å¼ */
        .viewer-list {
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .viewer-list::-webkit-scrollbar {
            width: 6px;
        }
        .viewer-list::-webkit-scrollbar-thumb {
            background: var(--glass-border);
            border-radius: 3px;
        }
        
        .viewer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            margin-bottom: 5px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            transition: 0.3s;
        }
        
        .viewer-item:hover {
            background: rgba(0,242,255,0.1);
            border-color: var(--cyber-cyan);
        }
        
        .viewer-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        
        .viewer-icon {
            color: var(--cyber-cyan);
            font-size: 1rem;
        }
        
        .viewer-id {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #ccc;
        }
        
        .viewer-time {
            font-size: 0.75rem;
            color: #666;
            margin-left: auto;
            margin-right: 10px;
        }
        
        .kick-btn {
            background: rgba(255,0,85,0.2);
            border: 1px solid var(--neon-red);
            color: var(--neon-red);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .kick-btn:hover {
            background: var(--neon-red);
            color: white;
        }
        
        .viewer-list-empty {
            text-align: center;
            color: #666;
            padding: 20px;
            font-size: 0.9rem;
        }

        .action-btn { 
            background: linear-gradient(135deg, var(--cyber-cyan), var(--cyber-purple)); 
            border: none; 
            padding: 12px; 
            border-radius: 8px; 
            color: white; 
            width: 100%; 
            font-weight: bold; 
            font-size: 0.95rem;
            cursor: pointer; 
            margin-top: 5px; 
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .action-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(188, 19, 254, 0.3); 
        }
        .action-btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none; 
            filter: grayscale(1); 
        }
        .action-btn.secondary { 
            background: transparent; 
            border: 1px solid var(--glass-border); 
        }
        .action-btn.secondary:hover { 
            background: rgba(255,255,255,0.05); 
            box-shadow: none; 
        }
        .action-btn.danger { 
            background: linear-gradient(135deg, #ff0055, #cc0044); 
        }
        .action-btn.small {
            padding: 8px;
            font-size: 0.85rem;
        }

        /* æ˜Ÿæ˜Ÿè©•åˆ†ç³»çµ±æ¨£å¼ */
        .score-display {
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--gold);
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            margin: 8px 0;
            font-family: 'Segoe UI', sans-serif;
        }
        .star-container {
            display: flex;
            justify-content: center;
            gap: 8px; 
            margin-bottom: 12px;
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 50px;
        }
        .star-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #444;
            transition: all 0.2s;
            padding: 0;
            line-height: 1;
        }
        .star-btn:hover {
            transform: scale(1.2);
        }

        .vote-feedback {
            text-align: center;
            font-size: 0.9rem;
            color: var(--cyber-cyan);
            min-height: 20px;
            margin-bottom: 8px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .vote-stats {
            background: rgba(0,0,0,0.2);
            padding: 12px;
            border-radius: 12px;
            margin-top: 10px;
            font-size: 0.85rem;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            padding: 4px 0;
        }
        .stat-label {
            color: #999;
        }
        .stat-value {
            color: var(--cyber-cyan);
            font-weight: bold;
            font-size: 1rem;
        }

        /* è¨Šæ¯è¨˜éŒ„å€ */
        .log-box {
            background: rgba(0,0,0,0.4);
            padding: 12px;
            border-radius: 8px;
            height: 150px;
            overflow-y: auto;
            font-size: 0.85rem;
            color: #aaa;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .log-box::-webkit-scrollbar {
            width: 6px;
        }
        .log-box::-webkit-scrollbar-thumb {
            background: var(--glass-border);
            border-radius: 3px;
        }

        /* Modal ç³»çµ±èªªæ˜ */
        .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            padding: 20px;
        }
        .modal-content {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }
        .modal-header {
            font-size: 1.5rem;
            color: var(--cyber-cyan);
            margin-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 10px;
        }
        .info-section {
            margin-bottom: 20px;
        }
        .info-section h4 {
            color: var(--cyber-purple);
            margin-bottom: 8px;
        }
        .info-section p {
            line-height: 1.6;
            color: #ccc;
        }

        /* æ™‚é–“é¸æ“‡å™¨æ¨£å¼ */
        .time-picker {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .time-input {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            color: #fff;
            padding: 8px;
            border-radius: 8px;
            font-size: 0.9rem;
            text-align: center;
        }
        
        .time-input:focus {
            outline: none;
            border-color: var(--cyber-cyan);
        }

        .hidden { display: none !important; }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            .video-box {
                aspect-ratio: 16/9;
            }
            .panel {
                max-height: none;
            }
        }

        /* ç¢ºä¿æ§åˆ¶é …åœ¨å°è¢å¹•ä¸Šä¹Ÿèƒ½é¡¯ç¤º */
        @media (max-width: 600px) {
            .top-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            .status-bar, .viewer-count, .connection-quality {
                font-size: 0.75rem;
                padding: 6px 12px;
            }
            .control-btn {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
            }
            .star-btn {
                font-size: 1.5rem;
            }
            .score-display {
                font-size: 2rem;
            }
            .countdown-timer {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="live-tag">â— LIVE BROADCAST</div>
        <h1>ğŸŒ å…¬èˆ˜ç›´æ’­ - å…¨çƒé€£ç·š PRO ç‰ˆ</h1>
        <div class="tabs">
            <button class="tab-btn active" id="tab-h" onclick="switchTab('host')">ğŸ“¡ å°æ’­å°</button>
            <button class="tab-btn" id="tab-g" onclick="switchTab('guest')">ğŸ“º è§€çœ¾ç«¯</button>
        </div>
    </header>

    <div class="main-container">
        <!-- å·¦å´è¦–è¨Šå€ -->
        <div>
            <div class="video-box" id="videoContainer">
                <video id="vDisplay" autoplay playsinline muted></video>
                
                <!-- é ‚éƒ¨è³‡è¨Šåˆ— -->
                <div class="top-bar">
                    <!-- ç‹€æ…‹åˆ— -->
                    <div class="status-bar">
                        <div class="dot" id="statusDot"></div>
                        <span id="statusText">ç³»çµ±å¾…å‘½ä¸­</span>
                    </div>
                    
                    <!-- è§€çœ¾äººæ•¸ -->
                    <div class="viewer-count" id="viewerCount">
                        <span class="icon">ğŸ‘¥</span>
                        <span id="viewerNumber">0</span>
                    </div>
                    
                    <!-- é€£ç·šå“è³ªæŒ‡ç¤ºå™¨ -->
                    <div class="connection-quality hidden" id="connectionQuality">
                        <span class="signal-icon" id="signalIcon">ğŸ“¶</span>
                        <span class="quality-text" id="qualityText">è‰¯å¥½</span>
                        <span class="quality-details" id="qualityDetails"></span>
                    </div>
                </div>

                <!-- åº•éƒ¨æ§åˆ¶åˆ— -->
                <div class="bottom-controls">
                    <button class="control-btn" id="fullscreenBtn" onclick="toggleFullscreen()" title="å…¨è¢å¹•">
                        â›¶
                    </button>
                </div>

                <!-- æ’­æ”¾æŒ‰éˆ•é®ç½© -->
                <div class="play-overlay hidden" id="playOverlay" onclick="forcePlay()">
                    <div class="play-icon">â–¶</div>
                    <p style="margin-top:15px; color: #ccc;">é»æ“Šæ’­æ”¾ç›´æ’­</p>
                </div>
                
                <!-- ç›´æ’­é å‘Šå€’æ•¸ -->
                <div class="countdown-overlay hidden" id="countdownOverlay">
                    <div class="countdown-title">ğŸ“… ç›´æ’­å³å°‡é–‹å§‹</div>
                    <div class="countdown-timer" id="countdownTimer">00:00:00</div>
                    <div class="countdown-message">æ•¬è«‹æœŸå¾…...</div>
                </div>
            </div>
        </div>

        <!-- å³å´æ§åˆ¶å€ -->
        <div>
            <!-- å°æ’­å°é¢æ¿ -->
            <div id="panelHost" class="panel">
                <h3>ğŸ“¡ å°æ’­æ§åˆ¶å°</h3>
                
                <div class="input-group">
                    <label>ğŸ†” ä½ çš„å°æ’­ ID <span style="color: var(--cyber-cyan); font-size: 0.8rem;">(é»æ“Šè¤‡è£½)</span>ï¼š</label>
                    <div class="id-input-wrapper">
                        <input type="text" id="myId" class="input-style clickable" readonly placeholder="å•Ÿå‹•æ”å½±æ©Ÿå¾Œé¡¯ç¤º" onclick="copyToClipboard(this.value)">
                        <span class="copy-icon">ğŸ“‹</span>
                        <div class="copy-tooltip" id="copyTooltip">âœ“ å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿</div>
                    </div>
                </div>

                <div class="input-group">
                    <label>ğŸ“¹ ç•«è³ªé¸æ“‡ï¼š</label>
                    <div class="quality-selector">
                        <button class="quality-btn" onclick="setQuality('low', event)">æ¨™æº–<br>480p</button>
                        <button class="quality-btn active" onclick="setQuality('medium', event)">é«˜æ¸…<br>720p</button>
                        <button class="quality-btn" onclick="setQuality('high', event)">è¶…æ¸…<br>1080p</button>
                    </div>
                </div>

                <button class="action-btn" onclick="startCamera()">1. å•Ÿå‹•æ”å½±æ©Ÿ</button>
                <button class="action-btn danger" id="recBtn" onclick="toggleRecording()" disabled>2. é–‹å§‹éŒ„å½±</button>
                <span id="recTimer" style="display:none; color: var(--neon-red); font-weight: bold; margin-left: 10px;"></span>

                <!-- ç›´æ’­é å‘Šè¨­å®š -->
                <div style="margin-top: 20px;">
                    <h3>ğŸ“… ç›´æ’­é å‘Šè¨­å®š</h3>
                    <div class="input-group">
                        <label>è¨­å®šé–‹æ’­æ™‚é–“ï¼š</label>
                        <div class="time-picker">
                            <input type="number" id="scheduleHours" class="time-input" placeholder="æ™‚" min="0" max="23" value="0">
                            <input type="number" id="scheduleMinutes" class="time-input" placeholder="åˆ†" min="0" max="59" value="0">
                            <input type="number" id="scheduleSeconds" class="time-input" placeholder="ç§’" min="0" max="59" value="0">
                        </div>
                        <button class="action-btn secondary small" onclick="setSchedule()">è¨­å®šå€’æ•¸è¨ˆæ™‚</button>
                        <button class="action-btn secondary small" id="cancelScheduleBtn" onclick="cancelSchedule()" style="display:none;">å–æ¶ˆå€’æ•¸</button>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <h3>ğŸ‘¥ è§€çœ¾ç®¡ç†</h3>
                    <div class="vote-stats">
                        <div class="stat-row">
                            <span class="stat-label">ç·šä¸Šè§€çœ¾</span>
                            <span class="stat-value" id="hostViewerCount">0</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 10px;">
                        <div class="viewer-list" id="viewerList">
                            <div class="viewer-list-empty">å°šç„¡è§€çœ¾é€£ç·š</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <h3>ğŸ“Š å³æ™‚è©•åˆ†çµ±è¨ˆ</h3>
                    <div class="score-display" id="avgScore">0.0</div>
                    <div class="vote-stats">
                        <div class="stat-row">
                            <span class="stat-label">ç¸½ç¥¨æ•¸</span>
                            <span class="stat-value" id="totalVotes">0</span>
                        </div>
                    </div>
                    
                    <!-- æ˜Ÿæ˜Ÿè©•åˆ†å€ (å°æ’­ä¹Ÿå¯æ¸¬è©¦æŠ•ç¥¨) -->
                    <div class="vote-feedback" id="vote-feedback"></div>
                    <div class="star-container">
                        <button class="star-btn" onmouseover="highlightStars(1)" onmouseout="resetStars()" onclick="vote(1)">â˜…</button>
                        <button class="star-btn" onmouseover="highlightStars(2)" onmouseout="resetStars()" onclick="vote(2)">â˜…</button>
                        <button class="star-btn" onmouseover="highlightStars(3)" onmouseout="resetStars()" onclick="vote(3)">â˜…</button>
                        <button class="star-btn" onmouseover="highlightStars(4)" onmouseout="resetStars()" onclick="vote(4)">â˜…</button>
                        <button class="star-btn" onmouseover="highlightStars(5)" onmouseout="resetStars()" onclick="vote(5)">â˜…</button>
                    </div>
                    <button class="action-btn secondary" onclick="resetVote()">æ¸…é™¤çµ±è¨ˆæ•¸æ“š</button>
                </div>

                <div style="margin-top: 20px;">
                    <h3>ğŸ“ ç³»çµ±è¨˜éŒ„</h3>
                    <div class="log-box" id="logs"></div>
                </div>

                <button class="action-btn secondary" style="margin-top: 15px;" onclick="showInfo()">â„¹ï¸ ä½¿ç”¨èªªæ˜</button>
            </div>

            <!-- è§€çœ¾ç«¯é¢æ¿ -->
            <div id="panelGuest" class="panel hidden">
                <h3>ğŸ“º è§€çœ¾é€£ç·š</h3>
                
                <div class="input-group">
                    <label>ğŸ†” å°æ’­ IDï¼š</label>
                    <input type="text" id="targetId" class="input-style" placeholder="è¼¸å…¥å°æ’­çµ¦ä½ çš„ ID">
                </div>

                <button class="action-btn" onclick="connectToHost()">ğŸš€ è«‹æ±‚é€£ç·š</button>

                <div style="margin-top: 20px;">
                    <h3>ğŸ‘¥ ç›´æ’­è³‡è¨Š</h3>
                    <div class="vote-stats">
                        <div class="stat-row">
                            <span class="stat-label">ç·šä¸Šè§€çœ¾</span>
                            <span class="stat-value" id="guestViewerCount">0</span>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <h3>â­ çµ¦ä¸»æ’­è©•åˆ†</h3>
                    <p style="font-size: 0.9rem; color: #999; margin-bottom: 10px;">æ»‘å‹•çœ‹æ˜Ÿæ˜Ÿç­‰ç´šï¼Œé»æ“Šé€å‡ºè©•åƒ¹ï¼</p>
                    
                    <div class="vote-feedback" id="vote-feedback"></div>
                    <div class="star-container">
                        <button class="star-btn" onmouseover="highlightStars(1)" onmouseout="resetStars()" onclick="vote(1)">â˜…</button>
                        <button class="star-btn" onmouseover="highlightStars(2)" onmouseout="resetStars()" onclick="vote(2)">â˜…</button>
                        <button class="star-btn" onmouseover="highlightStars(3)" onmouseout="resetStars()" onclick="vote(3)">â˜…</button>
                        <button class="star-btn" onmouseover="highlightStars(4)" onmouseout="resetStars()" onclick="vote(4)">â˜…</button>
                        <button class="star-btn" onmouseover="highlightStars(5)" onmouseout="resetStars()" onclick="vote(5)">â˜…</button>
                    </div>
                    
                    <div class="vote-stats">
                        <div class="stat-row">
                            <span class="stat-label">ç›®å‰å¹³å‡</span>
                            <span class="stat-value" id="avgScore">0.0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">ç¸½è©•åƒ¹æ•¸</span>
                            <span class="stat-value" id="totalVotes">0</span>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <h3>ğŸ“ ç³»çµ±è¨˜éŒ„</h3>
                    <div class="log-box" id="logs"></div>
                </div>

                <button class="action-btn secondary" style="margin-top: 15px;" onclick="showInfo()">â„¹ï¸ ä½¿ç”¨èªªæ˜</button>
            </div>
        </div>
    </div>

    <!-- Modal ä½¿ç”¨èªªæ˜ -->
    <div class="modal hidden" id="infoModal" onclick="closeInfo()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">ğŸ“– ç³»çµ±ä½¿ç”¨èªªæ˜</div>
            
            <div class="info-section">
                <h4>ğŸ¬ å°æ’­ç«¯æ“ä½œ</h4>
                <p>1. é¸æ“‡ç•«è³ªï¼ˆæ¨™æº–/é«˜æ¸…/è¶…æ¸…ï¼‰<br>
                2. é»æ“Šã€Œå•Ÿå‹•æ”å½±æ©Ÿã€é–‹å§‹ç›´æ’­<br>
                3. é»æ“Šå°æ’­ ID å³å¯è‡ªå‹•è¤‡è£½<br>
                4. å°‡ ID åˆ†äº«çµ¦è§€çœ¾<br>
                5. ç•¶è§€çœ¾è«‹æ±‚é€£ç·šæ™‚æœƒè·³å‡ºç¢ºèªè¦–çª—<br>
                6. å¯é¸æ“‡ã€Œé–‹å§‹éŒ„å½±ã€ä¿å­˜ç›´æ’­å…§å®¹<br>
                7. å³æ™‚æŸ¥çœ‹ç·šä¸Šäººæ•¸å’Œè©•åˆ†çµ±è¨ˆ<br>
                8. åœ¨è§€çœ¾åå–®ä¸­ç®¡ç†é€£ç·šè§€çœ¾<br>
                9. é»æ“Šå…¨è¢å¹•æŒ‰éˆ•é€²å…¥æ²‰æµ¸æ¨¡å¼</p>
            </div>

            <div class="info-section">
                <h4>ğŸ‘€ è§€çœ¾ç«¯æ“ä½œ</h4>
                <p>1. è¼¸å…¥å°æ’­æä¾›çš„ ID<br>
                2. é»æ“Šã€Œè«‹æ±‚é€£ç·šã€ç­‰å¾…å°æ’­åŒæ„<br>
                3. é€£ç·šæˆåŠŸå¾Œå³å¯è§€çœ‹ç›´æ’­<br>
                4. æŸ¥çœ‹ç·šä¸Šè§€çœ¾äººæ•¸å’Œé€£ç·šå“è³ª<br>
                5. éš¨æ™‚çµ¦ä¸»æ’­è©•åˆ†å›é¥‹<br>
                6. ä½¿ç”¨å…¨è¢å¹•æŒ‰éˆ•ç²å¾—æœ€ä½³è§€çœ‹é«”é©—</p>
            </div>

            <div class="info-section">
                <h4>ğŸ“… ç›´æ’­é å‘ŠåŠŸèƒ½</h4>
                <p>å°æ’­å¯ä»¥è¨­å®šå€’æ•¸è¨ˆæ™‚ï¼š<br>
                â€¢ è¼¸å…¥æ™‚ã€åˆ†ã€ç§’è¨­å®šé–‹æ’­æ™‚é–“<br>
                â€¢ é»æ“Šã€Œè¨­å®šå€’æ•¸è¨ˆæ™‚ã€å•Ÿå‹•<br>
                â€¢ å€’æ•¸æœŸé–“è§€çœ¾æœƒçœ‹åˆ°é å‘Šç•«é¢<br>
                â€¢ å€’æ•¸çµæŸå¾Œè‡ªå‹•é–‹å§‹ç›´æ’­<br>
                â€¢ å¯éš¨æ™‚é»æ“Šã€Œå–æ¶ˆå€’æ•¸ã€æå‰é–‹æ’­</p>
            </div>

            <div class="info-section">
                <h4>ğŸ“¹ ç•«è³ªèªªæ˜</h4>
                <p>â€¢ <strong>æ¨™æº– 480p</strong> - é©åˆç¶²è·¯è¼ƒæ…¢æ™‚ä½¿ç”¨<br>
                â€¢ <strong>é«˜æ¸… 720p</strong> - æ¨è–¦ä½¿ç”¨ï¼Œå¹³è¡¡ç•«è³ªèˆ‡æµæš¢åº¦<br>
                â€¢ <strong>è¶…æ¸… 1080p</strong> - æœ€ä½³ç•«è³ªï¼Œéœ€è¦è‰¯å¥½ç¶²è·¯ç’°å¢ƒ</p>
            </div>

            <div class="info-section">
                <h4>ğŸ“¶ é€£ç·šå“è³ªæŒ‡ç¤º</h4>
                <p>ç³»çµ±æœƒè‡ªå‹•åµæ¸¬é€£ç·šå“è³ªï¼š<br>
                â€¢ <span style="color: #00ff88;">â—</span> å„ªç•° - å»¶é² < 100ms<br>
                â€¢ <span style="color: #ffd700;">â—</span> è‰¯å¥½ - å»¶é² 100-200ms<br>
                â€¢ <span style="color: #ff6b00;">â—</span> æ™®é€š - å»¶é² 200-500ms<br>
                â€¢ <span style="color: #ff0055;">â—</span> ä¸ä½³ - å»¶é² > 500ms</p>
            </div>

            <div class="info-section">
                <h4>â­ è©•åˆ†ç³»çµ±</h4>
                <p>â˜…â˜†â˜†â˜†â˜† = åŠ æ²¹<br>
                â˜…â˜…â˜†â˜†â˜† = æ™®é€š<br>
                â˜…â˜…â˜…â˜†â˜† = é‚„è¡Œ<br>
                â˜…â˜…â˜…â˜…â˜† = ä¸éŒ¯<br>
                â˜…â˜…â˜…â˜…â˜… = è¶…è®šï¼</p>
            </div>

            <div class="info-section">
                <h4>ğŸ’¡ å¯¦ç”¨æŠ€å·§</h4>
                <p>â€¢ é»æ“Šå°æ’­ ID è¼¸å…¥æ¡†å³å¯å¿«é€Ÿè¤‡è£½<br>
                â€¢ ä½¿ç”¨å¿«é€Ÿéµ F11 ä¹Ÿå¯é€²å…¥å…¨è¢å¹•<br>
                â€¢ å»ºè­°ä½¿ç”¨è€³æ©Ÿé¿å…å›éŸ³<br>
                â€¢ ç¢ºä¿è‰¯å¥½çš„å…‰ç·šæå‡ç•«è³ª<br>
                â€¢ å°æ’­å¯åœ¨è§€çœ¾åå–®ä¸­è¸¢é™¤ä¸ç•¶è§€çœ¾</p>
            </div>

            <div class="info-section">
                <h4>ğŸ”§ æŠ€è¡“éœ€æ±‚</h4>
                <p>â€¢ ä½¿ç”¨ Chrome/Edge/Safari ç€è¦½å™¨<br>
                â€¢ å…è¨±æ”å½±æ©Ÿèˆ‡éº¥å…‹é¢¨æ¬Šé™<br>
                â€¢ å»ºè­°ä½¿ç”¨ Wi-Fi æˆ– 4G/5G ç¶²è·¯<br>
                â€¢ æ”¯æ´ WebRTC çš„ç¾ä»£ç€è¦½å™¨</p>
            </div>

            <button class="action-btn" onclick="closeInfo()">é—œé–‰</button>
        </div>
    </div>

<script>
    let peer = null, localStream = null, hostConn = null;
    let guestConnections = [], pendingConnection = null;
    let mediaRecorder = null, chunks = [], startTime = 0, timerInterval = null;
    let voteData = [0, 0, 0, 0, 0]; // 1-5æ˜Ÿçš„ç¥¨æ•¸
    let viewerCount = 0;
    let selectedQuality = 'medium'; // é è¨­ç•«è³ª
    let viewerData = new Map(); // å„²å­˜è§€çœ¾è³‡æ–™ {peerId: {joinTime, conn}}
    let qualityCheckInterval = null; // å“è³ªæª¢æ¸¬è¨ˆæ™‚å™¨
    let countdownInterval = null; // å€’æ•¸è¨ˆæ™‚å™¨
    let scheduledTime = null; // é å®šé–‹æ’­æ™‚é–“

    // ç•«è³ªè¨­å®š
    const qualitySettings = {
        low: { width: 640, height: 480, label: 'æ¨™æº– 480p' },
        medium: { width: 1280, height: 720, label: 'é«˜æ¸… 720p' },
        high: { width: 1920, height: 1080, label: 'è¶…æ¸… 1080p' }
    };

    // è¤‡è£½åˆ°å‰ªè²¼ç°¿åŠŸèƒ½
    function copyToClipboard(text) {
        if (!text || text === 'å•Ÿå‹•æ”å½±æ©Ÿå¾Œé¡¯ç¤º') {
            log("å°šæœªç”¢ç”Ÿå°æ’­ IDï¼Œè«‹å…ˆå•Ÿå‹•æ”å½±æ©Ÿ");
            return;
        }

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                showCopyTooltip();
                log("å°æ’­ ID å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿: " + text);
            }).catch(err => {
                fallbackCopyToClipboard(text);
            });
        } else {
            fallbackCopyToClipboard(text);
        }
    }

    function fallbackCopyToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            document.execCommand('copy');
            showCopyTooltip();
            log("å°æ’­ ID å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿: " + text);
        } catch (err) {
            log("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½");
        }
        
        document.body.removeChild(textArea);
    }

    function showCopyTooltip() {
        const tooltip = document.getElementById('copyTooltip');
        tooltip.classList.add('show');
        setTimeout(() => {
            tooltip.classList.remove('show');
        }, 2000);
    }

    // åˆå§‹åŒ– PeerJS
    window.addEventListener('load', () => {
        peer = new Peer({
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        });

        peer.on('open', (id) => {
            document.getElementById('myId').value = id;
            log("ç³»çµ±å·²å°±ç·’ï¼ŒPeer ID: " + id);
            setStatus("ç³»çµ±å°±ç·’", "normal");
        });

        peer.on('connection', (conn) => {
            log("æ”¶åˆ°è§€çœ¾é€£ç·šè«‹æ±‚: " + conn.peer);
            pendingConnection = conn;
            
            conn.on('data', (data) => {
                handleIncomingData(data, conn);
            });

            conn.on('close', () => {
                handleViewerDisconnect(conn);
            });

            const confirmMsg = `è§€çœ¾ ${conn.peer.substring(0, 8)}... è«‹æ±‚é€£ç·šï¼Œæ˜¯å¦æ¥å—ï¼Ÿ`;
            setTimeout(() => { 
                if(pendingConnection) handleGuestRequest(confirm(confirmMsg)); 
            }, 500);
        });

        peer.on('call', (call) => {
            call.answer();
            call.on('stream', (remoteStream) => {
                handleRemoteStream(remoteStream);
            });
        });

        peer.on('error', (err) => {
            log("Peer éŒ¯èª¤: " + err.type);
        });

        // å•Ÿå‹•é€£ç·šå“è³ªç›£æ¸¬ï¼ˆåƒ…è§€çœ¾ç«¯ï¼‰
        startQualityMonitoring();
    });

    // åˆ‡æ›åˆ†é 
    function switchTab(mode) {
        const isHost = mode === 'host';
        document.getElementById('tab-h').classList.toggle('active', isHost);
        document.getElementById('tab-g').classList.toggle('active', !isHost);
        document.getElementById('panelHost').classList.toggle('hidden', !isHost);
        document.getElementById('panelGuest').classList.toggle('hidden', isHost);
    }

    // è¨­å®šç•«è³ª
    function setQuality(quality, event) {
        selectedQuality = quality;
        document.querySelectorAll('.quality-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        log(`ç•«è³ªå·²è¨­å®šç‚º: ${qualitySettings[quality].label}`);
    }

    // å°æ’­ç«¯ï¼šå•Ÿå‹•æ”å½±æ©Ÿ
    async function startCamera() {
        try {
            const settings = qualitySettings[selectedQuality];
            localStream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: { ideal: settings.width },
                    height: { ideal: settings.height }
                }, 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });
            const video = document.getElementById('vDisplay');
            video.srcObject = localStream;
            video.muted = true;
            document.getElementById('videoContainer').classList.add('active');
            document.getElementById('recBtn').disabled = false;
            log(`æ”å½±æ©Ÿå·²å•Ÿå‹• (${settings.label})`);
            setStatus("æ”å½±æ©Ÿå·²å°±ç·’", "normal");
        } catch (err) {
            log("ç„¡æ³•å–å¾—æ”å½±æ©Ÿ: " + err.message);
            alert("è«‹å…è¨±ä½¿ç”¨æ”å½±æ©Ÿèˆ‡éº¥å…‹é¢¨ï¼");
        }
    }

    // æ›´æ–°è§€çœ¾äººæ•¸
    function updateViewerCount() {
        viewerCount = guestConnections.length;
        document.getElementById('viewerNumber').innerText = viewerCount;
        document.getElementById('hostViewerCount').innerText = viewerCount;
        document.getElementById('guestViewerCount').innerText = viewerCount;
        
        broadcastData({type: 'viewerCount', count: viewerCount});
    }

    // æ›´æ–°è§€çœ¾åå–®é¡¯ç¤º
    function updateViewerList() {
        const listContainer = document.getElementById('viewerList');
        
        if (viewerData.size === 0) {
            listContainer.innerHTML = '<div class="viewer-list-empty">å°šç„¡è§€çœ¾é€£ç·š</div>';
            return;
        }
        
        listContainer.innerHTML = '';
        viewerData.forEach((data, peerId) => {
            const duration = Math.floor((Date.now() - data.joinTime) / 1000);
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            const item = document.createElement('div');
            item.className = 'viewer-item';
            item.innerHTML = `
                <div class="viewer-info">
                    <span class="viewer-icon">ğŸ‘¤</span>
                    <span class="viewer-id">${peerId.substring(0, 12)}...</span>
                </div>
                <span class="viewer-time">${timeStr}</span>
                <button class="kick-btn" onclick="kickViewer('${peerId}')">è¸¢é™¤</button>
            `;
            listContainer.appendChild(item);
        });
    }

    // è¸¢é™¤è§€çœ¾
    function kickViewer(peerId) {
        const data = viewerData.get(peerId);
        if (data && data.conn) {
            // å…ˆç™¼é€è¸¢é™¤é€šçŸ¥çµ¦è§€çœ¾
            try {
                data.conn.send({type: 'kicked', message: 'æ‚¨å·²è¢«å°æ’­ç§»é™¤'});
            } catch (err) {
                console.error('ç™¼é€è¸¢é™¤é€šçŸ¥å¤±æ•—:', err);
            }
            
            // å»¶é²é—œé–‰é€£ç·šï¼Œç¢ºä¿è¨Šæ¯é€é”
            setTimeout(() => {
                data.conn.close();
            }, 100);
            
            viewerData.delete(peerId);
            const index = guestConnections.findIndex(c => c.peer === peerId);
            if (index > -1) {
                guestConnections.splice(index, 1);
            }
            updateViewerCount();
            updateViewerList();
            log(`å·²è¸¢é™¤è§€çœ¾: ${peerId.substring(0, 8)}...`);
        }
    }

    // è™•ç†è§€çœ¾æ–·ç·š
    function handleViewerDisconnect(conn) {
        const peerId = conn.peer;
        viewerData.delete(peerId);
        const index = guestConnections.indexOf(conn);
        if (index > -1) {
            guestConnections.splice(index, 1);
            updateViewerCount();
            updateViewerList();
            log("è§€çœ¾é›¢é–‹: " + peerId.substring(0, 8) + "...");
        }
    }

    // è™•ç†æ¥æ”¶åˆ°çš„è³‡æ–™
    function handleIncomingData(data, conn) {
        if (data.type === 'vote') {
            voteData[data.val - 1]++;
            updateVoteUI();
            broadcastData({type: 'update', data: voteData});
            log(`æ”¶åˆ°è©•åƒ¹: ${data.val} æ˜Ÿ (ä¾†è‡ª ${conn.peer.substring(0,8)}...)`);
        } else if (data.type === 'update') {
            voteData = data.data;
            updateVoteUI();
        } else if (data.type === 'viewerCount') {
            // åŒæ™‚æ›´æ–°ç›´æ’­è³‡è¨Šé¢æ¿å’Œé ‚éƒ¨çš„ç·šä¸Šäººæ•¸é¡¯ç¤º
            document.getElementById('guestViewerCount').innerText = data.count;
            document.getElementById('viewerCount').innerText = data.count;
        } else if (data.type === 'kicked') {
            // è¢«å°æ’­è¸¢é™¤
            handleKicked(data.message);
        } else if (data.type === 'countdown') {
            // ğŸ†• è™•ç†å€’æ•¸è³‡è¨Š
            handleCountdown(data);
        }
    }

    // å»£æ’­è³‡æ–™çµ¦æ‰€æœ‰è§€çœ¾
    function broadcastData(data) {
        guestConnections.forEach(conn => {
            if (conn.open) {
                try {
                    conn.send(data);
                } catch (err) {
                    console.error('å»£æ’­å¤±æ•—:', err);
                }
            }
        });
    }

    // å°æ’­ç«¯ï¼šè™•ç†é€£ç·šè«‹æ±‚
    function handleGuestRequest(accepted) {
        const guestId = pendingConnection.peer;
        if (accepted) {
            log(`å·²æ¥å— ${guestId}`);
            guestConnections.push(pendingConnection);
            
            // è¨˜éŒ„è§€çœ¾è³‡æ–™
            viewerData.set(guestId, {
                joinTime: Date.now(),
                conn: pendingConnection
            });
            
            updateViewerCount();
            updateViewerList();
            
            if(pendingConnection.open) {
                pendingConnection.send({type: 'update', data: voteData});
                pendingConnection.send({type: 'viewerCount', count: viewerCount});
                
                // ğŸ†• å¦‚æœæœ‰é€²è¡Œä¸­çš„å€’æ•¸ï¼Œç«‹å³ç™¼é€çµ¦æ–°è§€çœ¾
                if (scheduledTime) {
                    const remaining = Math.max(0, Math.floor((scheduledTime - Date.now()) / 1000));
                    if (remaining > 0) {
                        const h = Math.floor(remaining / 3600);
                        const m = Math.floor((remaining % 3600) / 60);
                        const s = remaining % 60;
                        const timeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                        
                        pendingConnection.send({
                            type: 'countdown',
                            active: true,
                            time: timeStr
                        });
                        log(`å·²ç™¼é€å€’æ•¸è³‡è¨Šçµ¦æ–°è§€çœ¾: ${timeStr}`);
                    }
                }
            }
            const call = peer.call(guestId, localStream);
            call.on('close', () => log("è§€çœ¾è¦–è¨Šæ–·ç·š"));
            setStatus("â— ç›´æ’­ä¸­ (è¨Šè™Ÿå‚³é€ä¸­)", "rec");
        } else {
            log(`å·²æ‹’çµ• ${guestId}`);
            pendingConnection.close();
        }
        pendingConnection = null;
    }

    // è§€çœ¾ç«¯ï¼šé€£ç·šè«‹æ±‚
    function connectToHost() {
        const id = document.getElementById('targetId').value.trim();

        if (!id) return alert("è«‹è¼¸å…¥å°æ’­ ID");

        setStatus("è«‹æ±‚é€£ç·šä¸­...", "normal");
        log(`æ­£åœ¨å‚³é€è¨Šè™Ÿçµ¦å°æ’­ ID: ${id}`);
        
        const conn = peer.connect(id);
        hostConn = conn;
        
        conn.on('open', () => {
            log("è¨Šè™Ÿå·²é€é”ï¼Œç­‰å¾…å°æ’­ç¢ºèª...");
            setStatus("ç­‰å¾…å°æ’­æ¥å—...", "normal");
        });

        conn.on('data', (data) => {
            handleIncomingData(data, conn);
        });

        conn.on('close', () => {
            log("è¨Šè™Ÿé€£ç·šä¸­æ–·");
            hostConn = null;
            setStatus("é€£ç·šå·²ä¸­æ–·", "normal");
            document.getElementById('connectionQuality').classList.add('hidden');
            
            // åœæ­¢è¦–è¨Šæ’­æ”¾ä¸¦æ¸…é™¤ç•«é¢
            stopVideoPlayback();
        });

        conn.on('error', (err) => {
            log("é€£ç·šå¤±æ•—: " + err);
            setStatus("æ‰¾ä¸åˆ°å°æ’­ ID", "normal");
        });
    }

    function handleRemoteStream(remoteStream) {
        const video = document.getElementById('vDisplay');
        video.srcObject = remoteStream;
        video.muted = false;
        document.getElementById('videoContainer').classList.add('active');
        log("å·²æ¥æ”¶å½±åƒè¨Šè™Ÿï¼");
        setStatus("â— ç›´æ’­æ”¶çœ‹ä¸­", "live");

        // é¡¯ç¤ºé€£ç·šå“è³ªæŒ‡ç¤ºå™¨
        document.getElementById('connectionQuality').classList.remove('hidden');
        
        // ğŸ†• é¡¯ç¤ºè§€çœ¾äººæ•¸ï¼ˆè‡ªå·±ä¹Ÿç®—ä¸€å€‹ï¼‰
        document.getElementById('viewerCount').classList.remove('hidden');

        const playPromise = video.play();
        if (playPromise !== undefined) {
            playPromise.then(() => {
                log("è‡ªå‹•æ’­æ”¾æˆåŠŸ");
            }).catch(error => {
                log("è‡ªå‹•æ’­æ”¾è¢«é˜»æ“‹ï¼Œé¡¯ç¤ºæ’­æ”¾æŒ‰éˆ•");
                document.getElementById('playOverlay').classList.remove('hidden');
            });
        }
    }

    function forcePlay() {
        const video = document.getElementById('vDisplay');
        const playOverlay = document.getElementById('playOverlay');
        const countdownOverlay = document.getElementById('countdownOverlay');
        
        // ğŸ†• ç¢ºä¿å€’æ•¸é®ç½©å·²éš±è—
        countdownOverlay.classList.add('hidden');
        
        // å˜—è©¦æ’­æ”¾
        const playPromise = video.play();
        if (playPromise !== undefined) {
            playPromise.then(() => {
                playOverlay.classList.add('hidden');
                log("ä½¿ç”¨è€…è§¸ç™¼æ’­æ”¾æˆåŠŸ");
            }).catch(error => {
                log("æ’­æ”¾å¤±æ•—: " + error.message);
                // æ’­æ”¾å¤±æ•—æ™‚ä¿æŒæ’­æ”¾æŒ‰éˆ•é¡¯ç¤º
            });
        } else {
            playOverlay.classList.add('hidden');
            log("ä½¿ç”¨è€…è§¸ç™¼æ’­æ”¾");
        }
    }

    // é€£ç·šå“è³ªç›£æ¸¬
    function startQualityMonitoring() {
        qualityCheckInterval = setInterval(() => {
            if (hostConn && hostConn.open) {
                // æ¨¡æ“¬å»¶é²æª¢æ¸¬ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­å¯ä½¿ç”¨ WebRTC çµ±è¨ˆè³‡æ–™ï¼‰
                const latency = Math.random() * 300 + 50; // 50-350ms æ¨¡æ“¬å»¶é²
                updateQualityIndicator(latency);
            }
        }, 2000);
    }

    function updateQualityIndicator(latency) {
        const indicator = document.getElementById('connectionQuality');
        const icon = document.getElementById('signalIcon');
        const text = document.getElementById('qualityText');
        const details = document.getElementById('qualityDetails');
        
        let quality, qualityClass;
        
        if (latency < 100) {
            quality = 'å„ªç•°';
            qualityClass = 'quality-excellent';
            icon.textContent = 'ğŸ“¶';
        } else if (latency < 200) {
            quality = 'è‰¯å¥½';
            qualityClass = 'quality-good';
            icon.textContent = 'ğŸ“¶';
        } else if (latency < 500) {
            quality = 'æ™®é€š';
            qualityClass = 'quality-poor';
            icon.textContent = 'ğŸ“¡';
        } else {
            quality = 'ä¸ä½³';
            qualityClass = 'quality-bad';
            icon.textContent = 'ğŸ“¡';
        }
        
        text.textContent = quality;
        text.className = 'quality-text ' + qualityClass;
        details.textContent = `${Math.round(latency)}ms`;
    }

    // å…¨è¢å¹•åŠŸèƒ½
    function toggleFullscreen() {
        const container = document.getElementById('videoContainer');
        
        if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement) {
            if (container.requestFullscreen) {
                container.requestFullscreen();
            } else if (container.webkitRequestFullscreen) {
                container.webkitRequestFullscreen();
            } else if (container.mozRequestFullScreen) {
                container.mozRequestFullScreen();
            }
            log("é€²å…¥å…¨è¢å¹•æ¨¡å¼");
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            }
            log("é€€å‡ºå…¨è¢å¹•æ¨¡å¼");
        }
    }

    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.addEventListener('mozfullscreenchange', handleFullscreenChange);

    function handleFullscreenChange() {
        const btn = document.getElementById('fullscreenBtn');
        if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement) {
            btn.innerText = 'âœ•';
        } else {
            btn.innerText = 'â›¶';
        }
    }

    // ç›´æ’­é å‘ŠåŠŸèƒ½
    function setSchedule() {
        const hours = parseInt(document.getElementById('scheduleHours').value) || 0;
        const minutes = parseInt(document.getElementById('scheduleMinutes').value) || 0;
        const seconds = parseInt(document.getElementById('scheduleSeconds').value) || 0;
        
        const totalSeconds = hours * 3600 + minutes * 60 + seconds;
        
        if (totalSeconds <= 0) {
            alert('è«‹è¨­å®šæœ‰æ•ˆçš„å€’æ•¸æ™‚é–“ï¼');
            return;
        }
        
        scheduledTime = Date.now() + totalSeconds * 1000;
        document.getElementById('countdownOverlay').classList.remove('hidden');
        document.getElementById('cancelScheduleBtn').style.display = 'block';
        
        log(`å·²è¨­å®šç›´æ’­é å‘Šï¼š${hours}æ™‚${minutes}åˆ†${seconds}ç§’å¾Œé–‹å§‹`);
        
        // ğŸ†• ç«‹å³å»£æ’­å€’æ•¸è³‡è¨Šçµ¦æ‰€æœ‰è§€çœ¾
        broadcastCountdown();
        
        // å•Ÿå‹•å€’æ•¸è¨ˆæ™‚
        countdownInterval = setInterval(() => {
            const remaining = Math.max(0, Math.floor((scheduledTime - Date.now()) / 1000));
            
            if (remaining <= 0) {
                cancelSchedule();
                log('ç›´æ’­é å‘Šå€’æ•¸çµæŸï¼Œé–‹å§‹ç›´æ’­ï¼');
                return;
            }
            
            const h = Math.floor(remaining / 3600);
            const m = Math.floor((remaining % 3600) / 60);
            const s = remaining % 60;
            
            const timeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            document.getElementById('countdownTimer').textContent = timeStr;
            
            // ğŸ†• æ¯ç§’å»£æ’­å€’æ•¸è³‡è¨Šçµ¦æ‰€æœ‰è§€çœ¾
            broadcastCountdown();
        }, 1000);
    }

    function cancelSchedule() {
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
        scheduledTime = null;
        document.getElementById('countdownOverlay').classList.add('hidden');
        document.getElementById('cancelScheduleBtn').style.display = 'none';
        document.getElementById('scheduleHours').value = '0';
        document.getElementById('scheduleMinutes').value = '0';
        document.getElementById('scheduleSeconds').value = '0';
        log('å·²å–æ¶ˆç›´æ’­é å‘Šå€’æ•¸');
        
        // ğŸ†• å»£æ’­å–æ¶ˆå€’æ•¸çµ¦æ‰€æœ‰è§€çœ¾
        broadcastData({type: 'countdown', active: false});
    }

    function toggleRecording() {
        const btn = document.getElementById('recBtn');
        const timerDisplay = document.getElementById('recTimer');
        
        if (btn.innerText.includes("é–‹å§‹")) {
            chunks = [];
            try { 
                mediaRecorder = new MediaRecorder(localStream, {
                    mimeType: 'video/webm;codecs=vp8,opus'
                }); 
            } 
            catch (e) { 
                try {
                    mediaRecorder = new MediaRecorder(localStream);
                } catch (e2) {
                    return alert("ç€è¦½å™¨ä¸æ”¯æ´éŒ„å½±");
                }
            }

            mediaRecorder.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const timestamp = new Date().toLocaleString('zh-TW').replace(/\//g, '-').replace(/:/g, '-').replace(/\s/g, '_');
                a.href = url; 
                a.download = `å…¬èˆ˜ç›´æ’­_${timestamp}.webm`; 
                a.click();
                log("éŒ„å½±å·²å„²å­˜");
            };
            
            mediaRecorder.start();
            btn.innerText = "â¹ åœæ­¢ä¸¦ä¸‹è¼‰";
            btn.style.background = "#333";
            timerDisplay.style.display = "inline";
            
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const diff = Math.floor((Date.now() - startTime) / 1000);
                const m = Math.floor(diff / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                timerDisplay.innerText = `REC ${m}:${s}`;
            }, 1000);
            log("é–‹å§‹éŒ„å½±");
        } else {
            mediaRecorder.stop();
            clearInterval(timerInterval);
            btn.innerText = "2. é–‹å§‹éŒ„å½±";
            btn.style.background = "linear-gradient(135deg, #ff0055, #ff4d4d)";
            timerDisplay.style.display = "none";
        }
    }

    // è©•åˆ†ç³»çµ±é‚è¼¯
    function updateVoteUI() {
        const total = voteData.reduce((a, b) => a + b, 0);
        document.querySelectorAll('#totalVotes').forEach(el => el.innerText = total);

        let weightedSum = 0;
        for (let i = 0; i < 5; i++) {
            weightedSum += voteData[i] * (i + 1);
        }

        const avg = total === 0 ? 0 : (weightedSum / total).toFixed(1);
        document.querySelectorAll('#avgScore').forEach(el => el.innerText = avg);
    }

    function highlightStars(count) {
        const stars = document.querySelectorAll('.star-btn');
        const labels = ["åŠ æ²¹", "æ™®é€š", "é‚„è¡Œ", "ä¸éŒ¯", "è¶…è®šï¼"];
        const feedback = document.getElementById('vote-feedback');
        
        stars.forEach((star, index) => {
            if (index < count) {
                star.style.color = 'var(--gold)';
                star.style.textShadow = '0 0 10px var(--gold)';
                star.style.transform = 'scale(1.1)';
            } else {
                star.style.color = '#444';
                star.style.textShadow = 'none';
                star.style.transform = 'scale(1)';
            }
        });
        
        feedback.innerText = `${count} é¡†æ˜Ÿ - ${labels[count-1]}`;
        feedback.style.opacity = '1';
    }

    function resetStars() {
        const stars = document.querySelectorAll('.star-btn');
        const feedback = document.getElementById('vote-feedback');
        
        stars.forEach(star => {
            star.style.color = '#444';
            star.style.textShadow = 'none';
            star.style.transform = 'scale(1)';
        });
        
        feedback.style.opacity = '0';
    }

    function vote(starVal) {
        const isHost = document.getElementById('tab-h').classList.contains('active');
        
        const feedback = document.getElementById('vote-feedback');
        feedback.innerText = `å·²é€å‡º ${starVal} æ˜Ÿå¥½è©•ï¼`;
        feedback.style.opacity = '1';
        setTimeout(() => { if(feedback.innerText.includes('å·²é€å‡º')) feedback.style.opacity = '0'; }, 1500);

        if (isHost) {
            voteData[starVal-1]++;
            updateVoteUI();
            broadcastData({type: 'update', data: voteData});
            log(`å°æ’­çµ¦äºˆè©•åƒ¹: ${starVal} æ˜Ÿ`);
        } else {
            if (hostConn && hostConn.open) {
                hostConn.send({type: 'vote', val: starVal});
                log(`å·²é€å‡ºè©•åƒ¹: ${starVal} æ˜Ÿ`);
            } else {
                alert("è«‹å…ˆé€£ç·šè‡³å°æ’­æ‰èƒ½è©•åˆ†ï¼");
            }
        }
    }

    function resetVote() { 
        const isHost = document.getElementById('tab-h').classList.contains('active');
        if (!isHost) return alert("æ¬Šé™ä¸è¶³ï¼šåªæœ‰å°æ’­å¯ä»¥é‡ç½®çµ±è¨ˆæ•¸æ“šã€‚");

        voteData = [0, 0, 0, 0, 0]; 
        updateVoteUI(); 
        broadcastData({type: 'update', data: voteData});
        log("è©•åˆ†æ•¸æ“šå·²é‡ç½®ä¸¦åŒæ­¥");
    }

    // Modal æ§åˆ¶
    function showInfo() {
        document.getElementById('infoModal').classList.remove('hidden');
    }
    function closeInfo() {
        document.getElementById('infoModal').classList.add('hidden');
    }

    // å·¥å…·å‡½æ•¸
    function setStatus(text, type) {
        const dot = document.getElementById('statusDot');
        document.getElementById('statusText').innerText = text;
        dot.className = 'dot'; 
        if (type === 'live') dot.classList.add('live');
        if (type === 'rec') dot.classList.add('rec');
    }

    function log(msg) {
        const boxes = document.querySelectorAll('#logs');
        const time = new Date().toLocaleTimeString();
        boxes.forEach(box => {
            box.innerHTML += `> [${time}] ${msg}<br>`;
            box.scrollTop = box.scrollHeight;
        });
    }

    // è™•ç†è¢«è¸¢é™¤
    function handleKicked(message) {
        log(message || 'æ‚¨å·²è¢«å°æ’­ç§»é™¤');
        alert('âš ï¸ ' + (message || 'æ‚¨å·²è¢«å°æ’­ç§»é™¤'));
        
        // åœæ­¢è¦–è¨Šæ’­æ”¾ä¸¦æ¸…é™¤ç•«é¢
        stopVideoPlayback();
        
        // æ–·é–‹é€£ç·š
        if (hostConn) {
            hostConn.close();
            hostConn = null;
        }
        
        setStatus("å·²è¢«ç§»é™¤", "normal");
        document.getElementById('connectionQuality').classList.add('hidden');
    }

    // å»£æ’­å€’æ•¸è³‡è¨Šçµ¦æ‰€æœ‰è§€çœ¾
    function broadcastCountdown() {
        if (!scheduledTime) {
            // å¦‚æœæ²’æœ‰æ’ç¨‹æ™‚é–“ï¼Œç™¼é€å–æ¶ˆè¨Šè™Ÿ
            broadcastData({
                type: 'countdown',
                active: false
            });
            return;
        }
        
        const remaining = Math.max(0, Math.floor((scheduledTime - Date.now()) / 1000));
        
        if (remaining > 0) {
            const h = Math.floor(remaining / 3600);
            const m = Math.floor((remaining % 3600) / 60);
            const s = remaining % 60;
            const timeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            
            broadcastData({
                type: 'countdown',
                active: true,
                time: timeStr
            });
        } else {
            // å€’æ•¸çµæŸï¼Œç™¼é€çµæŸè¨Šè™Ÿ
            broadcastData({
                type: 'countdown',
                active: false
            });
        }
    }

    // è§€çœ¾ç«¯è™•ç†å€’æ•¸è³‡è¨Š
    function handleCountdown(data) {
        const overlay = document.getElementById('countdownOverlay');
        const timer = document.getElementById('countdownTimer');
        const playOverlay = document.getElementById('playOverlay');
        
        if (data.active && data.time) {
            // é¡¯ç¤ºå€’æ•¸
            overlay.classList.remove('hidden');
            timer.textContent = data.time;
            log(`ç›´æ’­å€’æ•¸ä¸­: ${data.time}`);
        } else {
            // å–æ¶ˆå€’æ•¸æˆ–å€’æ•¸çµæŸ
            overlay.classList.add('hidden');
            log('ç›´æ’­å€’æ•¸å·²çµæŸï¼Œé–‹å§‹è§€çœ‹');
            
            // ğŸ†• å€’æ•¸çµæŸå¾Œï¼Œæª¢æŸ¥è¦–è¨Šæ˜¯å¦æ­£åœ¨æ’­æ”¾
            const video = document.getElementById('vDisplay');
            if (video.srcObject && video.paused) {
                // å¦‚æœè¦–è¨Šæš«åœï¼Œå˜—è©¦è‡ªå‹•æ’­æ”¾
                const playPromise = video.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        log("å€’æ•¸çµæŸï¼Œè‡ªå‹•æ’­æ”¾æˆåŠŸ");
                        playOverlay.classList.add('hidden');
                    }).catch(error => {
                        log("å€’æ•¸çµæŸï¼Œéœ€è¦ä½¿ç”¨è€…é»æ“Šæ’­æ”¾");
                        playOverlay.classList.remove('hidden');
                    });
                }
            }
        }
    }

    // åœæ­¢è¦–è¨Šæ’­æ”¾ä¸¦æ¸…é™¤ç•«é¢
    function stopVideoPlayback() {
        const video = document.getElementById('vDisplay');
        
        // åœæ­¢æ’­æ”¾
        video.pause();
        
        // åœæ­¢æ‰€æœ‰åª’é«”è»Œé“
        if (video.srcObject) {
            const stream = video.srcObject;
            const tracks = stream.getTracks();
            tracks.forEach(track => track.stop());
        }
        
        // æ¸…é™¤è¦–è¨Šæº
        video.srcObject = null;
        video.src = '';
        
        // ç§»é™¤ active é¡åˆ¥
        document.getElementById('videoContainer').classList.remove('active');
        
        log("è¦–è¨Šæ’­æ”¾å·²åœæ­¢");
    }

    // å®šæœŸæ›´æ–°è§€çœ¾åå–®ä¸­çš„é€£ç·šæ™‚é•·
    setInterval(() => {
        if (viewerData.size > 0) {
            updateViewerList();
        }
    }, 1000);

    // é é¢é—œé–‰æ™‚æ¸…ç†
    window.addEventListener('beforeunload', () => {
        if (qualityCheckInterval) clearInterval(qualityCheckInterval);
        if (countdownInterval) clearInterval(countdownInterval);
        if (timerInterval) clearInterval(timerInterval);
    });
</script>

</body>
</html>
