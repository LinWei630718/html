<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœªä¾†è¦– PRO - å…¨çƒé€£ç·šç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-deep: #0a0a0f;
            --cyber-cyan: #00f2ff;
            --cyber-purple: #bc13fe;
            --neon-red: #ff0055;
            --text-main: #e0e0e0;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --gold: #ffd700;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-deep);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 242, 255, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(188, 19, 254, 0.05) 0%, transparent 20%);
            color: var(--text-main);
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        header { 
            width: 100%; 
            padding: 15px; 
            text-align: center; 
            border-bottom: 1px solid var(--glass-border);
            background: rgba(10, 10, 15, 0.8);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .live-tag { 
            color: var(--neon-red); 
            font-weight: bold; 
            font-size: 0.8rem; 
            letter-spacing: 2px; 
            text-shadow: 0 0 10px rgba(255, 0, 85, 0.5);
            animation: pulse 2s infinite; 
            margin-bottom: 5px;
            display: inline-block;
        }
        @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }

        h1 {
            margin: 0;
            letter-spacing: 2px;
            font-size: 1.5rem;
        }

        .tabs { 
            display: flex; 
            gap: 10px; 
            margin: 15px 0; 
            background: var(--glass); 
            padding: 5px; 
            border-radius: 12px; 
            border: 1px solid var(--glass-border);
        }
        .tab-btn { 
            background: none; 
            border: none; 
            color: var(--text-main); 
            padding: 8px 20px; 
            cursor: pointer; 
            border-radius: 8px; 
            transition: 0.3s; 
            font-size: 0.95rem;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.05); }
        .tab-btn.active { 
            background: var(--cyber-cyan); 
            color: var(--bg-deep); 
            font-weight: bold; 
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.3);
        }

        /* èª¿æ•´ä¸»å®¹å™¨å¯¬åº¦é…ç½® */
        .main-container { 
            width: 99%; 
            max-width: 100%; 
            display: grid; 
            grid-template-columns: 1fr 250px; 
            gap: 15px; 
            padding: 0 10px 20px 10px;
            flex: 1;
        }
        @media (max-width: 900px) { .main-container { grid-template-columns: 1fr; } }

        .video-box { 
            background: #000; 
            border-radius: 20px; 
            position: relative; 
            border: 1px solid var(--glass-border); 
            overflow: hidden; 
            aspect-ratio: 16/9;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            transition: border-color 0.3s;
            width: 100%; 
        }
        .video-box.active { border-color: var(--cyber-cyan); box-shadow: 0 0 20px rgba(0,242,255,0.1); }
        
        video { width: 100%; height: 100%; object-fit: cover; background: #111; }
        
        .status-bar { 
            position: absolute; 
            top: 15px; 
            left: 15px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(5px);
            padding: 6px 14px; 
            border-radius: 50px; 
            font-size: 0.85rem; 
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 10;
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #666; transition: 0.3s; }
        .dot.live { background: var(--cyber-cyan); box-shadow: 0 0 10px var(--cyber-cyan); }
        .dot.rec { background: var(--neon-red); animation: pulse 1s infinite; }

        /* æ’­æ”¾æŒ‰éˆ•é®ç½© */
        .play-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            cursor: pointer;
            backdrop-filter: blur(2px);
        }
        .play-icon {
            font-size: 3rem;
            color: var(--cyber-cyan);
            background: rgba(255,255,255,0.1);
            width: 80px; height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--cyber-cyan);
            box-shadow: 0 0 20px rgba(0,242,255,0.3);
            transition: 0.3s;
        }
        .play-overlay:hover .play-icon { transform: scale(1.1); background: rgba(0,242,255,0.2); }

        .panel { 
            background: var(--glass); 
            backdrop-filter: blur(15px); 
            padding: 20px; 
            border-radius: 20px; 
            border: 1px solid var(--glass-border); 
            margin-bottom: 15px; 
        }
        
        h3 { margin-top: 0; color: var(--cyber-cyan); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; font-size: 1.1rem; }

        .input-group { margin-bottom: 15px; }
        .input-style { 
            background: rgba(0,0,0,0.3); 
            border: 1px solid var(--glass-border); 
            padding: 10px; 
            border-radius: 8px; 
            color: #fff; 
            width: 100%; 
            font-size: 0.95rem;
            transition: 0.3s;
        }
        .input-style:focus { outline: none; border-color: var(--cyber-cyan); background: rgba(0,0,0,0.5); }

        .action-btn { 
            background: linear-gradient(135deg, var(--cyber-cyan), var(--cyber-purple)); 
            border: none; 
            padding: 12px; 
            border-radius: 8px; 
            color: white; 
            width: 100%; 
            font-weight: bold; 
            font-size: 0.95rem;
            cursor: pointer; 
            margin-top: 5px; 
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(188, 19, 254, 0.3); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; filter: grayscale(1); }
        .action-btn.secondary { background: transparent; border: 1px solid var(--glass-border); }
        .action-btn.secondary:hover { background: rgba(255,255,255,0.05); box-shadow: none; }
        .action-btn.danger { background: linear-gradient(135deg, #ff0055, #cc0044); }

        /* æ˜Ÿæ˜Ÿè©•åˆ†ç³»çµ±æ¨£å¼ - èª¿æ•´å¤§å°ä»¥é©æ‡‰çª„æ¬„ */
        .score-display {
            text-align: center;
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--gold);
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            margin: 5px 0;
            font-family: 'Segoe UI', sans-serif;
        }
        .star-container {
            display: flex;
            justify-content: center;
            gap: 5px; 
            margin-bottom: 10px;
            background: rgba(0,0,0,0.3);
            padding: 8px;
            border-radius: 50px;
            border: 1px solid var(--glass-border);
            cursor: pointer; /* å¢åŠ æ‰‹æŒ‡æ¸¸æ¨™ */
        }
        .star-btn {
            font-size: 1.6rem; 
            color: #444;
            cursor: pointer;
            transition: transform 0.1s;
            user-select: none;
            /* ç§»é™¤èˆŠçš„ hover æ¨£å¼ï¼Œæ”¹ç”¨ JS æ§åˆ¶ */
        }
        .star-btn:active {
            transform: scale(0.9);
        }
        .total-votes {
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-main);
            opacity: 0.7;
        }
        
        /* æŠ•ç¥¨å›é¥‹æ–‡å­— */
        .vote-feedback-text {
            height: 20px; 
            font-size: 0.85rem; 
            color: var(--gold); 
            text-align: center; 
            margin-bottom: 10px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .hidden { display: none !important; }
        .id-display { 
            color: var(--cyber-cyan); 
            font-family: 'Courier New', monospace; 
            font-weight: bold; 
            background: rgba(0, 242, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            user-select: all;
            font-size: 0.9rem;
        }

        /* é€£ç·šç¢ºèªè¦–çª— & è³‡è¨Šè¦–çª— */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s;
        }
        .modal-box {
            background: var(--bg-deep);
            border: 1px solid var(--cyber-cyan);
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 0 40px rgba(0, 242, 255, 0.2);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 85vh;
            overflow-y: auto;
        }
        .modal-box.wide { max-width: 600px; text-align: left; }
        
        .info-section { margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
        .info-section:last-child { border-bottom: none; }
        .info-title { color: var(--cyber-cyan); font-weight: bold; margin-bottom: 10px; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        .info-content { font-size: 0.95rem; line-height: 1.6; opacity: 0.9; color: #ddd; }
        .info-badge { background: rgba(188, 19, 254, 0.2); padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; margin-left: auto; color: #fff; }

        /* ç‰ˆæ¬Šé å°¾ */
        footer {
            width: 100%;
            text-align: center;
            padding: 10px;
            font-size: 0.75rem;
            color: var(--text-main);
            opacity: 0.6;
            margin-top: auto;
            border-top: 1px solid var(--glass-border);
            background: rgba(0,0,0,0.2);
        }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .caller-id-badge {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 8px;
            font-family: monospace;
            color: var(--cyber-cyan);
            margin: 15px 0;
            word-break: break-all;
            display: inline-block;
        }
    </style>
</head>
<body>

<header>
    <div class="live-tag">â— GLOBAL NETWORK ENABLED</div>
    <h1>FUTURE VISION <span style="color:var(--cyber-cyan)">PRO</span></h1>
</header>

<div class="tabs">
    <button class="tab-btn active" id="tab-h" onclick="switchMode('host')">ğŸ“¡ å°æ’­ç«¯ (Host)</button>
    <button class="tab-btn" id="tab-g" onclick="switchMode('guest')">ğŸ“± è§€çœ¾ç«¯ (Guest)</button>
</div>

<!-- é€£ç·šè«‹æ±‚ Modal -->
<div id="callModal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3 style="border:none;">ğŸ“ æ”¶åˆ°é€£ç·šè«‹æ±‚</h3>
        <p>æœ‰ä¸€ä½è§€çœ¾æƒ³è¦é€£æ¥æ‚¨çš„ç›´æ’­ç•«é¢</p>
        <div class="caller-id-badge" id="callerIdDisplay">Unknown ID</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
            <button class="action-btn danger" onclick="handleCallDecision(false)">æ‹’çµ•</button>
            <button class="action-btn" onclick="handleCallDecision(true)">å…è¨±ä¸¦å‚³é€ç•«é¢</button>
        </div>
    </div>
</div>

<!-- ç³»çµ±èªªæ˜ Modal -->
<div id="infoModal" class="modal-overlay hidden" onclick="if(event.target === this) closeInfo()">
    <div class="modal-box wide">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0; border:none;">ğŸ“– ç³»çµ±æ‡‰ç”¨æŒ‡å—</h3>
            <button onclick="closeInfo()" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        
        <div class="info-section">
            <div class="info-title">ğŸ§¨ éå¹´èšæœƒç¥å™¨ <span class="info-badge">å®¶åº­å¨›æ¨‚</span></div>
            <div class="info-content">
                ä¸ç”¨å®‰è£ APPï¼Œé€™å°±æ˜¯æœ€å¥½çš„é›²ç«¯åœçˆå·¥å…·ï¼
                <ul style="padding-left: 20px; margin: 5px 0;">
                    <li><strong>å…¨çƒé€£ç·šï¼š</strong>é ç«¯è¦ªæˆšæƒæ ID å³å¯åŠ å…¥ï¼Œæ‰‹æ©Ÿ/å¹³æ¿çš†å¯é€šã€‚</li>
                    <li><strong>äº’å‹•æŠ•ç¥¨ï¼š</strong>ç™¼èµ·ã€Œæ‰è—è©•åˆ†ã€ã€ã€Œç´…åŒ…å¤§è³½ã€æŠ•ç¥¨ï¼Œç‚’ç†±æ°£æ°›ä¸å†·å ´ã€‚</li>
                    <li><strong>ç²¾å½©éŒ„å½±ï¼š</strong>ä¸€éµéŒ„ä¸‹å°å­©æ‹œå¹´ã€ç™¼ç´…åŒ…çš„çè²´ç¬é–“ï¼Œé«˜ç•«è³ªä¿å­˜ã€‚</li>
                </ul>
            </div>
        </div>

        <div class="info-section">
            <div class="info-title">ğŸ“ æ ¡åœ’æ‡‰ç”¨å ´æ™¯ <span class="info-badge" style="background:rgba(0, 242, 255, 0.2)">å°ˆæ¥­æ•™è‚²</span></div>
            <div class="info-content">
                å°ˆç‚ºæ ¡åœ’ç’°å¢ƒè¨­è¨ˆï¼Œè§£æ±ºå‚³çµ±å»£æ’­èˆ‡è¦–è¨Šç—›é»ï¼š
                <ul style="padding-left: 20px; margin: 5px 0;">
                    <li><strong>å…¨æ ¡æ™¨æœƒï¼š</strong>é›¨å¤©æˆ–é…·æš‘æ™‚ï¼Œæ ¡é•·å®¤ç›´æ’­ï¼Œå„ç­æŠ•å½±æ”¶çœ‹ã€‚</li>
                    <li><strong>é‹å‹•æœƒè½‰æ’­ï¼š</strong>å°è¨˜è€…æŒæ‰‹æ©Ÿåœ¨æ“å ´ç§»å‹•ï¼Œå®¶é•·é ç«¯è§€è³½ã€‚</li>
                    <li><strong>å¯¦é©—è§€å¯Ÿï¼š</strong>ç†åŒ–èª²å¾®è·æ‹æ”å¯¦é©—éç¨‹ï¼Œå…¨ç­å¤§è¢å¹•åŒæ­¥çœ‹ç´°ç¯€ã€‚</li>
                </ul>
            </div>
        </div>

        <div class="info-section">
            <div class="info-title">ğŸ›¡ï¸ æŠ€è¡“åŸç†èˆ‡éš±ç§å®‰å…¨</div>
            <div class="info-content">
                æœ¬ç³»çµ±æ¡ç”¨ <strong>WebRTC (P2P)</strong> æŠ€è¡“ï¼š
                <br>â€¢ <strong>ä¸ç¶“éä¼ºæœå™¨ï¼š</strong>å½±åƒç›´æ¥é»å°é»å‚³è¼¸ï¼Œä¸ç•™å­˜æ–¼ä»»ä½•é›²ç«¯å¹³å°ã€‚
                <br>â€¢ <strong>å°æ’­å¯©æ ¸åˆ¶ï¼š</strong>é™Œç”Ÿäººç„¡æ³•éš¨æ„é—–å…¥ï¼Œç¢ºä¿æ ¡åœ’èˆ‡å®¶åº­éš±ç§ã€‚
                <br>â€¢ <strong>é€£ç·šå³éŠ·æ¯€ï¼š</strong>ç¶²é é—œé–‰å¾Œï¼Œæ‰€æœ‰é€šé“è‡ªå‹•æ–·é–‹ï¼Œç„¡æ•¸ä½è¶³è·¡ã€‚
            </div>
        </div>
        
        <button class="action-btn" onclick="closeInfo()">äº†è§£ï¼Œé–‹å§‹ä½¿ç”¨</button>
    </div>
</div>

<div class="main-container">
    <!-- å·¦å´ï¼šè¦–è¨Šå€ -->
    <div class="left-col">
        <div id="videoContainer" class="video-box">
            <div class="status-bar">
                <div class="dot" id="statusDot"></div>
                <span id="statusText">ç­‰å¾…æ“ä½œ...</span>
                <span id="recTimer" style="color:var(--neon-red); display:none; margin-left:10px; font-weight:bold;">REC 00:00</span>
            </div>
            
            <!-- æ’­æ”¾è¦†è“‹å±¤ (é è¨­éš±è—) -->
            <div id="playOverlay" class="play-overlay hidden" onclick="forcePlay()">
                <div class="play-icon">â–¶</div>
                <p style="margin-top:15px; font-weight:bold;">é»æ“Šä»¥é–‹å§‹è§€çœ‹ç›´æ’­</p>
            </div>

            <video id="vDisplay" autoplay playsinline></video>
        </div>

        <div id="hostPanel" class="panel" style="margin-top:20px;">
            <h3>ğŸ“¡ å°æ’­æ§åˆ¶å°</h3>
            <p>æ‚¨çš„ç›´æ’­ ID: <span id="myId" class="id-display">æ­£åœ¨é€£æ¥ä¼ºæœå™¨...</span></p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <button id="camBtn" class="action-btn" onclick="initHost()">1. é–‹å•Ÿé¡é ­</button>
                <button id="recBtn" class="action-btn" style="background: linear-gradient(135deg, #ff0055, #ff4d4d);" onclick="toggleRecording()" disabled>2. é–‹å§‹éŒ„å½±</button>
            </div>
            <p style="font-size:0.8rem; opacity:0.6; margin-top:15px;">* è«‹å°‡ ID è¤‡è£½çµ¦è§€çœ¾ï¼Œé»æ“Š ID å¯å…¨é¸ã€‚<br>* éŒ„å½±æª”å°‡ä»¥ .webm æ ¼å¼ç›´æ¥ä¸‹è¼‰è‡³æ‚¨çš„è£ç½®ã€‚</p>
        </div>

        <div id="guestPanel" class="panel hidden" style="margin-top:20px;">
            <h3>ğŸ“º é€²å…¥ç›´æ’­é–“</h3>
            <div class="input-group">
                <input type="text" id="targetId" class="input-style" placeholder="è«‹è¼¸å…¥å°æ’­ ID">
            </div>
            <div class="input-group">
                <input type="password" id="pKey" class="input-style" placeholder="è¼¸å…¥æ ¡åœ’éš±ç§å¯†ç¢¼ (æç¤º: 2026...)">
            </div>
            <button class="action-btn" onclick="connectToHost()">é©—è­‰ä¸¦è«‹æ±‚ç•«é¢</button>
        </div>
    </div>

    <!-- å³å´ï¼šäº’å‹•å€ -->
    <div class="right-col">
        <div class="panel">
            <h3>ğŸ“Š å³æ™‚è©•åˆ†</h3>
            <p style="font-size:0.8rem; opacity:0.7;">è¦ºå¾—å…§å®¹æœ‰è¶£å—ï¼Ÿçµ¦å€‹äº”æ˜Ÿå¥½è©•ï¼</p>
            
            <!-- åˆ†æ•¸é¡¯ç¤º -->
            <div class="score-display">
                <span id="avgScore">0.0</span><span style="font-size:1.1rem; color:var(--text-main); opacity:0.6"> / 5.0</span>
            </div>

            <!-- æ˜Ÿæ˜ŸæŒ‰éˆ•å®¹å™¨ -->
            <div class="star-container" onmouseleave="resetStars()">
                <div class="star-btn" onmouseenter="highlightStars(1)" onclick="vote(1)">â˜…</div>
                <div class="star-btn" onmouseenter="highlightStars(2)" onclick="vote(2)">â˜…</div>
                <div class="star-btn" onmouseenter="highlightStars(3)" onclick="vote(3)">â˜…</div>
                <div class="star-btn" onmouseenter="highlightStars(4)" onclick="vote(4)">â˜…</div>
                <div class="star-btn" onmouseenter="highlightStars(5)" onclick="vote(5)">â˜…</div>
            </div>
            
            <div id="vote-feedback" class="vote-feedback-text"></div>

            <div class="total-votes">ç¸½ç¥¨æ•¸: <span id="totalVotes" style="color:var(--cyber-cyan); font-weight:bold;">0</span></div>

            <button class="action-btn secondary" style="margin-top:20px;" onclick="resetVote()">é‡è¨­è©•åˆ† (å°æ’­é™å®š)</button>
        </div>
        
        <!-- ç³»çµ±èªªæ˜æŒ‰éˆ•å€åŸŸ -->
        <div class="panel">
            <h3>ğŸ’¬ ç³»çµ±ç‹€æ…‹ & èªªæ˜</h3>
            <button class="action-btn secondary" style="margin-bottom:15px; border-color:var(--cyber-cyan); color:var(--cyber-cyan);" onclick="showInfo()">ğŸ“– ç³»çµ±èˆ‡æ‡‰ç”¨èªªæ˜</button>
            <div id="logs" style="font-family: monospace; font-size: 0.8rem; opacity: 0.7; height: 80px; overflow-y: auto;">
                > ç³»çµ±åˆå§‹åŒ–å®Œæˆ...<br>
                > ç­‰å¾…ä½¿ç”¨è€…é¸æ“‡æ¨¡å¼...
            </div>
        </div>
    </div>
</div>

<footer>
    <p>Â© 2026 LinWei's myviewpro Created with Google Apps Script & Tailwind CSS</p>
</footer>

<script>
    let peer = null;
    let localStream = null;
    let mediaRecorder = null;
    let chunks = [];
    
    // åˆå§‹åŒ–æŠ•ç¥¨è³‡æ–™: [1æ˜Ÿç¥¨æ•¸, 2æ˜Ÿç¥¨æ•¸, 3æ˜Ÿç¥¨æ•¸, 4æ˜Ÿç¥¨æ•¸, 5æ˜Ÿç¥¨æ•¸]
    let voteData = [0, 0, 0, 0, 0];
    
    let startTime = 0;
    let timerInterval = null;
    let pendingConnection = null; 
    let guestConnections = [];    
    let hostConn = null;          

    // åˆå§‹åŒ– PeerJS
    function initPeer() {
        try {
            peer = new Peer(); 
            peer.on('open', (id) => {
                document.getElementById('myId').innerText = id;
                log(`å·²å–å¾—é€£ç·š ID: ${id}`);
            });
            peer.on('error', (err) => {
                log(`é€£ç·šéŒ¯èª¤: ${err.type}`);
                alert("é€£ç·šä¼ºæœå™¨ç™¼ç”ŸéŒ¯èª¤: " + err.type);
            });

            // ç›£è½é€£ç·š (å°æ’­é‚è¼¯)
            peer.on('connection', (conn) => {
                conn.on('data', (data) => {
                    handleIncomingData(data, conn);
                });

                conn.on('close', () => {
                    guestConnections = guestConnections.filter(c => c.peer !== conn.peer);
                    log(`è§€çœ¾ ${conn.peer} å·²é›¢é–‹`);
                });

                log(`æ”¶åˆ°ä¾†è‡ª ${conn.peer} çš„è«‹æ±‚ä¿¡è™Ÿ...`);
                pendingConnection = conn;
                document.getElementById('callerIdDisplay').innerText = conn.peer;
                document.getElementById('callModal').classList.remove('hidden');
            });

            // ç›£è½é€šè©± (è§€çœ¾é‚è¼¯)
            peer.on('call', (call) => {
                log("æ”¶åˆ°å°æ’­çš„ç•«é¢å‚³é€...");
                call.answer(); 
                call.on('stream', (remoteStream) => {
                    handleRemoteStream(remoteStream);
                });
            });

        } catch (e) {
            log("PeerJS åˆå§‹åŒ–å¤±æ•—");
        }
    }
    initPeer();

    // è™•ç†æ”¶åˆ°çš„è³‡æ–™
    function handleIncomingData(data, conn) {
        if (data.type === 'vote') {
            // å°æ’­æ”¶åˆ°æŠ•ç¥¨ (data.val æ˜¯ 1~5)
            // è½‰ç‚ºé™£åˆ—ç´¢å¼• (0~4)
            const idx = data.val - 1;
            if (idx >= 0 && idx < 5) {
                voteData[idx]++;
                log(`æ”¶åˆ° ${conn.peer} çµ¦çš„ ${data.val} æ˜Ÿè©•åƒ¹`);
                updateVoteUI();
                broadcastData({type: 'update', data: voteData}); // åŒæ­¥çµ¦æ‰€æœ‰äºº
            }
        } else if (data.type === 'update') {
            // è§€çœ¾æ”¶åˆ°æ›´æ–°
            voteData = data.data;
            updateVoteUI();
        }
    }

    // å»£æ’­è³‡æ–™çµ¦æ‰€æœ‰è§€çœ¾
    function broadcastData(msg) {
        guestConnections.forEach(c => {
            if(c.open) c.send(msg);
        });
    }

    // æ¨¡å¼åˆ‡æ›
    function switchMode(m) {
        document.getElementById('hostPanel').classList.toggle('hidden', m !== 'host');
        document.getElementById('guestPanel').classList.toggle('hidden', m !== 'guest');
        document.getElementById('tab-h').classList.toggle('active', m === 'host');
        document.getElementById('tab-g').classList.toggle('active', m === 'guest');
        
        const video = document.getElementById('vDisplay');
        video.muted = (m === 'host'); // å°æ’­è‡ªå·±éœéŸ³
        
        document.getElementById('playOverlay').classList.add('hidden');
        log(`åˆ‡æ›æ¨¡å¼è‡³: ${m === 'host' ? 'å°æ’­ç«¯' : 'è§€çœ¾ç«¯'}`);
    }

    // å°æ’­ç«¯ï¼šé–‹å•Ÿé¡é ­
    async function initHost() {
        try {
            log("æ­£åœ¨è«‹æ±‚é¡é ­æ¬Šé™...");
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            const video = document.getElementById('vDisplay');
            video.srcObject = localStream;
            
            setStatus("ç›´æ’­æº–å‚™å°±ç·’", "live");
            document.getElementById('recBtn').disabled = false;
            document.getElementById('camBtn').innerText = "é¡é ­å·²é–‹å•Ÿ";
            document.getElementById('videoContainer').classList.add('active');
            log("é¡é ­é–‹å•ŸæˆåŠŸï¼Œç­‰å¾…è§€çœ¾...");

        } catch (e) { 
            alert("ç„¡æ³•å–å¾—é¡é ­æ¬Šé™ ğŸ¥\nè«‹ç¢ºèªç€è¦½å™¨å…è¨±å­˜å–ã€‚"); 
            log("é¡é ­æ¬Šé™è¢«æ‹’çµ•");
        }
    }

    // è™•ç†é€£ç·šæ±ºå®š
    function handleCallDecision(accept) {
        const modal = document.getElementById('callModal');
        modal.classList.add('hidden');
        
        if (!pendingConnection) return;
        const guestId = pendingConnection.peer;

        if (accept) {
            log(`å·²å…è¨±ï¼Œæ­£åœ¨åå‘å‚³é€ç•«é¢çµ¦ ${guestId}...`);
            guestConnections.push(pendingConnection);
            if(pendingConnection.open) {
                pendingConnection.send({type: 'update', data: voteData});
            }
            const call = peer.call(guestId, localStream);
            call.on('close', () => log("è§€çœ¾è¦–è¨Šæ–·ç·š"));
            setStatus("â— ç›´æ’­ä¸­ (è¨Šè™Ÿå‚³é€ä¸­)", "rec");
        } else {
            log(`å·²æ‹’çµ• ${guestId}`);
            pendingConnection.close();
        }
        pendingConnection = null;
    }

    // è§€çœ¾ç«¯ï¼šé€£ç·šè«‹æ±‚
    function connectToHost() {
        const id = document.getElementById('targetId').value.trim();
        const pw = document.getElementById('pKey').value;

        if (pw !== "2026media") return alert("ğŸ” å¯†ç¢¼éŒ¯èª¤ï¼(æç¤ºï¼š2026media)");
        if (!id) return alert("è«‹è¼¸å…¥å°æ’­ ID");

        setStatus("è«‹æ±‚é€£ç·šä¸­...", "normal");
        log(`æ­£åœ¨å‚³é€è¨Šè™Ÿçµ¦å°æ’­ ID: ${id}`);
        
        const conn = peer.connect(id);
        hostConn = conn;
        
        conn.on('open', () => {
            log("è¨Šè™Ÿå·²é€é”ï¼Œç­‰å¾…å°æ’­ç¢ºèª...");
            setStatus("ç­‰å¾…å°æ’­æ¥å—...", "normal");
        });

        conn.on('data', (data) => {
            handleIncomingData(data, conn);
        });

        conn.on('close', () => {
            log("è¨Šè™Ÿé€£ç·šä¸­æ–·");
            hostConn = null;
        });

        conn.on('error', (err) => {
            log("é€£ç·šå¤±æ•—: " + err);
            setStatus("æ‰¾ä¸åˆ°å°æ’­ ID", "normal");
        });
    }

    function handleRemoteStream(remoteStream) {
        const video = document.getElementById('vDisplay');
        video.srcObject = remoteStream;
        document.getElementById('videoContainer').classList.add('active');
        log("å·²æ¥æ”¶å½±åƒè¨Šè™Ÿï¼");
        setStatus("â— ç›´æ’­æ”¶çœ‹ä¸­", "live");

        const playPromise = video.play();
        if (playPromise !== undefined) {
            playPromise.then(() => {
                log("è‡ªå‹•æ’­æ”¾æˆåŠŸ");
            }).catch(error => {
                log("è‡ªå‹•æ’­æ”¾è¢«é˜»æ“‹ï¼Œé¡¯ç¤ºæ’­æ”¾æŒ‰éˆ•");
                document.getElementById('playOverlay').classList.remove('hidden');
            });
        }
    }

    function forcePlay() {
        const video = document.getElementById('vDisplay');
        video.play();
        document.getElementById('playOverlay').classList.add('hidden');
        log("ä½¿ç”¨è€…è§¸ç™¼æ’­æ”¾");
    }

    function toggleRecording() {
        const btn = document.getElementById('recBtn');
        const timerDisplay = document.getElementById('recTimer');
        
        if (btn.innerText.includes("é–‹å§‹")) {
            chunks = [];
            try { mediaRecorder = new MediaRecorder(localStream); } 
            catch (e) { return alert("ç€è¦½å™¨ä¸æ”¯æ´éŒ„å½±"); }

            mediaRecorder.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `FutureVision_Live_${Date.now()}.webm`; a.click();
            };
            
            mediaRecorder.start();
            btn.innerText = "â¹ åœæ­¢ä¸¦ä¸‹è¼‰";
            btn.style.background = "#333";
            timerDisplay.style.display = "inline";
            
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const diff = Math.floor((Date.now() - startTime) / 1000);
                const m = Math.floor(diff / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                timerDisplay.innerText = `REC ${m}:${s}`;
            }, 1000);
        } else {
            mediaRecorder.stop();
            clearInterval(timerInterval);
            btn.innerText = "2. é–‹å§‹éŒ„å½±";
            btn.style.background = "linear-gradient(135deg, #ff0055, #ff4d4d)";
            timerDisplay.style.display = "none";
        }
    }

    // è©•åˆ†ç³»çµ±é‚è¼¯
    function updateVoteUI() {
        // è¨ˆç®—ç¸½ç¥¨æ•¸
        const total = voteData.reduce((a, b) => a + b, 0);
        document.getElementById('totalVotes').innerText = total;

        // è¨ˆç®—åŠ æ¬Šå¹³å‡ (1*ç¥¨æ•¸ + 2*ç¥¨æ•¸ ... / ç¸½ç¥¨æ•¸)
        let weightedSum = 0;
        for (let i = 0; i < 5; i++) {
            weightedSum += voteData[i] * (i + 1);
        }

        const avg = total === 0 ? 0 : (weightedSum / total).toFixed(1);
        document.getElementById('avgScore').innerText = avg;
    }

    // æ˜Ÿæ˜Ÿäº’å‹•æ•ˆæœï¼šæ»‘é¼ ç§»å…¥æ™‚äº®èµ·å‰é¢çš„æ˜Ÿæ˜Ÿ
    function highlightStars(count) {
        const stars = document.querySelectorAll('.star-btn');
        const labels = ["åŠ æ²¹", "æ™®é€š", "é‚„è¡Œ", "ä¸éŒ¯", "è¶…è®šï¼"];
        const feedback = document.getElementById('vote-feedback');
        
        stars.forEach((star, index) => {
            if (index < count) {
                star.style.color = 'var(--gold)';
                star.style.textShadow = '0 0 10px var(--gold)';
                star.style.transform = 'scale(1.1)';
            } else {
                star.style.color = '#444';
                star.style.textShadow = 'none';
                star.style.transform = 'scale(1)';
            }
        });
        
        // é¡¯ç¤ºå°æ‡‰æ–‡å­—
        feedback.innerText = `${count} é¡†æ˜Ÿ - ${labels[count-1]}`;
        feedback.style.opacity = '1';
    }

    // æ»‘é¼ ç§»å‡ºæ™‚é‡ç½® (æ¢å¾©æˆæœªé¸ç‹€æ…‹)
    function resetStars() {
        const stars = document.querySelectorAll('.star-btn');
        const feedback = document.getElementById('vote-feedback');
        
        stars.forEach(star => {
            star.style.color = '#444';
            star.style.textShadow = 'none';
            star.style.transform = 'scale(1)';
        });
        
        feedback.style.opacity = '0';
    }

    function vote(starVal) {
        const isHost = document.getElementById('tab-h').classList.contains('active');
        
        // é¡¯ç¤ºå·²é€å‡ºå›é¥‹
        const feedback = document.getElementById('vote-feedback');
        feedback.innerText = `å·²é€å‡º ${starVal} æ˜Ÿå¥½è©•ï¼`;
        feedback.style.opacity = '1';
        setTimeout(() => { if(feedback.innerText.includes('å·²é€å‡º')) feedback.style.opacity = '0'; }, 1500);

        if (isHost) {
            // å°æ’­æŠ•ç¥¨ (æ¸¬è©¦ç”¨)
            voteData[starVal-1]++;
            updateVoteUI();
            broadcastData({type: 'update', data: voteData});
            log(`å°æ’­çµ¦äºˆè©•åƒ¹: ${starVal} æ˜Ÿ`);
        } else {
            // è§€çœ¾æŠ•ç¥¨
            if (hostConn && hostConn.open) {
                hostConn.send({type: 'vote', val: starVal});
                log(`å·²é€å‡ºè©•åƒ¹: ${starVal} æ˜Ÿ`);
            } else {
                alert("è«‹å…ˆé€£ç·šè‡³å°æ’­æ‰èƒ½è©•åˆ†ï¼");
            }
        }
    }

    function resetVote() { 
        const isHost = document.getElementById('tab-h').classList.contains('active');
        if (!isHost) return alert("æ¬Šé™ä¸è¶³ï¼šåªæœ‰å°æ’­å¯ä»¥é‡ç½®çµ±è¨ˆæ•¸æ“šã€‚");

        // é‡ç½®ç‚º 0
        voteData = [0, 0, 0, 0, 0]; 
        updateVoteUI(); 
        broadcastData({type: 'update', data: voteData});
        log("è©•åˆ†æ•¸æ“šå·²é‡ç½®ä¸¦åŒæ­¥");
    }

    // ç³»çµ±èªªæ˜ Modal æ§åˆ¶
    function showInfo() {
        document.getElementById('infoModal').classList.remove('hidden');
    }
    function closeInfo() {
        document.getElementById('infoModal').classList.add('hidden');
    }

    // å·¥å…·
    function setStatus(text, type) {
        const dot = document.getElementById('statusDot');
        document.getElementById('statusText').innerText = text;
        dot.className = 'dot'; 
        if (type === 'live') dot.classList.add('live');
        if (type === 'rec') dot.classList.add('rec');
    }

    function log(msg) {
        const box = document.getElementById('logs');
        const time = new Date().toLocaleTimeString();
        box.innerHTML += `> [${time}] ${msg}<br>`;
        box.scrollTop = box.scrollHeight;
    }
</script>

</body>
</html>
