<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>é¬¥åœ°ä¸» å·”å³°ç«¶æŠ€å¤§å¸«ç‰ˆ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">

<style>
:root {
    --gold: #f0c040;
    --gold-light: #fde68a;
    --gold-dark: #b8860b;
    --red: #c0392b;
    --red-deep: #7b1a1a;
    --red-bright: #ef4444;
    --green-felt: #1a4a2e;
    --green-dark: #0f2d1c;
    --black-card: #1a1a2e;
    --white-card: #fdfaf5;
    --table-bg: #16391f;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
    font-family: 'Noto Serif TC', serif;
    background: var(--green-dark);
    color: #f0e6c8;
    text-align: center;
    overflow-x: hidden;
    padding-bottom: 90px;
    min-height: 100vh;
    background-image:
        radial-gradient(ellipse at 20% 20%, rgba(139,69,19,0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(139,69,19,0.15) 0%, transparent 50%),
        repeating-linear-gradient(0deg, transparent, transparent 40px, rgba(255,255,255,0.012) 40px, rgba(255,255,255,0.012) 41px),
        repeating-linear-gradient(90deg, transparent, transparent 40px, rgba(255,255,255,0.012) 40px, rgba(255,255,255,0.012) 41px);
}

.tension-bg {
    background-color: #300000 !important;
    animation: alarm 1.5s infinite;
}
@keyframes alarm { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.15) saturate(1.3); } }

/* ===== é ‚éƒ¨é¢æ¿ ===== */
.stats-panel {
    background: linear-gradient(135deg, rgba(0,0,0,0.7), rgba(20,10,0,0.8));
    border-radius: 0 0 16px 16px;
    padding: 10px 16px 12px;
    margin: 0 auto 6px;
    width: 100%;
    max-width: 640px;
    border: 1px solid rgba(240,192,64,0.3);
    border-top: none;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5), inset 0 1px 0 rgba(240,192,64,0.2);
}

.rank-badge {
    font-size: 13px;
    color: var(--gold);
    font-weight: 700;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(240,192,64,0.2);
}

.win-streak {
    background: linear-gradient(to right, #f97316, #dc2626);
    padding: 3px 12px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 900;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 8px rgba(249,115,22,0.4);
    animation: pulse-streak 1.5s infinite;
}
@keyframes pulse-streak { 0%, 100% { box-shadow: 0 2px 8px rgba(249,115,22,0.4); } 50% { box-shadow: 0 2px 20px rgba(249,115,22,0.8); } }

.daily-quest-banner {
    font-size: 12px;
    color: #c084fc;
    font-weight: 700;
    margin-bottom: 8px;
    text-shadow: 0 0 10px rgba(192,132,252,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 6px;
    letter-spacing: 0.3px;
}
.quest-done { color: #4ade80 !important; text-shadow: 0 0 10px rgba(74,222,128,0.6) !important; }

#scoreDisplay {
    display: flex;
    justify-content: space-around;
    font-size: 12px;
    gap: 4px;
}

.score-item {
    background: rgba(0,0,0,0.3);
    border-radius: 8px;
    padding: 4px 10px;
    flex: 1;
    border: 1px solid rgba(240,192,64,0.15);
}

.score-label { color: #a8956a; font-size: 10px; margin-bottom: 2px; }
.score-value { font-weight: 900; font-size: 14px; }

/* ===== æ¨™é¡Œ ===== */
.game-title {
    font-family: 'Cinzel Decorative', serif;
    font-size: 16px;
    color: var(--gold);
    text-shadow: 0 0 20px rgba(240,192,64,0.6), 2px 2px 0 rgba(0,0,0,0.8);
    margin: 8px 0 4px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    letter-spacing: 1px;
}

.rules-btn {
    background: transparent;
    color: var(--gold);
    padding: 2px 10px;
    font-size: 10px;
    border-radius: 6px;
    border: 1px solid var(--gold);
    cursor: pointer;
    font-family: 'Noto Serif TC', serif;
    transition: all 0.2s;
}
.rules-btn:hover { background: var(--gold); color: #1a0a00; }

#info {
    margin: 4px auto;
    font-size: 14px;
    font-weight: 700;
    color: var(--gold-light);
    height: 22px;
    text-shadow: 0 0 12px rgba(253,230,138,0.5);
    letter-spacing: 0.3px;
}

/* ===== åº•ç‰Œå€ ===== */
.hole-cards-wrapper {
    margin: 8px auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
}

.hole-cards-label {
    font-size: 11px;
    color: rgba(240,192,64,0.6);
    letter-spacing: 1px;
    text-transform: uppercase;
}

.hole-cards {
    display: flex;
    justify-content: center;
    gap: 8px;
    height: 70px;
}

/* ===== å€æ•¸å¾½ç«  ===== */
.multiplier-badge {
    position: fixed;
    top: 140px;
    right: 12px;
    background: linear-gradient(135deg, #dc2626, #7f1d1d);
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 900;
    z-index: 60;
    border: 1px solid rgba(255,100,100,0.5);
    box-shadow: 0 2px 12px rgba(220,38,38,0.5);
    animation: pulse-badge 1s infinite;
    display: none;
}
@keyframes pulse-badge { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.06); } }

/* å€æ•¸çˆ†ç‚¸æ•ˆæœ */
.multiplier-burst {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 72px;
    font-weight: 900;
    color: var(--gold);
    text-shadow: 0 0 30px rgba(240,192,64,0.9);
    z-index: 500;
    pointer-events: none;
    animation: burst-anim 1.2s ease-out forwards;
}
@keyframes burst-anim {
    0% { opacity: 1; transform: translate(-50%, -50%) scale(0.3); }
    40% { opacity: 1; transform: translate(-50%, -50%) scale(1.3); }
    100% { opacity: 0; transform: translate(-50%, -70%) scale(0.8); }
}

/* ===== å°æ‰‹ HUD ===== */
.opponents-hud {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 92%;
    max-width: 640px;
    margin: 6px auto;
    gap: 8px;
}

.table-center-icon {
    font-size: 28px;
    opacity: 0.3;
    flex: 0 0 auto;
}

.opp-box {
    background: linear-gradient(135deg, rgba(0,0,0,0.5), rgba(10,20,10,0.6));
    border: 1px solid rgba(100,120,100,0.4);
    border-radius: 14px;
    padding: 10px 12px;
    flex: 1;
    position: relative;
    transition: all 0.3s;
    overflow: hidden;
}

.opp-box::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: transparent;
    transition: background 0.3s;
}

.opp-box.active {
    border-color: var(--gold);
    box-shadow: 0 0 20px rgba(240,192,64,0.3);
}
.opp-box.active::before {
    background: linear-gradient(to right, transparent, var(--gold), transparent);
}

.opp-avatar { font-size: 26px; margin-bottom: 3px; }
.opp-name { font-size: 11px; color: #a0a0a0; margin-bottom: 4px; letter-spacing: 0.3px; }
.opp-count {
    font-size: 22px;
    font-weight: 900;
    color: var(--white-card);
    font-variant-numeric: tabular-nums;
}
.opp-count-label { font-size: 10px; color: #888; }

.landlord-icon {
    position: absolute;
    top: -8px;
    right: -8px;
    font-size: 22px;
    display: none;
    animation: spin-in 0.4s ease;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.8));
}
.is-landlord .landlord-icon { display: block; animation: pulse 1s infinite; }

.thinking-dots {
    display: none;
    gap: 3px;
    justify-content: center;
    margin-top: 3px;
}
.opp-box.active .thinking-dots { display: flex; }
.thinking-dots span {
    width: 5px; height: 5px;
    background: var(--gold);
    border-radius: 50%;
    animation: dot-bounce 1.2s infinite;
}
.thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
.thinking-dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes dot-bounce { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; } 40% { transform: scale(1); opacity: 1; } }

/* ===== éŠæˆ²æ¡Œé¢ ===== */
#table {
    min-height: 120px;
    margin: 6px auto;
    background:
        radial-gradient(ellipse at center, rgba(26,74,46,0.8), rgba(10,35,20,0.9)),
        repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.01) 10px, rgba(255,255,255,0.01) 11px);
    border-radius: 20px;
    width: 92%;
    max-width: 640px;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 15px;
    flex-wrap: wrap;
    border: 1px solid rgba(240,192,64,0.15);
    box-shadow: inset 0 0 30px rgba(0,0,0,0.4), 0 0 0 4px rgba(0,0,0,0.3);
    position: relative;
}

.table-empty-hint {
    color: rgba(240,192,64,0.25);
    font-size: 13px;
    letter-spacing: 2px;
    position: absolute;
    pointer-events: none;
}

/* ===== æ‰‹ç‰Œå€ ===== */
.hand-wrapper {
    width: 100%;
    max-width: 800px;
    margin: 0 auto;
    overflow: hidden;
}

.hand {
    display: flex;
    justify-content: flex-start;
    overflow-x: auto;
    padding: 18px 16px 24px 16px;
    scrollbar-width: none;
    -ms-overflow-style: none;
}
.hand::-webkit-scrollbar { display: none; }

/* ===== ç‰Œé¢æ¨£å¼ ===== */
.card {
    flex: 0 0 auto;
    width: 60px;
    height: 88px;
    background: var(--white-card);
    border-radius: 10px;
    margin: 0 -13px;
    border: 1px solid #e0d8cc;
    position: relative;
    transition: transform 0.18s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.18s ease;
    overflow: hidden;
    color: #111;
    user-select: none;
    cursor: pointer;
    box-shadow: -3px 0 10px rgba(0,0,0,0.5), 0 2px 4px rgba(0,0,0,0.3);
}
.card:first-child { margin-left: 0; }
.card:hover { transform: translateY(-14px) rotate(-1deg); z-index: 10; box-shadow: -3px 0 10px rgba(0,0,0,0.3), 0 14px 24px rgba(0,0,0,0.5); }
.card.selected {
    transform: translateY(-24px) scale(1.04);
    border: 2px solid var(--gold);
    box-shadow: 0 12px 28px rgba(0,0,0,0.7), 0 0 0 1px var(--gold-dark), 0 0 20px rgba(240,192,64,0.3);
    z-index: 100 !important;
}

/* ç‰Œé¢èŠ±ç´‹èƒŒæ™¯ */
.card::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 50%);
    pointer-events: none;
    border-radius: 9px;
}

.corner { position: absolute; font-size: 13px; font-weight: 900; z-index: 2; line-height: 1.1; text-align: center; }
.corner-suit { font-size: 10px; }
.top-left { top: 4px; left: 5px; }
.bottom-right { bottom: 4px; right: 5px; transform: rotate(180deg); }
.center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 26px; z-index: 2; }

/* ç´…é»‘èŠ±è‰² */
.suit-heart, .suit-diamond { color: #cc1111; }
.suit-spade, .suit-club { color: #111; }

/* å°ç‹å¤§ç‹ */
.full-cover { position: absolute; width: 100%; height: 100%; top: 0; left: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; box-sizing: border-box; }
.joker-bg-red {
    background: linear-gradient(145deg, #dc2626, #7f1d1d);
    color: #fff;
    border: 2px solid var(--gold);
}
.joker-bg-black {
    background: linear-gradient(145deg, #374151, #111827);
    color: #fff;
    border: 2px solid #6b7280;
}
.joker-icon { font-size: 20px; margin-bottom: 1px; }
.joker-text { writing-mode: vertical-rl; font-size: 17px; font-weight: 900; letter-spacing: 3px; text-shadow: 2px 2px 4px rgba(0,0,0,0.6); }

/* åº•ç‰Œä¸­çš„å°ç‰Œ */
.hole-card {
    width: 44px; height: 66px;
    background: var(--white-card);
    border-radius: 8px;
    border: 1px solid #ddd;
    box-shadow: 0 3px 10px rgba(0,0,0,0.4);
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 900;
    position: relative; overflow: hidden;
    animation: flip-in 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) both;
}
.hole-card.hidden {
    background: repeating-linear-gradient(45deg, #1e4a8a, #1e4a8a 4px, #1e6ab4 4px, #1e6ab4 8px);
    color: transparent;
}

@keyframes flip-in {
    from { transform: rotateY(90deg) scale(0.8); opacity: 0; }
    to { transform: rotateY(0deg) scale(1); opacity: 1; }
}
.hole-card:nth-child(2) { animation-delay: 0.1s; }
.hole-card:nth-child(3) { animation-delay: 0.2s; }

/* ===== æ§åˆ¶å™¨ ===== */
.controls {
    position: fixed;
    bottom: 0; left: 0;
    width: 100%;
    background: linear-gradient(to top, rgba(10,25,15,0.98), rgba(15,35,20,0.95));
    padding: 10px 0 14px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.6), 0 -1px 0 rgba(240,192,64,0.2);
    z-index: 50;
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
}

button {
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 900;
    border-radius: 24px;
    border: none;
    cursor: pointer;
    transition: all 0.18s cubic-bezier(0.34, 1.56, 0.64, 1);
    font-family: 'Noto Serif TC', serif;
    letter-spacing: 0.5px;
}
button:active { transform: scale(0.95) !important; }

.btn-play {
    background: linear-gradient(135deg, var(--gold), #d4a017);
    color: #1a0a00;
    box-shadow: 0 4px 15px rgba(240,192,64,0.4);
    padding: 10px 32px;
    font-size: 15px;
    border: 1px solid rgba(255,220,100,0.5);
}
.btn-play:hover { box-shadow: 0 6px 25px rgba(240,192,64,0.6); transform: translateY(-2px); }

.btn-pass {
    background: rgba(80,80,80,0.6);
    color: #ccc;
    border: 1px solid rgba(150,150,150,0.3);
}
.btn-pass:hover { background: rgba(100,100,100,0.7); }

.btn-bid {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    color: white;
    border: 1px solid rgba(96,165,250,0.4);
    box-shadow: 0 3px 10px rgba(37,99,235,0.4);
}
.btn-bid:hover { box-shadow: 0 5px 18px rgba(37,99,235,0.6); transform: translateY(-2px); }

.btn-hint {
    background: linear-gradient(135deg, #7c3aed, #6d28d9);
    color: white;
    border: 1px solid rgba(167,139,250,0.4);
    box-shadow: 0 3px 10px rgba(124,58,237,0.4);
}
.btn-hint:hover { box-shadow: 0 5px 18px rgba(124,58,237,0.6); transform: translateY(-2px); }

/* ===== å½ˆçª— ===== */
.modal-overlay {
    position: fixed; top:0; left:0;
    width:100%; height:100%;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(6px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: linear-gradient(145deg, #1c1008, #2a1810);
    color: #f0e6c8;
    padding: 28px 24px;
    border-radius: 20px;
    width: 88%;
    max-width: 420px;
    max-height: 85vh;
    overflow-y: auto;
    border: 1px solid rgba(240,192,64,0.4);
    box-shadow: 0 0 60px rgba(240,192,64,0.15), 0 20px 60px rgba(0,0,0,0.8);
    animation: modal-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}
@keyframes modal-in { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

.modal-title-win { color: var(--gold); font-size: 26px; font-weight: 900; margin-bottom: 16px; text-shadow: 0 0 20px rgba(240,192,64,0.5); }
.modal-title-lose { color: #f87171; font-size: 24px; font-weight: 900; margin-bottom: 16px; }

.result-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    border-radius: 10px;
    margin-bottom: 6px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.08);
}
.result-row.player-row {
    background: rgba(240,192,64,0.1);
    border-color: rgba(240,192,64,0.3);
}
.result-change { font-weight: 900; font-size: 16px; }

.btn-restart {
    background: linear-gradient(135deg, var(--gold), #d4a017);
    color: #1a0a00;
    width: 100%;
    padding: 13px;
    margin-top: 16px;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 900;
    box-shadow: 0 4px 15px rgba(240,192,64,0.3);
    transition: all 0.2s;
}
.btn-restart:hover { box-shadow: 0 6px 25px rgba(240,192,64,0.5); }
.btn-reset {
    background: rgba(80,80,80,0.4);
    color: #aaa;
    border: 1px solid rgba(150,150,150,0.2);
    width: 100%;
    padding: 10px;
    margin-top: 8px;
    border-radius: 10px;
    font-size: 13px;
}

.rules-text { text-align: left; font-size: 13px; color: #c8b88a; line-height: 1.9; }
.rules-text b { color: var(--gold); }
.rules-section { margin-bottom: 10px; padding: 10px 12px; background: rgba(255,255,255,0.04); border-radius: 10px; border-left: 3px solid var(--gold); }

/* ===== å‹•ç•« ===== */
@keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.12); } }
@keyframes shake { 0%, 100% { transform: translate(0) rotate(0deg); } 10%, 30%, 50%, 70%, 90% { transform: translate(-5px,-2px) rotate(-1deg); } 20%, 40%, 60%, 80% { transform: translate(5px,2px) rotate(1deg); } }
.shake-screen { animation: shake 0.45s cubic-bezier(0.36, 0.07, 0.19, 0.97) both; }

/* å½©å¸¶ */
#confetti-container { position: fixed; top:0; left:0; width:100vw; height:100vh; pointer-events:none; z-index:999; display:none; overflow:hidden; }
.confetti-piece {
    position: absolute; top: -20px;
    width: 10px; height: 16px;
    animation: confetti-fall linear forwards;
    border-radius: 3px;
    opacity: 0.9;
}
@keyframes confetti-fall { to { transform: translateY(110vh) rotate(720deg); } }

/* å‹åˆ©å…‰æ•ˆ */
.win-glow {
    position: fixed; top:0; left:0; right:0; bottom:0;
    background: radial-gradient(ellipse at center, rgba(240,192,64,0.15), transparent 70%);
    pointer-events: none;
    z-index: 998;
    animation: win-glow-anim 2s ease-out forwards;
}
@keyframes win-glow-anim { 0% { opacity: 1; } 100% { opacity: 0; } }

/* ç‰ˆæ¬Š */
.copyright { font-size: 10px; color: rgba(240,192,64,0.2); text-align: center; padding: 8px 0 4px; letter-spacing: 1px; }

@media (max-width: 600px) {
    .card { width: 46px; height: 70px; margin: 0 -12px; }
    .corner { font-size: 11px; } .center { font-size: 20px; }
    .joker-text { font-size: 14px; } .joker-icon { font-size: 16px; }
    button { padding: 9px 14px; font-size: 13px; }
    .btn-play { padding: 9px 24px; }
    .game-title { font-size: 13px; }
    .opp-count { font-size: 20px; }
}
</style>
</head>
<body>

<div id="confetti-container"></div>

<div class="stats-panel">
    <div class="rank-badge">
        <span id="playerRank">ğŸ–ï¸ è¼‰å…¥ä¸­...</span>
        <span id="winStreakBadge" class="win-streak" style="display:none;">ğŸ”¥ 0 é€£å‹</span>
    </div>
    <div id="dailyQuestBanner" class="daily-quest-banner">ğŸ¯ ä»Šæ—¥ä»»å‹™ï¼šè¼‰å…¥ä¸­...</div>
    <div id="scoreDisplay"></div>
</div>

<div class="game-title">
    ğŸƒ é¬¥åœ°ä¸» å·”å³°å¤§å¸«ç‰ˆ
    <button class="rules-btn" onclick="document.getElementById('rulesModal').style.display='flex'">è¦å‰‡</button>
</div>
<div id="info">ç³»çµ±æº–å‚™ä¸­...</div>

<div class="hole-cards-wrapper">
    <div class="hole-cards-label">åº• ç‰Œ</div>
    <div class="hole-cards" id="holeCardsArea"></div>
</div>

<div id="multiplierBadge" class="multiplier-badge">x1</div>

<div id="opponentsHUD" class="opponents-hud"></div>
<div id="table"><span class="table-empty-hint" id="tableEmptyHint">å‡ºç‰Œå€</span></div>

<div class="hand-wrapper">
    <div id="player" class="hand"></div>
</div>

<div class="copyright">&copy; 2026 LinWei's Doudizhu Â· Enhanced Edition</div>

<div class="controls" id="controlPanel">
    <button class="btn-bid" onclick="playerBid(1)" id="btnBid1" style="display:none;">å« 1 åˆ†</button>
    <button class="btn-bid" onclick="playerBid(2)" id="btnBid2" style="display:none;">å« 2 åˆ†</button>
    <button class="btn-bid" onclick="playerBid(3)" id="btnBid3" style="display:none;">å« 3 åˆ†</button>
    <button class="btn-pass" onclick="playerBid(0)" id="btnNoBid" style="display:none;">ä¸å«</button>
    
    <button class="btn-hint" onclick="hint()" id="btnHint" style="display:none;">ğŸ’¡ æç¤º</button>
    <button class="btn-play" onclick="play()" id="btnPlay" style="display:none;">å‡º ç‰Œ</button>
    <button class="btn-pass" onclick="pass()" id="btnPass" style="display:none;">ä¸ å‡º</button>
</div>

<!-- çµç®—å½ˆçª— -->
<div id="scoreModal" class="modal-overlay">
    <div class="modal-content">
        <div id="modalTitle" class="modal-title-win">å±€æ•¸çµç®—</div>
        <div id="modalScores" style="margin-top:12px; line-height:1.8;"></div>
        <button class="btn-restart" onclick="location.reload()">â–¶ ç¹¼çºŒä¸‹ä¸€å±€</button>
        <button class="btn-reset" onclick="localStorage.removeItem('doudizhu_stats'); location.reload();">é‡ç½®æ‰€æœ‰åˆ†æ•¸</button>
    </div>
</div>

<!-- è¦å‰‡å½ˆçª— -->
<div id="rulesModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title-win" style="font-size:20px;">ğŸ“œ éŠæˆ²è¦å‰‡</div>
        <div class="rules-text">
            <div class="rules-section"><b>ğŸ’¡ æ™ºèƒ½æç¤ºï¼š</b>é»æ“Šæç¤ºæŒ‰éˆ•ï¼Œç³»çµ±è‡ªå‹•æŒ‘é¸æœ€ä½³ç‰Œå‹ã€‚è‹¥ç„¡ç‰Œå¯å£“ï¼Œé¡¯ç¤ºã€Œè¦ä¸èµ·ã€ã€‚</div>
            <div class="rules-section"><b>ğŸ¯ æ¯æ—¥ä»»å‹™ï¼š</b>æ¯å¤©æŒ‡å®šä¸€ç¨®ç‰Œå‹ï¼ˆå¦‚é£›æ©Ÿï¼‰ã€‚æ‰“å‡ºä¸¦ç²å‹ï¼Œå‹åˆ†é¡å¤–<b>ç¿»å€</b>ï¼</div>
            <div class="rules-section"><b>ğŸ–ï¸ è·ç¨±ç³»çµ±ï¼š</b>ç´¯ç©ç©åˆ†æ™‰å‡éšç´šã€‚é€£å‹3å ´ä»¥ä¸Šï¼Œå‹åˆ†åŠ æˆ20%ã€‚</div>
            <div class="rules-section"><b>ğŸ¤– åœ°ç„AIï¼š</b>é›»è…¦å…·å‚™é ‚ç‰Œã€é˜²å®ˆèˆ‡ä¿é€éšŠå‹çš„æ¥µé™æ€ç¶­ï¼Œåœ°ä¸»ç€•å±æ™‚ç´…å…‰è­¦å ±äº®èµ·ã€‚</div>
            <div class="rules-section"><b>ğŸ’¥ ç¿»å€æ©Ÿåˆ¶ï¼š</b>ç‚¸å½ˆ/ç«ç®­ã€æ˜¥å¤©/åæ˜¥å¤©ï¼Œå€æ•¸å‡ä¹˜ä»¥2ã€‚</div>
        </div>
        <button class="btn-restart" onclick="document.getElementById('rulesModal').style.display='none'">æº–å‚™è¿æˆ° ï¼</button>
    </div>
</div>

<script>
/* ===== éŸ³æ•ˆ ===== */
const sndPlayCard = new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3');
const sndBomb = new Audio('https://assets.mixkit.co/active_storage/sfx/1690/1690-preview.mp3');
sndPlayCard.volume = 0.5; sndBomb.volume = 0.8;
function playSound(snd) { snd.currentTime = 0; snd.play().catch(e => {}); }

/* ===== åŸºç¤è¨­å®š ===== */
const suits = ["â™£", "â™¦", "â™¥", "â™ "];
const ranks = ["3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K", "A", "2"];
const power = { "3":3,"4":4,"5":5,"6":6,"7":7,"8":8,"9":9,"10":10,"J":11,"Q":12,"K":13,"A":14,"2":15,"BJ":16,"RJ":17 };

// AIè§’è‰²è¨­å®š
const aiNames = ["", { name: "é¾å“¥", avatar: "ğŸ‰" }, { name: "ç‹ç‹¸å¦¹", avatar: "ğŸ¦Š" }];
const playerAvatar = "ğŸ­";

let deck = [], players = [[], [], []], holeCards = [];
let current = 0, selected = [], last = null, consecutivePasses = 0, lastPlayer = -1;
let landlord = -1, baseScore = 0, gameMultiplier = 1;
let currentBid = 0, bidQueue = [], bidIndex = 0;
let landlordPlayCount = 0, farmerPlayCount = 0;

/* ===== çµ±è¨ˆèˆ‡ä»»å‹™ ===== */
let stats = JSON.parse(localStorage.getItem("doudizhu_stats")) || { totalScores:[0,0,0], currentWinStreak:0, maxWinStreak:0 };
let dailyQuestTarget = "", questAchievedThisRound = false;
const questPool = ["é †å­","é€£å°","ä¸‰å¸¶ä¸€å–®","ä¸‰å¸¶ä¸€å°","ç´”é£›æ©Ÿ","é£›æ©Ÿå¸¶å–®ç‰Œ","é£›æ©Ÿå¸¶å°å­","å››å¸¶äºŒå–®","å››å¸¶äºŒå°"];

function initDailyQuest() {
    let today = new Date().toDateString();
    let saved = JSON.parse(localStorage.getItem("doudizhu_daily_quest"));
    if (saved && saved.date === today) dailyQuestTarget = saved.target;
    else { dailyQuestTarget = questPool[Math.floor(Math.random() * questPool.length)]; localStorage.setItem("doudizhu_daily_quest", JSON.stringify({date: today, target: dailyQuestTarget})); }
    document.getElementById("dailyQuestBanner").innerHTML = `ğŸ¯ ä»Šæ—¥ä»»å‹™ï¼šæ‰“å‡ºã€${dailyQuestTarget}ã€‘å‹åˆ† x2`;
}

function getRankName(score) {
    if (score < 0) return "ğŸšï¸ è²§è¾²";
    if (score < 50) return "ğŸŒ¾ ä¸­è¾²";
    if (score < 200) return "ğŸ¡ å¯Œè¾²";
    if (score < 500) return "ğŸ‘‘ åœ°ä¸»";
    return "ğŸ’° è³­ç¥";
}

function updateStatsUI() {
    document.getElementById("playerRank").innerText = `ğŸ–ï¸ ${getRankName(stats.totalScores[0])}`;
    if (stats.currentWinStreak >= 2) {
        let b = document.getElementById("winStreakBadge");
        b.style.display = "inline-block";
        b.innerText = `ğŸ”¥ ${stats.currentWinStreak} é€£å‹`;
    } else { document.getElementById("winStreakBadge").style.display = "none"; }

    let html = "";
    const labels = ["ä½ ", "é¾å“¥", "ç‹ç‹¸å¦¹"];
    for (let i = 0; i < 3; i++) {
        let s = stats.totalScores[i];
        let cls = i === 0 ? "player-score" : "";
        html += `<div class="score-item ${cls}">
            <div class="score-label">${labels[i]}</div>
            <div class="score-value" style="color:${s>=0?'#4ade80':'#f87171'}">${s>=0?'+'+s:s}</div>
        </div>`;
    }
    document.getElementById("scoreDisplay").innerHTML = html;
}

function updateMultiplierUI() {
    let badge = document.getElementById("multiplierBadge");
    if (gameMultiplier > 1) {
        badge.style.display = "inline-block";
        badge.innerText = `å€æ•¸ Ã—${gameMultiplier}`;
    }
}

function showMultiplierBurst(text) {
    let el = document.createElement('div');
    el.className = 'multiplier-burst';
    el.textContent = text;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 1200);
}

function checkTension() {
    if (landlord !== -1 && players[landlord].length > 0 && players[landlord].length <= 3)
        document.body.classList.add("tension-bg");
    else
        document.body.classList.remove("tension-bg");
}

/* ===== æ¸²æŸ“ ===== */
function renderHoleCards(reveal = false) {
    let html = "";
    if (!reveal) {
        for (let i = 0; i < 3; i++) html += `<div class="hole-card hidden"></div>`;
    } else {
        holeCards.forEach(c => {
            if (c.isJoker) {
                let isRed = c.rank === "RJ";
                html += `<div class="hole-card ${isRed ? 'joker-bg-red' : 'joker-bg-black'}" style="display:flex;flex-direction:column;align-items:center;justify-content:center;">
                    <span style="font-size:16px">${isRed?'ğŸ‘‘':'ğŸƒ'}</span>
                    <span style="font-size:11px;font-weight:900;color:#fff;">${isRed?'å¤§ç‹':'å°ç‹'}</span>
                </div>`;
            } else {
                let suitClass = (c.suit==='â™¥'||c.suit==='â™¦') ? 'suit-heart' : 'suit-spade';
                html += `<div class="hole-card">
                    <div style="display:flex;flex-direction:column;align-items:center;">
                        <span class="${suitClass}" style="font-weight:900;font-size:13px;">${c.rank}</span>
                        <span class="${suitClass}" style="font-size:14px;">${c.suit}</span>
                    </div>
                </div>`;
            }
        });
    }
    document.getElementById("holeCardsArea").innerHTML = html;
}

function renderOpponents() {
    let hud = document.getElementById("opponentsHUD");
    hud.innerHTML = "";
    for (let i = 1; i <= 2; i++) {
        let isActive = current === i ? "active" : "";
        let isLandlordClass = landlord === i ? "is-landlord" : "";
        let ai = aiNames[i];
        hud.innerHTML += `
        <div class="opp-box ${isActive} ${isLandlordClass}">
            <div class="landlord-icon">ğŸ§‘â€ğŸŒ¾</div>
            <div class="opp-avatar">${ai.avatar}</div>
            <div class="opp-name">${ai.name}</div>
            <div class="opp-count">${players[i].length}<span class="opp-count-label"> å¼µ</span></div>
            <div class="thinking-dots"><span></span><span></span><span></span></div>
        </div>`;
    }
    // ä¸­é–“æ¡Œé¢åœ–ç¤ºä½ç½®
    hud.innerHTML = hud.innerHTML; // å·²æ˜¯innerHTMLï¼Œä¸éœ€å†è¨­å®š
    checkTension();
}

function buildCardHTML(card) {
    if (card.isJoker) {
        let isRed = card.rank === "RJ";
        return `<div class="full-cover ${isRed ? 'joker-bg-red' : 'joker-bg-black'}">
            <div class="joker-icon">${isRed ? 'ğŸ‘‘' : 'ğŸƒ'}</div>
            <div class="joker-text">${isRed ? 'å¤§<br>ç‹' : 'å°<br>ç‹'}</div>
        </div>`;
    }
    let isRed = card.suit === 'â™¥' || card.suit === 'â™¦';
    let sc = isRed ? 'suit-heart' : 'suit-spade';
    return `<div class="corner top-left ${sc}">${card.rank}<div class="corner-suit">${card.suit}</div></div>
            <div class="center ${sc}">${card.suit}</div>
            <div class="corner bottom-right ${sc}">${card.rank}<div class="corner-suit">${card.suit}</div></div>`;
}

function renderPlayer() {
    let area = document.getElementById("player");
    area.innerHTML = "";
    players[0].forEach((c, i) => {
        let div = document.createElement("div");
        div.className = "card";
        if (selected.includes(i)) div.classList.add("selected");
        div.innerHTML = buildCardHTML(c);
        div.onclick = () => toggle(i);
        area.appendChild(div);
    });
}

function renderTable(cards) {
    let t = document.getElementById("table");
    let hint = document.getElementById("tableEmptyHint");
    t.innerHTML = "";
    if (cards.length === 0) {
        let h = document.createElement('span');
        h.className = 'table-empty-hint';
        h.id = 'tableEmptyHint';
        if (current === 0 && landlord !== -1) h.textContent = 'âœ¨ ä½ ç²å¾—ç‰Œæ¬Šï¼Œè«‹è‡ªç”±å‡ºç‰Œ';
        else if (landlord !== -1) h.textContent = 'â³ ç­‰å¾…å‡ºç‰Œ...';
        else h.textContent = 'å‡ºç‰Œå€';
        t.appendChild(h);
    } else {
        cards.forEach(c => {
            let div = document.createElement("div");
            div.className = "card";
            div.style.animation = "fadeIn 0.2s ease";
            div.innerHTML = buildCardHTML(c);
            t.appendChild(div);
        });
    }
}

function toggle(i) {
    if (selected.includes(i)) selected = selected.filter(x => x !== i);
    else selected.push(i);
    renderPlayer();
}

function updateInfo(msg) {
    let el = document.getElementById("info");
    el.innerHTML = msg;
    el.style.animation = 'none';
    el.offsetHeight;
    el.style.animation = 'fadeIn 0.3s ease';
}

/* ===== ç‰Œå‹è§£æï¼ˆå®Œæ•´ä¿ç•™åŸç‰ˆé‚è¼¯ï¼‰ ===== */
function evaluate(cards) {
    if (!cards || cards.length === 0) return null;
    let sorted = [...cards].sort((a,b) => power[a.rank] - power[b.rank]);
    let counts = {}; sorted.forEach(c => counts[c.rank] = (counts[c.rank]||0)+1);
    let vals = Object.values(counts), keys = Object.keys(counts).sort((a,b) => power[a]-power[b]);
    let isSeq = (rankArr) => { if (rankArr.some(r => power[r] >= 15)) return false; for (let i=1;i<rankArr.length;i++){if(power[rankArr[i]]!==power[rankArr[i-1]]+1)return false;}return true; };

    if (cards.length===1) return {type:1,value:power[cards[0].rank],len:1,name:"å–®ç‰Œ"};
    if (cards.length===2) {
        if (cards[0].isJoker && cards[1].isJoker) return {type:99,value:999,len:2,name:"ç«ç®­(é›™ç‹)"};
        if (vals[0]===2) return {type:2,value:power[cards[0].rank],len:2,name:"å°å­"};
    }
    if (cards.length===3 && vals.includes(3)) return {type:3,value:power[cards[0].rank],len:3,name:"ä¸‰æ¢"};
    if (cards.length===4) {
        if (vals.includes(4)) return {type:10,value:power[sorted[0].rank],len:4,name:"ç‚¸å½ˆ(å››æ¢)"};
        if (vals.includes(3)) return {type:4,value:power[Object.keys(counts).find(k=>counts[k]===3)],len:4,name:"ä¸‰å¸¶ä¸€å–®"};
    }
    if (cards.length===5 && vals.includes(3) && vals.includes(2)) return {type:14,value:power[Object.keys(counts).find(k=>counts[k]===3)],len:5,name:"ä¸‰å¸¶ä¸€å°"};
    if (vals.includes(4)) {
        let fourRank = Object.keys(counts).find(k=>counts[k]===4);
        if (cards.length===6) return {type:6,value:power[fourRank],len:6,name:"å››å¸¶äºŒå–®"};
        if (cards.length===8){let pairCount=vals.filter(v=>v===2).length,fourCount=vals.filter(v=>v===4).length;if((fourCount===1&&pairCount===2)||fourCount===2)return {type:7,value:power[fourRank],len:8,name:"å››å¸¶äºŒå°"};}
    }
    if (cards.length>=5 && vals.every(v=>v===1) && isSeq(keys)) return {type:5,value:power[keys[keys.length-1]],len:cards.length,name:"é †å­"};
    if (cards.length>=6 && cards.length%2===0 && vals.every(v=>v===2) && isSeq(keys)) return {type:8,value:power[keys[keys.length-1]],len:cards.length,name:"é€£å°"};
    let threeRanks = Object.keys(counts).filter(k=>counts[k]>=3).sort((a,b)=>power[a]-power[b]);
    if (threeRanks.length>=2) {
        let validSeqs=[];
        for(let i=0;i<threeRanks.length;i++){let seq=[threeRanks[i]];for(let j=i+1;j<threeRanks.length;j++){if(power[threeRanks[j]]===power[seq[seq.length-1]]+1&&power[threeRanks[j]]<15){seq.push(threeRanks[j]);if(seq.length>=2)validSeqs.push([...seq]);}else break;}}
        validSeqs.sort((a,b)=>b.length-a.length);
        for(let seq of validSeqs){
            let planeLen=seq.length,planeValue=power[seq[seq.length-1]];
            if(cards.length===planeLen*3)return{type:11,value:planeValue,len:cards.length,name:"ç´”é£›æ©Ÿ"};
            if(cards.length===planeLen*4)return{type:12,value:planeValue,len:cards.length,name:"é£›æ©Ÿå¸¶å–®ç‰Œ"};
            if(cards.length===planeLen*5){let remainingVals=[];for(let k in counts){let c=counts[k];if(seq.includes(k))c-=3;if(c>0)remainingVals.push(c);}if(remainingVals.every(v=>v===2||v===4))return{type:13,value:planeValue,len:cards.length,name:"é£›æ©Ÿå¸¶å°å­"};}
        }
    }
    return null;
}

/* ===== æç¤ºèˆ‡è¦ä¸èµ· ===== */
function findBestPlay(playerIdx, checkOnly=false) {
    let hand=players[playerIdx];if(!hand||hand.length===0)return null;
    let counts={},cardsByRank={};
    hand.forEach(c=>{counts[c.rank]=(counts[c.rank]||0)+1;if(!cardsByRank[c.rank])cardsByRank[c.rank]=[];cardsByRank[c.rank].push(c);});
    let getRanksByMinCount=(min)=>Object.keys(counts).filter(k=>counts[k]>=min).sort((a,b)=>power[a]-power[b]);
    let singles=getRanksByMinCount(1),pairs=getRanksByMinCount(2),triples=getRanksByMinCount(3),bombs=getRanksByMinCount(4),hasRocket=counts["BJ"]&&counts["RJ"];
    let buildPlay=(rankList,countPerRank,extraCards=[])=>{let res=[];rankList.forEach(r=>res.push(...cardsByRank[r].slice(0,countPerRank)));return res.concat(extraCards);};
    if(!last){if(triples.length>0){let r=triples[0],pairKicker=pairs.find(p=>p!==r);if(pairKicker)return buildPlay([r],3,buildPlay([pairKicker],2));let kicker=singles.find(k=>k!==r);if(kicker)return buildPlay([r],3,buildPlay([kicker],1));return buildPlay([r],3);}if(pairs.length>0)return buildPlay([pairs[0]],2);return buildPlay([singles[0]],1);}
    let t=last.type,v=last.value,l=last.len,playCards=null;
    if(t===1){let valid=singles.find(r=>power[r]>v);if(valid)playCards=buildPlay([valid],1);}
    else if(t===2){let valid=pairs.find(r=>power[r]>v);if(valid)playCards=buildPlay([valid],2);}
    else if(t===3){let valid=triples.find(r=>power[r]>v);if(valid)playCards=buildPlay([valid],3);}
    else if(t===4||t===14){let validThrees=triples.find(r=>power[r]>v);if(validThrees){let validKicker=t===4?singles.find(k=>k!==validThrees):pairs.find(p=>p!==validThrees);if(validKicker)playCards=buildPlay([validThrees],3,buildPlay([validKicker],t===4?1:2));}}
    else if(t===5||t===8){let targetArr=t===5?singles:pairs,targetCount=t===5?1:2,targetLen=t===5?l:l/2;for(let i=0;i<=targetArr.length-targetLen;i++){let seq=[targetArr[i]],isValid=true;for(let j=1;j<targetLen;j++){if(power[targetArr[i+j]]===power[seq[seq.length-1]]+1&&power[targetArr[i+j]]<15)seq.push(targetArr[i+j]);else{isValid=false;break;}}if(isValid&&power[seq[seq.length-1]]>v){playCards=buildPlay(seq,targetCount);break;}}}
    else if(t>=11&&t<=13){let planeLen=t===11?l/3:(t===12?l/4:l/5),validSeqThrees=[];for(let i=0;i<=triples.length-planeLen;i++){let seq=[triples[i]],isValid=true;for(let j=1;j<planeLen;j++){if(power[triples[i+j]]===power[seq[seq.length-1]]+1&&power[triples[i+j]]<15)seq.push(triples[i+j]);else{isValid=false;break;}}if(isValid&&power[seq[seq.length-1]]>v)validSeqThrees.push(seq);}if(validSeqThrees.length>0){let seq=validSeqThrees[0],baseCards=buildPlay(seq,3);if(t===11)playCards=baseCards;else if(t===12){let availableSingles=[];Object.keys(cardsByRank).forEach(k=>{if(!seq.includes(k))availableSingles.push(...cardsByRank[k]);});if(availableSingles.length>=planeLen)playCards=baseCards.concat(availableSingles.slice(0,planeLen));}else if(t===13){let availablePairs=Object.keys(counts).filter(k=>!seq.includes(k)&&counts[k]>=2);if(availablePairs.length>=planeLen)playCards=baseCards.concat(buildPlay(availablePairs.slice(0,planeLen),2));}}}
    else if(t===6||t===7){let validBomb=bombs.find(r=>power[r]>v);if(validBomb){if(t===6){let availableSingles=[];Object.keys(cardsByRank).forEach(k=>{if(k!==validBomb)availableSingles.push(...cardsByRank[k]);});if(availableSingles.length>=2)playCards=buildPlay([validBomb],4).concat(availableSingles.slice(0,2));}else if(t===7){let availablePairs=Object.keys(counts).filter(k=>counts[k]>=2&&k!==validBomb);if(availablePairs.length>=2)playCards=buildPlay([validBomb],4).concat(buildPlay(availablePairs.slice(0,2),2));}}}
    else if(t===10){let valid=bombs.find(r=>power[r]>v);if(valid)playCards=buildPlay([valid],4);}
    if(!playCards&&t!==10&&t!==99&&bombs.length>0)playCards=buildPlay([bombs[0]],4);
    if(!playCards&&t!==99&&hasRocket)playCards=buildPlay(["BJ","RJ"],1);
    return playCards;
}

function hint() {
    if (current !== 0) return;
    let bestCards = findBestPlay(0);
    if (bestCards) {
        selected = [];
        bestCards.forEach(c => { let idx = players[0].indexOf(c); if (idx !== -1) selected.push(idx); });
        renderPlayer();
    } else { updateInfo("âš ï¸ è¦ä¸èµ·ï¼ˆç„¡ç‰Œå¯å£“ï¼‰"); }
}

function checkPlayerHasPlay() {
    if (current === 0 && last) {
        let hasPlay = findBestPlay(0, true);
        if (!hasPlay) updateInfo("âš ï¸ è¦ä¸èµ·ï¼Œæ²’æœ‰å¯å£“çš„ç‰Œ");
        else updateInfo("ğŸ¯ ä½ çš„å›åˆï¼Œè«‹å‡ºç‰Œï¼");
    } else if (current === 0) { updateInfo("âœ¨ ä½ çš„å›åˆï¼Œè‡ªç”±å‡ºç‰Œï¼"); }
}

/* ===== åŸ·è¡Œèˆ‡ AI ===== */
function executePlay(cards, r) {
    if (r && r.name) {
        if (current === 0 && r.name === dailyQuestTarget && !questAchievedThisRound) {
            questAchievedThisRound = true;
            document.getElementById("dailyQuestBanner").innerHTML = `âœ… é”æˆä»»å‹™ï¼šæ‰“å‡ºã€${dailyQuestTarget}ã€‘`;
            document.getElementById("dailyQuestBanner").classList.add("quest-done");
        }
        if (r.type === 10 || r.type === 99) {
            playSound(sndBomb);
            document.body.classList.add("shake-screen");
            setTimeout(() => document.body.classList.remove("shake-screen"), 450);
            gameMultiplier *= 2; updateMultiplierUI();
            showMultiplierBurst(`ğŸ’¥ Ã—${gameMultiplier}`);
            updateInfo(`ğŸ’¥ æ‰“å‡º ${r.name}ï¼å€æ•¸ç¿»å€ Ã—${gameMultiplier}ï¼`);
        } else {
            playSound(sndPlayCard);
            let prefix = (r.type >= 11 && r.type <= 13) ? "âœˆï¸" : "ğŸƒ";
            let who = current === 0 ? "ä½ " : aiNames[current].name;
            updateInfo(`${prefix} ${who} æ‰“å‡º ${r.name}`);
        }
    }
    if (current === landlord) landlordPlayCount++; else farmerPlayCount++;
    players[current] = players[current].filter(c => !cards.includes(c));
    last = r; lastPlayer = current; consecutivePasses = 0;
    renderTable(cards); renderOpponents();
    if (current === 0) { selected = []; renderPlayer(); }
    if (players[current].length === 0) { setTimeout(() => endGame(current), 800); return; }
    current = (current + 1) % 3; renderOpponents();
    if (current !== 0) setTimeout(aiPlay, 1500); else checkPlayerHasPlay();
}

function executePass() {
    consecutivePasses++;
    if (consecutivePasses >= 2) {
        last = null; current = lastPlayer; consecutivePasses = 0;
        renderTable([]); renderOpponents();
        if (current === 0) { checkPlayerHasPlay(); } else setTimeout(aiPlay, 1200);
    } else {
        let who = current === 0 ? "ä½ " : aiNames[current].name;
        updateInfo(`ğŸ™… ${who} ä¸å‡º`);
        current = (current + 1) % 3; renderOpponents();
        if (current !== 0) setTimeout(aiPlay, 1200); else checkPlayerHasPlay();
    }
}

function play() {
    if (current !== 0 || selected.length === 0) return;
    let cards = selected.map(i => players[0][i]);
    let r = evaluate(cards);
    if (!r) { updateInfo("âš ï¸ ç‰Œå‹ä¸ç¬¦åˆè¦å‰‡ï¼"); return; }
    if (last) {
        if (r.type === 99) {}
        else if (r.type === 10 && last.type !== 10 && last.type !== 99) {}
        else if (r.type !== last.type) { updateInfo("âš ï¸ ç‰Œå‹å¿…é ˆèˆ‡ä¸Šå®¶ç›¸åŒï¼"); return; }
        else if (r.type === 5 && cards.length !== last.len) { updateInfo("âš ï¸ é †å­é•·åº¦ä¸ç¬¦ï¼"); return; }
        else if (r.value <= last.value) { updateInfo("âš ï¸ é»æ•¸å¿…é ˆå¤§æ–¼ä¸Šå®¶ï¼"); return; }
    }
    executePlay(cards, r);
}

function pass() {
    if (current !== 0) return;
    if (!last) { updateInfo("âš ï¸ æ“æœ‰ç‰Œæ¬Šæ™‚ä¸èƒ½ä¸å‡ºï¼"); return; }
    selected = []; renderPlayer(); executePass();
}

/* ===== AI ===== */
function aiPlay() {
    let playCards = findBestPlay(current);
    let isLandlord = (current === landlord), isTeammateLast = (!isLandlord && lastPlayer !== landlord && lastPlayer !== -1);
    let isEmergency = (!isLandlord && players[landlord].length <= 3) || (isLandlord && players.some((p,i) => i!==landlord && p.length<=3));
    let isBlockingLandlord = (!isLandlord && (current+1)%3 === landlord);
    if (last && isTeammateLast && (last.value >= 13 || players[lastPlayer].length <= 2)) playCards = null;
    else if (last && isEmergency && last.type !== 10 && last.type !== 99) {
        let counts={}; players[current].forEach(c=>counts[c.rank]=(counts[c.rank]||0)+1);
        let bombs=Object.keys(counts).filter(k=>counts[k]===4);
        if (bombs.length>0) playCards=players[current].filter(c=>c.rank===bombs[0]);
    }
    if (playCards) { let ev=evaluate(playCards); if(ev) executePlay(playCards,ev); else executePass(); }
    else executePass();
}

/* ===== å«ç‰Œ ===== */
function startBidding() {
    currentBid=0; bidIndex=0;
    let starter=Math.floor(Math.random()*3); bidQueue=[starter,(starter+1)%3,(starter+2)%3];
    updateInfo("ğŸ“¢ é–‹å§‹å«åˆ†..."); setTimeout(processBidding, 800);
}

function processBidding() {
    if (bidIndex >= 3) {
        if (currentBid===0) { updateInfo("âš ï¸ ç„¡äººå«åœ°ä¸»ï¼Œé‡æ–°æ´—ç‰Œ..."); setTimeout(initGame, 1500); return; }
        setLandlord(landlord, currentBid); return;
    }
    let p=bidQueue[bidIndex];
    if (p===0) {
        document.getElementById("btnBid1").style.display = currentBid<1?"inline-block":"none";
        document.getElementById("btnBid2").style.display = currentBid<2?"inline-block":"none";
        document.getElementById("btnBid3").style.display = currentBid<3?"inline-block":"none";
        document.getElementById("btnNoBid").style.display = "inline-block";
        updateInfo("ğŸ¯ ä½ çš„å›åˆï¼Œè«‹å«åˆ†...");
    } else {
        let ai=aiNames[p], aiChoice=0;
        if(currentBid<3 && Math.random()>0.4) aiChoice=currentBid+1;
        if(aiChoice>0){currentBid=aiChoice;landlord=p;updateInfo(`${ai.avatar} ${ai.name} å«äº† ${currentBid} åˆ†`);if(currentBid===3){setTimeout(()=>setLandlord(landlord,3),1200);return;}}
        else{updateInfo(`${ai.avatar} ${ai.name} ä¸å«`);}
        bidIndex++; setTimeout(processBidding, 1200);
    }
}

function playerBid(score) {
    document.querySelectorAll('.btn-bid, #btnNoBid').forEach(b => b.style.display='none');
    if (score>0){currentBid=score;landlord=0;updateInfo(`ğŸ™‹ ä½ å«äº† ${score} åˆ†`);}else{updateInfo("ä½ é¸æ“‡ä¸å«");}
    bidIndex++; if(currentBid===3){setTimeout(()=>setLandlord(landlord,3),1000);return;}setTimeout(processBidding,1000);
}

function setLandlord(idx, score) {
    landlord=idx; baseScore=score; current=landlord; lastPlayer=landlord;
    landlordPlayCount=0; farmerPlayCount=0; gameMultiplier=1; updateMultiplierUI();
    players[landlord].push(...holeCards); players[landlord].sort((a,b)=>power[b.rank]-power[a.rank]);
    renderHoleCards(true); renderPlayer(); renderOpponents();
    let name = idx===0 ? "ä½ " : `${aiNames[idx].avatar} ${aiNames[idx].name}`;
    updateInfo(`ğŸ‘‘ ${name} æ“”ä»»åœ°ä¸»ï¼ˆåº•åˆ† ${score}ï¼‰`);
    document.getElementById("btnPlay").style.display="inline-block";
    document.getElementById("btnPass").style.display="inline-block";
    document.getElementById("btnHint").style.display="inline-block";
    if(current!==0) setTimeout(aiPlay,1500); else checkPlayerHasPlay();
}

/* ===== å½©å¸¶ ===== */
function shootConfetti() {
    const container=document.getElementById('confetti-container');
    if(!container)return;
    container.innerHTML=''; container.style.display='block';
    const colors=['#f0c040','#dc2626','#4ade80','#3b82f6','#a855f7','#ff80ab','#ffffff','#fde68a'];
    for(let i=0;i<140;i++){
        let conf=document.createElement('div');
        conf.className='confetti-piece';
        conf.style.left=Math.random()*100+'vw';
        conf.style.backgroundColor=colors[Math.floor(Math.random()*colors.length)];
        conf.style.animationDuration=(Math.random()*3+2)+'s';
        conf.style.animationDelay=(Math.random()*1.5)+'s';
        conf.style.width=(Math.random()*10+6)+'px';
        conf.style.height=(Math.random()*14+8)+'px';
        conf.style.borderRadius=Math.random()>0.5?'50%':'3px';
        container.appendChild(conf);
    }
    // å‹åˆ©å…‰æ•ˆ
    let glow=document.createElement('div');
    glow.className='win-glow';
    document.body.appendChild(glow);
    setTimeout(()=>glow.remove(), 2000);
    setTimeout(()=>{container.style.display='none'; container.innerHTML='';},6000);
}

/* ===== çµç®— ===== */
function endGame(winner) {
    let isLandlordWin=(winner===landlord), playerWon=(winner===0)||(landlord!==0&&winner!==landlord);
    let isSpring=false, springText="";
    if(playerWon){stats.currentWinStreak++;if(stats.currentWinStreak>stats.maxWinStreak)stats.maxWinStreak=stats.currentWinStreak;}
    else{stats.currentWinStreak=0;}
    if(isLandlordWin&&farmerPlayCount===0){isSpring=true;gameMultiplier*=2;springText="ğŸŒ¸ æ˜¥å¤©ï¼";}
    else if(!isLandlordWin&&landlordPlayCount===1){isSpring=true;gameMultiplier*=2;springText="ğŸŒ¸ åæ˜¥å¤©ï¼";}
    let questBonusText="";
    if(playerWon&&questAchievedThisRound){gameMultiplier*=2;questBonusText=`<div style="color:#c084fc;margin-bottom:8px;font-size:13px;">ğŸ¯ ä»»å‹™é”æˆï¼šÃ—2</div>`;}
    questAchievedThisRound=false;
    let finalScore=baseScore*gameMultiplier;
    let modal=document.getElementById("scoreModal");
    let titleEl=document.getElementById("modalTitle");

    if(playerWon){
        titleEl.className="modal-title-win";
        titleEl.innerHTML="ğŸ‰ æ­å–œç²å‹ï¼";
        shootConfetti();
    } else {
        titleEl.className="modal-title-lose";
        titleEl.innerHTML="ğŸ’¥ éºæ†¾è½æ•—";
    }

    let html=`<div style="color:${gameMultiplier>1?'#f0c040':'#aaa'};margin-bottom:10px;font-size:13px;text-align:center;">
        ç¸½å€æ•¸ï¼šÃ—${gameMultiplier} ${springText}
    </div>${questBonusText}`;

    const names=["ä½ ï¼ˆç©å®¶ï¼‰", `${aiNames[1].avatar} ${aiNames[1].name}`, `${aiNames[2].avatar} ${aiNames[2].name}`];
    for(let i=0;i<3;i++){
        let role=i===landlord?"ğŸ§‘â€ğŸŒ¾ åœ°ä¸»":"ğŸŒ¾ è¾²æ°‘";
        let change=isLandlordWin?(i===landlord?finalScore*2:-finalScore):(i===landlord?-finalScore*2:finalScore);
        if(i===0&&playerWon&&stats.currentWinStreak>=3){let bonus=Math.floor(change*0.2);change+=bonus;html+=`<div style="color:#f97316;font-size:12px;text-align:center;margin-bottom:6px;">ğŸ”¥ é€£å‹ç´…åˆ© +${bonus}</div>`;}
        stats.totalScores[i]+=change;
        html+=`<div class="result-row${i===0?' player-row':''}">
            <span>${role} ${names[i]}</span>
            <span class="result-change" style="color:${change>=0?'#4ade80':'#f87171'}">${change>=0?'+'+change:change}</span>
        </div>`;
    }
    localStorage.setItem("doudizhu_stats", JSON.stringify(stats));
    document.getElementById("modalScores").innerHTML=html;
    modal.style.display="flex";
}

/* ===== åˆå§‹åŒ– ===== */
function initGame() {
    initDailyQuest(); updateStatsUI();
    document.querySelectorAll('.btn-bid, #btnNoBid, #btnPass, #btnPlay, #btnHint').forEach(b=>b.style.display='none');
    document.getElementById("multiplierBadge").style.display="none";
    deck=[];
    for(let r of ranks) for(let s of suits) deck.push({rank:r,suit:s,isJoker:false});
    deck.push({rank:"BJ",isJoker:true}); deck.push({rank:"RJ",isJoker:true});
    deck.sort(()=>Math.random()-0.5);
    holeCards=deck.slice(0,3); players=[[],[],[]];
    for(let i=3;i<54;i++) players[(i-3)%3].push(deck[i]);
    players.forEach(p=>p.sort((a,b)=>power[b.rank]-power[a.rank]));
    renderHoleCards(false); renderPlayer(); renderOpponents(); renderTable([]);
    updateInfo("ğŸ² ç™¼ç‰Œå®Œæˆï¼Œæº–å‚™å«åœ°ä¸»");
    setTimeout(startBidding,800);
}

initGame();
</script>
</body>
</html>
