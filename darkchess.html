<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æš—æ£‹</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700;900&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
<style>
/* ============================================
   CSS è®Šæ•¸ & é‡ç½®
   ============================================ */
:root {
  --ink:        #0d0500;
  --ink-mid:    #1a0a00;
  --paper:      #f5e6c8;
  --paper-dim:  #d4c4a0;
  --gold:       #c9a84c;
  --gold-light: #f0d080;
  --gold-dim:   rgba(201,168,76,0.35);
  --red:        #cc2200;
  --red-dim:    #8b1a1a;
  --red-glow:   rgba(204,34,0,0.5);
  --black-p:    #1a1a2e;
  --wood-dark:  #3d1f0a;
  --wood-mid:   #6b3a1f;
  --wood-light: #a0642a;
  --panel-bg:   rgba(18,8,0,0.94);
  --border-g:   1px solid rgba(201,168,76,0.3);
  --shadow-xl:  0 20px 60px rgba(0,0,0,0.8);
  --radius:     14px;
  --transition: all 0.2s ease;
}

*{box-sizing:border-box;margin:0;padding:0;}

html{scroll-behavior:smooth;}

body {
  min-height:100vh;
  background:
    radial-gradient(ellipse 80% 60% at 20% 10%, rgba(100,50,0,0.25) 0%, transparent 60%),
    radial-gradient(ellipse 60% 80% at 85% 90%, rgba(60,20,0,0.3) 0%, transparent 60%),
    linear-gradient(160deg, #0a0300 0%, #160800 50%, #0a0300 100%);
  font-family:'Noto Serif TC',serif;
  color:var(--paper);
  overflow-x:hidden;
}

/* èƒŒæ™¯ç´‹ç† */
body::before {
  content:'';
  position:fixed;inset:0;
  background-image:
    repeating-linear-gradient(0deg,transparent,transparent 39px,rgba(201,168,76,0.03) 40px),
    repeating-linear-gradient(90deg,transparent,transparent 39px,rgba(201,168,76,0.03) 40px);
  pointer-events:none;z-index:0;
}

/* ============================================
   é é¢çµæ§‹
   ============================================ */
#app {
  position:relative;z-index:1;
  max-width:1200px;margin:0 auto;
  padding:12px 16px 40px;
  display:flex;flex-direction:column;align-items:center;gap:14px;
}

/* ============================================
   é ‚éƒ¨å°èˆªæ¬„
   ============================================ */
.top-nav {
  width:100%;display:flex;align-items:center;justify-content:space-between;
  padding:10px 16px;
  background:linear-gradient(135deg,rgba(20,10,0,0.9),rgba(10,4,0,0.95));
  border:var(--border-g);border-radius:var(--radius);
  box-shadow:0 4px 20px rgba(0,0,0,0.5),inset 0 1px 0 rgba(201,168,76,0.15);
  backdrop-filter:blur(10px);
}

.nav-brand {
  display:flex;align-items:center;gap:10px;
}
.nav-brand h1 {
  font-family:'Ma Shan Zheng',serif;
  font-size:clamp(20px,4vw,30px);
  color:var(--gold);
  text-shadow:0 0 20px rgba(201,168,76,0.6),2px 2px 0 rgba(0,0,0,0.8);
  letter-spacing:4px;line-height:1;
}
.nav-brand .subtitle{
  font-size:10px;letter-spacing:4px;
  color:rgba(201,168,76,0.4);
  display:none;
}
@media(min-width:600px){.nav-brand .subtitle{display:block;}}

.nav-actions{display:flex;gap:8px;}

.nav-btn {
  display:flex;align-items:center;gap:6px;
  padding:7px 14px;border-radius:8px;border:none;
  font-family:'Noto Serif TC',serif;font-size:13px;font-weight:600;
  cursor:pointer;letter-spacing:1px;transition:var(--transition);
  background:rgba(201,168,76,0.1);color:var(--gold);
  border:1px solid rgba(201,168,76,0.25);
}
.nav-btn:hover{background:rgba(201,168,76,0.2);border-color:rgba(201,168,76,0.5);}
.nav-btn .icon{font-size:16px;}

/* ============================================
   çµ±è¨ˆæ¬„
   ============================================ */
.stats-bar {
  width:100%;display:grid;grid-template-columns:repeat(5,1fr);gap:8px;
}
@media(max-width:480px){.stats-bar{grid-template-columns:repeat(3,1fr);}}

.stat-card {
  background:linear-gradient(135deg,rgba(20,10,0,0.9),rgba(12,5,0,0.95));
  border:var(--border-g);border-radius:10px;
  padding:10px 8px;text-align:center;
  box-shadow:0 4px 12px rgba(0,0,0,0.4);
  transition:var(--transition);
}
.stat-card:hover{border-color:rgba(201,168,76,0.6);transform:translateY(-1px);}
.stat-num {
  font-family:'Ma Shan Zheng',serif;
  font-size:clamp(18px,4vw,28px);
  font-weight:900;line-height:1;
}
.stat-num.win{color:#4caf50;text-shadow:0 0 10px rgba(76,175,80,0.5);}
.stat-num.lose{color:#f44336;text-shadow:0 0 10px rgba(244,67,54,0.5);}
.stat-num.draw{color:#90a4ae;}
.stat-num.total{color:var(--gold);text-shadow:0 0 10px rgba(201,168,76,0.4);}
.stat-num.ach{color:#ce93d8;text-shadow:0 0 10px rgba(206,147,216,0.5);}
.stat-label{font-size:10px;letter-spacing:2px;color:rgba(255,255,255,0.35);margin-top:4px;}

/* ============================================
   æ§åˆ¶é¢æ¿
   ============================================ */
.control-panel {
  width:100%;
  background:linear-gradient(135deg,rgba(20,10,0,0.92),rgba(10,4,0,0.96));
  border:var(--border-g);border-radius:var(--radius);
  padding:14px 18px;
  box-shadow:0 8px 32px rgba(0,0,0,0.5),inset 0 1px 0 rgba(201,168,76,0.12);
  display:flex;flex-direction:column;align-items:center;gap:10px;
}

.controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;align-items:center;}

select{
  padding:8px 32px 8px 12px;border-radius:8px;
  border:1px solid rgba(201,168,76,0.35);
  background:rgba(15,6,0,0.8);
  color:var(--gold-light);
  font-family:'Noto Serif TC',serif;font-size:13px;
  cursor:pointer;appearance:none;-webkit-appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23c9a84c' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 10px center;
  transition:var(--transition);
}
select:focus{outline:none;border-color:var(--gold);}
select option{background:#1a0a00;color:var(--gold-light);}

#difficulty-container{transition:opacity 0.3s;}

.game-btn{
  padding:8px 16px;border-radius:8px;border:none;
  font-family:'Noto Serif TC',serif;font-weight:700;font-size:13px;
  cursor:pointer;transition:var(--transition);letter-spacing:1px;
}
#restart-btn{
  background:linear-gradient(135deg,#2e7d32,#1b5e20);color:#a5d6a7;
  border:1px solid #4caf50;box-shadow:0 2px 8px rgba(76,175,80,0.25);
}
#restart-btn:hover{box-shadow:0 4px 16px rgba(76,175,80,0.4);transform:translateY(-1px);}
#undo-btn{
  background:linear-gradient(135deg,rgba(180,100,0,0.8),rgba(120,60,0,0.8));
  color:#ffe0b2;border:1px solid rgba(180,100,0,0.5);
  box-shadow:0 2px 8px rgba(180,100,0,0.2);
}
#undo-btn:hover:not(:disabled){box-shadow:0 4px 16px rgba(180,100,0,0.35);transform:translateY(-1px);}
#undo-btn:disabled{background:rgba(40,40,40,0.5);color:#444;cursor:not-allowed;border-color:#333;box-shadow:none;transform:none;}
.game-btn:active:not(:disabled){transform:translateY(2px)!important;}

#info-box {
  font-size:clamp(14px,3vw,17px);font-weight:700;
  padding:9px 24px;border-radius:30px;letter-spacing:2px;
  background:rgba(15,6,0,0.9);
  border:1px solid rgba(201,168,76,0.3);
  transition:color 0.3s,border-color 0.3s;
  text-shadow:0 0 12px currentColor;
}

/* ============================================
   éŠæˆ²ä¸»å¸ƒå±€
   ============================================ */
#game-layout{
  display:flex;flex-direction:row;gap:16px;
  width:100%;align-items:flex-start;justify-content:center;
}
@media(max-width:950px){#game-layout{flex-direction:column;align-items:center;}}

/* ============================================
   æ£‹ç›¤
   ============================================ */
.board-wrap{flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:6px;}
.board-label{
  font-size:11px;letter-spacing:4px;
  color:rgba(201,168,76,0.4);text-align:center;
}

#board {
  width:min(580px,96vw);
  display:grid;grid-template-columns:repeat(8,1fr);gap:5px;
  padding:13px;border-radius:14px;
  background:
    radial-gradient(ellipse at 30% 20%,#8a5025,#6b3a1f 40%,#4a2508 70%,#3d1f0a);
  border:3px solid #2a1008;
  outline:7px solid rgba(10,4,0,0.9);outline-offset:3px;
  box-shadow:
    0 0 0 1px rgba(201,168,76,0.1),
    0 15px 50px rgba(0,0,0,0.9),
    0 40px 100px rgba(0,0,0,0.5),
    inset 0 0 50px rgba(0,0,0,0.4),
    inset 0 2px 0 rgba(180,130,60,0.25);
  position:relative;
}

/* æ£‹ç›¤æ ¼ç·šç´‹ç† */
#board::before{
  content:'';position:absolute;inset:13px;border-radius:4px;
  background:
    repeating-linear-gradient(90deg,transparent,transparent calc(12.5% - 0.5px),rgba(0,0,0,0.12) calc(12.5% - 0.5px),rgba(0,0,0,0.12) 12.5%),
    repeating-linear-gradient(0deg,transparent,transparent calc(25% - 0.5px),rgba(0,0,0,0.12) calc(25% - 0.5px),rgba(0,0,0,0.12) 25%);
  pointer-events:none;z-index:0;
}

/* ============================================
   æ£‹å­
   ============================================ */
.cell {
  width:100%;aspect-ratio:1/1;cursor:pointer;border-radius:50%;
  display:flex;justify-content:center;align-items:center;
  font-size:clamp(15px,4.2vw,30px);
  font-family:'Ma Shan Zheng','Noto Serif TC',serif;font-weight:900;
  position:relative;z-index:1;
  transition:transform 0.12s ease,box-shadow 0.12s ease;
  background:radial-gradient(circle at 33% 25%,#f2deb0,#caa568 45%,#9a7038);
  box-shadow:0 5px 0 #6b4a18,0 7px 14px rgba(0,0,0,0.7),inset 0 1px 3px rgba(255,245,200,0.5),inset 0 -1px 2px rgba(0,0,0,0.2);
  border:1px solid rgba(190,150,70,0.3);
  user-select:none;
}
.cell:hover:not(.empty) {
  transform:translateY(-3px);
  box-shadow:0 8px 0 #6b4a18,0 12px 20px rgba(0,0,0,0.8),inset 0 1px 3px rgba(255,245,200,0.5);
}
.cell:active:not(.empty){
  transform:translateY(4px)!important;
  box-shadow:0 1px 0 #6b4a18,0 2px 6px rgba(0,0,0,0.5)!important;
}

.hidden{
  background:radial-gradient(circle at 38% 28%,#5c3520,#2e1308);
  box-shadow:0 5px 0 #1e0900,0 7px 14px rgba(0,0,0,0.8),inset 0 1px 2px rgba(200,120,40,0.08);
  border-color:rgba(100,50,15,0.4);
}
.hidden::after{content:"ï¼Ÿ";color:rgba(201,168,76,0.12);font-size:80%;}
.hidden:hover{
  background:radial-gradient(circle at 38% 28%,#6e4030,#3a1a10);
  transform:translateY(-3px);
}

.red-p{color:var(--red);text-shadow:0 0 10px rgba(200,40,0,0.6),1px 1px 0 rgba(255,200,180,0.2);}
.black-p{color:#1a1a2e;text-shadow:0 0 6px rgba(20,20,50,0.4),1px 1px 0 rgba(200,200,220,0.15);}

.selected{
  transform:translateY(-7px)!important;
  background:radial-gradient(circle at 33% 25%,#fff8d0,#e8c858 45%,#b89030)!important;
  box-shadow:0 13px 0 #b09020,0 18px 35px rgba(201,168,76,0.55),inset 0 1px 3px rgba(255,255,200,0.6)!important;
  border:2px solid var(--gold)!important;
}

.empty{
  background:linear-gradient(135deg,rgba(0,0,0,0.28),rgba(0,0,0,0.15));
  box-shadow:inset 0 2px 8px rgba(0,0,0,0.55);
  border:1px solid rgba(0,0,0,0.12);
  border-radius:8px;cursor:default;
}
.empty:hover,.empty:active{transform:none!important;box-shadow:inset 0 2px 8px rgba(0,0,0,0.55)!important;}

.valid-move::before{
  content:'';position:absolute;width:34%;height:34%;border-radius:50%;
  background:radial-gradient(circle,rgba(80,220,80,0.95),rgba(40,160,40,0.7));
  box-shadow:0 0 14px rgba(80,220,80,0.9);
  animation:dot-pulse 1.1s ease-in-out infinite;
}
.valid-capture{
  box-shadow:0 5px 0 #8b1a1a,0 7px 14px rgba(0,0,0,0.7),0 0 0 3px rgba(200,40,0,0.85),inset 0 1px 3px rgba(255,200,180,0.3)!important;
}
.valid-capture::after{
  content:'';position:absolute;inset:-4px;border:2px solid #ff4444;border-radius:50%;
  animation:capture-ring 0.85s ease-in-out infinite;
}
.last-moved{
  box-shadow:0 5px 0 #6b4a18,0 7px 14px rgba(0,0,0,0.7),0 0 0 2px rgba(80,160,255,0.6),inset 0 1px 3px rgba(200,230,255,0.3)!important;
}

@keyframes dot-pulse{0%,100%{opacity:.55;transform:scale(.88);}50%{opacity:1;transform:scale(1.12);}}
@keyframes capture-ring{0%,100%{opacity:.45;transform:scale(1);}50%{opacity:1;transform:scale(1.08);box-shadow:0 0 10px rgba(255,68,68,0.5);}}
@keyframes piece-flip{0%{transform:scaleX(0) translateY(-4px);}60%{transform:scaleX(1.1) translateY(-6px);}100%{transform:scaleX(1) translateY(-3px);}}
.flipping{animation:piece-flip 0.3s ease-out;}

.coord-row{
  display:flex;justify-content:space-around;
  width:min(580px,96vw);padding:0 13px;
}
.coord-row span{
  width:calc(100%/8);text-align:center;
  font-size:9px;color:rgba(201,168,76,0.3);letter-spacing:0;
}

/* ============================================
   å´é‚Šæ¬„
   ============================================ */
#side-panel{
  background:var(--panel-bg);border:var(--border-g);
  border-radius:var(--radius);padding:16px;
  width:100%;max-width:260px;
  box-shadow:0 8px 32px rgba(0,0,0,0.5),inset 0 1px 0 rgba(201,168,76,0.08);
  display:flex;flex-direction:column;gap:14px;flex-shrink:0;
}
@media(max-width:950px){#side-panel{max-width:min(580px,96vw);}}

.panel-section{display:flex;flex-direction:column;gap:6px;}
.section-title{
  font-size:10px;letter-spacing:3px;font-weight:600;
  padding-bottom:6px;border-bottom:1px solid rgba(201,168,76,0.18);
  display:flex;align-items:center;gap:6px;
}
.section-title.red-t{color:#ef9a9a;}
.section-title.blk-t{color:#90a4ae;}
.section-title.log-t{color:#81d4fa;}
.section-title.rule-t{color:rgba(201,168,76,0.7);}

.captured-container{
  display:flex;flex-wrap:wrap;gap:4px;
  background:rgba(0,0,0,0.3);padding:7px;border-radius:8px;min-height:40px;
  border:1px solid rgba(255,255,255,0.04);
}
.captured-piece{
  width:27px;height:27px;border-radius:50%;
  display:flex;justify-content:center;align-items:center;
  font-size:12px;font-family:'Ma Shan Zheng',serif;font-weight:bold;
  background:radial-gradient(circle at 33% 28%,#f0dab0,#c8a068 45%,#9a7030);
  box-shadow:0 2px 4px rgba(0,0,0,0.6),0 3px 0 #6b4a18;
  border:1px solid rgba(190,150,70,0.3);
}
.captured-piece.cp-red{color:#b71c1c;}
.captured-piece.cp-blk{color:#1a1a2e;}

#history-list{
  list-style:none;max-height:180px;overflow-y:auto;
  font-size:11px;color:#90a4ae;
  scrollbar-width:thin;scrollbar-color:rgba(201,168,76,0.25) transparent;
}
#history-list li{
  padding:5px 6px;border-bottom:1px solid rgba(255,255,255,0.04);
  border-radius:3px;transition:background 0.1s;
}
#history-list li:hover{background:rgba(255,255,255,0.04);}
#history-list li:last-child{color:var(--gold-light);font-weight:bold;}

/* å¿«é€Ÿè¦å‰‡ */
.rank-table{width:100%;}
.rank-row{
  display:flex;align-items:center;gap:5px;
  font-size:11px;color:rgba(255,255,255,0.45);
  padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.03);
}
.rank-pieces{color:var(--gold-light);font-family:'Ma Shan Zheng',serif;letter-spacing:1px;min-width:80px;}
.rank-desc{font-size:10px;color:rgba(201,168,76,0.5);}

/* ============================================
   æ’’èŠ±
   ============================================ */
#confetti-canvas{position:fixed;inset:0;width:100vw;height:100vh;pointer-events:none;z-index:9999;}

/* ============================================
   æˆå°±å½ˆå‡ºé€šçŸ¥
   ============================================ */
#ach-toast{
  position:fixed;bottom:30px;right:20px;
  display:flex;flex-direction:column;gap:10px;
  z-index:10000;pointer-events:none;
}
.ach-toast-item{
  display:flex;align-items:center;gap:12px;
  background:linear-gradient(135deg,rgba(15,8,0,0.97),rgba(25,12,0,0.98));
  border:1px solid var(--gold);border-radius:12px;
  padding:12px 16px;min-width:260px;max-width:320px;
  box-shadow:0 8px 32px rgba(0,0,0,0.7),0 0 20px rgba(201,168,76,0.2);
  animation:toast-in 0.4s cubic-bezier(.34,1.56,.64,1) forwards;
}
.ach-toast-item.out{animation:toast-out 0.3s ease-in forwards;}
.ach-toast-icon{font-size:28px;flex-shrink:0;}
.ach-toast-text{flex:1;}
.ach-toast-label{font-size:10px;letter-spacing:2px;color:var(--gold);margin-bottom:3px;}
.ach-toast-name{font-size:14px;font-weight:700;color:var(--paper);}
.ach-toast-desc{font-size:11px;color:rgba(255,255,255,0.5);margin-top:2px;}
@keyframes toast-in{from{opacity:0;transform:translateX(100%+20px);}to{opacity:1;transform:translateX(0);}}
@keyframes toast-out{from{opacity:1;transform:translateX(0);}to{opacity:0;transform:translateX(100%);}}

/* ============================================
   æ¨¡æ…‹æ¡†å…±ç”¨
   ============================================ */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.85);
  display:flex;align-items:center;justify-content:center;
  z-index:5000;opacity:0;pointer-events:none;transition:opacity 0.3s;
  padding:16px;
}
.modal-overlay.show{opacity:1;pointer-events:auto;}
.modal-box{
  background:linear-gradient(160deg,#120800,#0a0400);
  border:1px solid rgba(201,168,76,0.4);border-radius:18px;
  width:100%;max-width:720px;max-height:90vh;overflow-y:auto;
  box-shadow:0 30px 80px rgba(0,0,0,0.9),0 0 60px rgba(201,168,76,0.1);
  transform:scale(0.92) translateY(20px);transition:transform 0.3s;
  scrollbar-width:thin;scrollbar-color:rgba(201,168,76,0.25) transparent;
}
.modal-overlay.show .modal-box{transform:scale(1) translateY(0);}
.modal-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:20px 24px 14px;
  border-bottom:1px solid rgba(201,168,76,0.2);
  position:sticky;top:0;background:#120800;z-index:1;
}
.modal-header h2{
  font-family:'Ma Shan Zheng',serif;font-size:24px;
  color:var(--gold);text-shadow:0 0 15px rgba(201,168,76,0.5);
  letter-spacing:4px;
}
.modal-close{
  background:none;border:1px solid rgba(201,168,76,0.3);
  color:rgba(201,168,76,0.7);font-size:18px;cursor:pointer;
  width:34px;height:34px;border-radius:50%;transition:var(--transition);
  display:flex;align-items:center;justify-content:center;
}
.modal-close:hover{background:rgba(201,168,76,0.15);color:var(--gold);border-color:var(--gold);}
.modal-body{padding:20px 24px 24px;}

/* ============================================
   è¦å‰‡æ¨¡æ…‹æ¡†
   ============================================ */
.rule-section{margin-bottom:24px;}
.rule-section h3{
  font-family:'Ma Shan Zheng',serif;font-size:18px;color:var(--gold-light);
  letter-spacing:3px;margin-bottom:10px;
  padding-bottom:6px;border-bottom:1px solid rgba(201,168,76,0.15);
}
.rule-section p{
  font-size:13px;line-height:1.9;color:rgba(255,255,255,0.65);margin-bottom:8px;
}
.rule-section p strong{color:var(--gold-light);}

.rank-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px;margin-top:10px;
}
.rank-card{
  background:rgba(0,0,0,0.3);border:1px solid rgba(201,168,76,0.15);
  border-radius:8px;padding:10px;text-align:center;
}
.rank-card .piece-name{
  font-family:'Ma Shan Zheng',serif;font-size:22px;
  display:flex;gap:6px;justify-content:center;margin-bottom:5px;
}
.rn-r{color:var(--red);}
.rn-b{color:#4a6080;}
.rank-card .piece-info{font-size:11px;color:rgba(255,255,255,0.45);line-height:1.6;}
.rank-card .rank-badge{
  display:inline-block;font-size:10px;letter-spacing:1px;
  background:rgba(201,168,76,0.15);color:var(--gold);
  padding:2px 8px;border-radius:4px;margin-bottom:4px;
}

.special-rule{
  background:rgba(201,168,76,0.06);border:1px solid rgba(201,168,76,0.2);
  border-radius:8px;padding:12px;margin-bottom:8px;
}
.special-rule .sr-title{
  font-size:13px;font-weight:700;color:var(--gold-light);margin-bottom:4px;
}
.special-rule .sr-desc{font-size:12px;color:rgba(255,255,255,0.55);line-height:1.7;}

/* ============================================
   æˆå°±æ¨¡æ…‹æ¡†
   ============================================ */
.ach-tabs{
  display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;
}
.ach-tab{
  padding:7px 16px;border-radius:8px;border:1px solid rgba(201,168,76,0.25);
  background:transparent;color:rgba(255,255,255,0.45);font-size:12px;font-weight:600;
  cursor:pointer;transition:var(--transition);letter-spacing:1px;
  font-family:'Noto Serif TC',serif;
}
.ach-tab.active,.ach-tab:hover{
  background:rgba(201,168,76,0.15);color:var(--gold);border-color:rgba(201,168,76,0.5);
}

.ach-progress-bar{
  width:100%;height:6px;background:rgba(255,255,255,0.08);border-radius:3px;margin-bottom:16px;overflow:hidden;
}
.ach-progress-fill{
  height:100%;border-radius:3px;
  background:linear-gradient(90deg,var(--gold),var(--gold-light));
  transition:width 0.6s ease;
}

.ach-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;
}
.ach-card{
  background:linear-gradient(135deg,rgba(15,8,0,0.9),rgba(8,4,0,0.95));
  border:1px solid rgba(255,255,255,0.08);border-radius:10px;
  padding:14px;display:flex;flex-direction:column;gap:8px;
  transition:var(--transition);position:relative;overflow:hidden;
}
.ach-card:hover{transform:translateY(-2px);border-color:rgba(201,168,76,0.3);}
.ach-card.unlocked{
  border-color:rgba(201,168,76,0.45);
  background:linear-gradient(135deg,rgba(30,16,0,0.95),rgba(15,8,0,0.98));
}
.ach-card.unlocked::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,rgba(201,168,76,0.06),transparent);
  pointer-events:none;
}
.ach-card.secret:not(.unlocked){border-style:dashed;border-color:rgba(255,255,255,0.06);}

.ach-icon{font-size:30px;line-height:1;}
.ach-name{font-size:13px;font-weight:700;color:var(--paper);}
.ach-card:not(.unlocked) .ach-name{color:rgba(255,255,255,0.3);}
.ach-desc{font-size:11px;color:rgba(255,255,255,0.4);line-height:1.6;}
.ach-card.unlocked .ach-desc{color:rgba(255,255,255,0.55);}
.ach-unlock-date{font-size:10px;color:var(--gold);letter-spacing:1px;margin-top:auto;}
.ach-lock-icon{
  position:absolute;top:10px;right:10px;
  font-size:14px;color:rgba(255,255,255,0.12);
}
.ach-card.unlocked .ach-lock-icon{display:none;}
.ach-rarity{
  font-size:9px;letter-spacing:2px;padding:2px 7px;border-radius:4px;
  display:inline-block;width:fit-content;
}
.rarity-common{background:rgba(100,180,100,0.15);color:#80c880;}
.rarity-rare{background:rgba(100,150,220,0.15);color:#80a8e0;}
.rarity-epic{background:rgba(180,100,220,0.15);color:#c090d8;}
.rarity-legendary{background:rgba(220,160,40,0.15);color:var(--gold);}

.ach-shimmer{
  position:absolute;inset:0;background:linear-gradient(105deg,transparent 40%,rgba(201,168,76,0.15) 50%,transparent 60%);
  animation:shimmer 3s infinite;pointer-events:none;
}
@keyframes shimmer{0%{transform:translateX(-100%);}100%{transform:translateX(200%);}}

/* ============================================
   å‹åˆ©è¦†è“‹
   ============================================ */
#win-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.6);
  display:flex;align-items:center;justify-content:center;
  z-index:4000;opacity:0;pointer-events:none;transition:opacity 0.5s;
}
#win-overlay.show{opacity:1;pointer-events:auto;}
.win-box{
  background:linear-gradient(160deg,#1a0a00,#0a0400);
  border:2px solid var(--gold);border-radius:20px;
  padding:36px 48px;text-align:center;
  box-shadow:0 0 60px rgba(201,168,76,0.3),0 30px 80px rgba(0,0,0,0.9);
  transform:scale(0.85);transition:transform 0.4s cubic-bezier(.34,1.56,.64,1);
}
#win-overlay.show .win-box{transform:scale(1);}
.win-icon{font-size:56px;line-height:1;margin-bottom:12px;}
.win-title{
  font-family:'Ma Shan Zheng',serif;font-size:36px;
  color:var(--gold);text-shadow:0 0 25px rgba(201,168,76,0.7);
  letter-spacing:6px;margin-bottom:8px;
}
.win-sub{font-size:14px;color:rgba(255,255,255,0.5);letter-spacing:2px;margin-bottom:24px;}
.win-btn{
  padding:12px 32px;border-radius:10px;border:none;
  font-family:'Noto Serif TC',serif;font-size:15px;font-weight:700;
  cursor:pointer;letter-spacing:2px;
  background:linear-gradient(135deg,#c9a84c,#8b6914);color:#0a0400;
  box-shadow:0 4px 20px rgba(201,168,76,0.4);transition:var(--transition);
}
.win-btn:hover{box-shadow:0 6px 28px rgba(201,168,76,0.6);transform:translateY(-2px);}
</style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>
<div id="ach-toast"></div>

<!-- è¦å‰‡æ¨¡æ…‹æ¡† -->
<div class="modal-overlay" id="rules-modal">
  <div class="modal-box">
    <div class="modal-header">
      <h2>æš—æ£‹è¦å‰‡</h2>
      <button class="modal-close" onclick="closeModal('rules-modal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="rule-section">
        <h3>éŠæˆ²æ¦‚è¿°</h3>
        <p>æš—æ£‹ï¼ˆåˆç¨±ã€Œç›²æ£‹ã€ï¼‰æ˜¯ä¸€ç¨®æ”¹è‰¯è‡ªä¸­åœ‹è±¡æ£‹çš„æ£‹é¡éŠæˆ²ï¼Œä½¿ç”¨ <strong>4è¡ŒÃ—8åˆ—</strong> å…± <strong>32æ ¼</strong> çš„æ£‹ç›¤ï¼Œå…¨éƒ¨ 32 é¡†æ£‹å­æ­£é¢æœä¸‹éš¨æ©Ÿæ’åˆ—ã€‚ç©å®¶è¼ªæµç¿»é–‹æ£‹å­ã€ç§»å‹•æ£‹å­æˆ–åƒæ‰å°æ–¹æ£‹å­ï¼Œæœ€çµ‚æ¶ˆæ»…å°æ–¹æ‰€æœ‰æ£‹å­è€…ç²å‹ã€‚</p>
      </div>

      <div class="rule-section">
        <h3>æ±ºå®šé™£ç‡Ÿ</h3>
        <p>éŠæˆ²é–‹å§‹æ™‚ï¼Œ<strong>ç¿»é–‹ç¬¬ä¸€é¡†æ£‹å­çš„é¡è‰²æ±ºå®šç¿»æ£‹è€…çš„é™£ç‡Ÿ</strong>ï¼ˆç´…æˆ–é»‘ï¼‰ã€‚ç¿»é–‹å¾Œï¼Œç¿»æ£‹è€…å…ˆè¡Œèµ°æ£‹ï¼Œå°æ–¹å¾Œèµ°ã€‚</p>
      </div>

      <div class="rule-section">
        <h3>æ£‹å­éšç´šèˆ‡åƒå­è¦å‰‡</h3>
        <p>ä¸€èˆ¬æ£‹å­åªèƒ½<strong>èµ°ä¸€æ ¼ï¼ˆä¸Šä¸‹å·¦å³ï¼‰</strong>ï¼Œä¸”åªèƒ½åƒæ‰<strong>éšç´šç›¸åŒæˆ–æ›´ä½</strong>çš„å°æ–¹æ£‹å­ï¼š</p>
        <div class="rank-grid">
          <div class="rank-card">
            <div class="piece-name"><span class="rn-r">å¸¥</span><span class="rn-b">å°‡</span></div>
            <div class="rank-badge">éšç´š 7ãƒ»æœ€é«˜</div>
            <div class="piece-info">æœ€å¼·æ£‹å­ï¼Œå¯åƒé™¤å…µ/å’ä»¥å¤–æ‰€æœ‰æ£‹å­</div>
          </div>
          <div class="rank-card">
            <div class="piece-name"><span class="rn-r">ä»•</span><span class="rn-b">å£«</span></div>
            <div class="rank-badge">éšç´š 6</div>
            <div class="piece-info">å¯åƒè±¡/ç›¸åŠä»¥ä¸‹</div>
          </div>
          <div class="rank-card">
            <div class="piece-name"><span class="rn-r">ç›¸</span><span class="rn-b">è±¡</span></div>
            <div class="rank-badge">éšç´š 5</div>
            <div class="piece-info">å¯åƒè»Š/ä¿¥åŠä»¥ä¸‹</div>
          </div>
          <div class="rank-card">
            <div class="piece-name"><span class="rn-r">ä¿¥</span><span class="rn-b">è»Š</span></div>
            <div class="rank-badge">éšç´š 4</div>
            <div class="piece-info">å¯åƒé¦¬/å‚ŒåŠä»¥ä¸‹</div>
          </div>
          <div class="rank-card">
            <div class="piece-name"><span class="rn-r">å‚Œ</span><span class="rn-b">é¦¬</span></div>
            <div class="rank-badge">éšç´š 3</div>
            <div class="piece-info">å¯åƒç‚®/åŒ…åŠä»¥ä¸‹</div>
          </div>
          <div class="rank-card">
            <div class="piece-name"><span class="rn-r">ç‚®</span><span class="rn-b">åŒ…</span></div>
            <div class="rank-badge">éšç´š 2ãƒ»ç‰¹æ®Š</div>
            <div class="piece-info">ç§»å‹•ï¼šæ²¿ç›´ç·šä»»æ„æ ¼ï¼ˆä¸å¯ç¿»è¶Šæ£‹å­ï¼‰<br>åƒå­ï¼šå¿…é ˆéš”ä¸€é¡†æ£‹å­ï¼ˆç ²å°ï¼‰</div>
          </div>
          <div class="rank-card">
            <div class="piece-name"><span class="rn-r">å…µ</span><span class="rn-b">å’</span></div>
            <div class="rank-badge">éšç´š 1ãƒ»ååˆ¶</div>
            <div class="piece-info">æœ€å¼±æ£‹å­ï¼Œä½†å¯ä»¥åƒæ‰å¸¥/å°‡ï¼ˆååˆ¶ç‹ç‰Œï¼‰</div>
          </div>
        </div>
      </div>

      <div class="rule-section">
        <h3>ç‰¹æ®Šè¦å‰‡</h3>
        <div class="special-rule">
          <div class="sr-title">ğŸ¯ ç‚®ï¼ˆåŒ…ï¼‰çš„ç§»å‹•èˆ‡åƒå­</div>
          <div class="sr-desc">
            ç‚®å¯æ²¿<strong>ç›´ç·šï¼ˆæ©«æˆ–ç¸±ï¼‰</strong>ç§»å‹•ä»»æ„æ ¼æ•¸åˆ°ç©ºæ ¼ã€‚<br>
            åƒå­æ™‚ï¼Œç‚®èˆ‡ç›®æ¨™ä¹‹é–“å¿…é ˆ<strong>æ°å¥½éš”ä¸€é¡†æ£‹å­</strong>ä½œç‚ºã€Œç ²å°ã€ï¼ˆç ²å°é¡è‰²ä¸é™ï¼‰ï¼Œæ‰å¯åƒæ‰ç›®æ¨™æ£‹å­ï¼ˆä¸é™éšç´šé«˜ä½ï¼Œå¯åƒä»»ä½•å°æ–¹æ£‹å­ï¼‰ã€‚
          </div>
        </div>
        <div class="special-rule">
          <div class="sr-title">âš¡ å…µ/å’ vs å¸¥/å°‡</div>
          <div class="sr-desc">
            å…µï¼ˆå’ï¼‰é›–æ˜¯æœ€å¼±æ£‹å­ï¼Œä½†å¯ä»¥åƒæ‰å¸¥ï¼ˆå°‡ï¼‰ï¼›åä¹‹ï¼Œå¸¥ï¼ˆå°‡ï¼‰ç„¡æ³•åƒå…µï¼ˆå’ï¼‰ã€‚
          </div>
        </div>
        <div class="special-rule">
          <div class="sr-title">ğŸƒ ç¿»é–‹æš—æ£‹</div>
          <div class="sr-desc">
            ç¿»é–‹ä¸€é¡†æš—æ£‹è¦–ç‚ºä¸€æ¬¡è¡Œå‹•ï¼Œç¿»é–‹å¾Œç®—å°æ–¹å›åˆã€‚ç¿»é–‹çš„æ£‹å­ç•¶å›åˆä¸èƒ½ç«‹å³ç§»å‹•ã€‚
          </div>
        </div>
        <div class="special-rule">
          <div class="sr-title">ğŸ† å‹åˆ©æ¢ä»¶</div>
          <div class="sr-desc">
            æ¶ˆæ»…å°æ–¹<strong>æ‰€æœ‰æ£‹å­</strong>ï¼ˆå«æœªç¿»é–‹ï¼‰å³ç²å‹ã€‚è‹¥ä¸€æ–¹ç„¡æ£‹å¯èµ°ï¼ˆç„¡æš—æ£‹å¯ç¿»ä¸”æ‰€æœ‰å·±æ–¹æ£‹å­è¢«å›°ï¼‰ï¼Œå‰‡è©²æ–¹èªè² ã€‚
          </div>
        </div>
      </div>

      <div class="rule-section">
        <h3>æ“ä½œèªªæ˜</h3>
        <p>â€¢ <strong>ç¿»ç‰Œ</strong>ï¼šé»æ“Šä»»æ„æš—æ£‹ï¼ˆèƒŒé¢æœä¸Šï¼‰å³å¯ç¿»é–‹</p>
        <p>â€¢ <strong>ç§»å‹•</strong>ï¼šå…ˆé»é¸å·±æ–¹æ£‹å­ï¼ˆé«˜äº®é¡¯ç¤ºï¼‰ï¼Œå†é»é¸ç›®æ¨™æ ¼ï¼ˆç¶ é»ï¼å¯ç§»å‹•ï¼Œç´…æ¡†ï¼å¯åƒå­ï¼‰</p>
        <p>â€¢ <strong>æ‚”æ£‹</strong>ï¼šæ¯å±€æœ€å¤š 3 æ¬¡ï¼Œå–®æ©Ÿæ¨¡å¼æœƒè‡ªå‹•æ’¤å› AI çš„å›åˆ</p>
      </div>
    </div>
  </div>
</div>

<!-- æˆå°±æ¨¡æ…‹æ¡† -->
<div class="modal-overlay" id="ach-modal">
  <div class="modal-box">
    <div class="modal-header">
      <h2>æˆå°±æ®¿å ‚</h2>
      <button class="modal-close" onclick="closeModal('ach-modal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="ach-progress-bar">
        <div class="ach-progress-fill" id="ach-progress-fill"></div>
      </div>
      <div style="text-align:center;font-size:12px;color:rgba(255,255,255,0.4);margin-bottom:16px;">
        å·²è§£é– <span id="ach-unlock-count" style="color:var(--gold);font-weight:700;">0</span> / <span id="ach-total-count">0</span> é …æˆå°±
      </div>
      <div class="ach-tabs" id="ach-tabs"></div>
      <div class="ach-grid" id="ach-grid"></div>
    </div>
  </div>
</div>

<!-- å‹åˆ©è¦†è“‹ -->
<div id="win-overlay">
  <div class="win-box">
    <div class="win-icon" id="win-icon">ğŸ†</div>
    <div class="win-title" id="win-title">ç²å‹ï¼</div>
    <div class="win-sub" id="win-sub">æœ¬å±€å°æˆ°çµæŸ</div>
    <button class="win-btn" onclick="closeWin();initGame();">å†æˆ°ä¸€å±€</button>
  </div>
</div>

<!-- ä¸»æ‡‰ç”¨ -->
<div id="app">
  <nav class="top-nav">
    <div class="nav-brand">
      <div>
        <h1>æš—ã€€æ£‹</h1>
        <p class="subtitle">å®®å»·ç‰ˆ Â· éš¨æ©Ÿæ£‹å±€</p>
      </div>
    </div>
    <div class="nav-actions">
      <button class="nav-btn" onclick="openModal('rules-modal')"><span class="icon">ğŸ“–</span>è¦å‰‡</button>
      <button class="nav-btn" onclick="openModal('ach-modal');renderAchGrid()"><span class="icon">ğŸ…</span>æˆå°±</button>
    </div>
  </nav>

  <div class="stats-bar">
    <div class="stat-card"><div class="stat-num win" id="s-win">0</div><div class="stat-label">å‹åˆ©</div></div>
    <div class="stat-card"><div class="stat-num lose" id="s-lose">0</div><div class="stat-label">æ•—åŒ—</div></div>
    <div class="stat-card"><div class="stat-num draw" id="s-draw">0</div><div class="stat-label">å¹³å±€</div></div>
    <div class="stat-card"><div class="stat-num total" id="s-total">0</div><div class="stat-label">ç¸½å ´æ¬¡</div></div>
    <div class="stat-card"><div class="stat-num ach" id="s-ach">0</div><div class="stat-label">æˆå°±</div></div>
  </div>

  <div class="control-panel">
    <div class="controls">
      <select id="mode-select" onchange="toggleDifficulty();initGame();">
        <option value="PvE">âš” äººæ©Ÿå°æˆ°</option>
        <option value="PvP">ğŸ‘¥ é›™äººå°æˆ°</option>
      </select>
      <div id="difficulty-container">
        <select id="ai-difficulty" onchange="initGame()">
          <option value="easy">ğŸ² è‚‰è…³ AIï¼ˆéš¨æ©Ÿï¼‰</option>
          <option value="normal" selected>ğŸ§  æ™®é€š AIï¼ˆè²ªå©ªï¼‰</option>
          <option value="hard">â™Ÿ é«˜æ‰‹ AIï¼ˆæ·±è¬€ï¼‰</option>
        </select>
      </div>
      <button class="game-btn" id="undo-btn" onclick="undoMove()">âª æ‚”æ£‹ï¼ˆ<span id="undo-count">3</span>ï¼‰</button>
      <button class="game-btn" id="restart-btn" onclick="initGame()">ğŸ”„ é‡æ–°é–‹å§‹</button>
    </div>
    <div id="info-box">è«‹ç¿»é–‹ç¬¬ä¸€é¡†æ£‹å­æ±ºå®šé™£ç‡Ÿ</div>
  </div>

  <div id="game-layout">
    <div class="board-wrap">
      <div class="board-label">æš—æ£‹æ£‹ç›¤ Â· å››è¡Œå…«åˆ— Â· å…±ä¸‰åäºŒæ ¼</div>
      <div id="board"></div>
      <div class="coord-row">
        <span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span>
        <span>äº”</span><span>å…­</span><span>ä¸ƒ</span><span>å…«</span>
      </div>
    </div>

    <div id="side-panel">
      <div class="panel-section">
        <div class="section-title red-t">ğŸ”´ ç´…æ–¹ Â· è¢«åƒæ£‹å­</div>
        <div id="captured-red" class="captured-container"></div>
      </div>
      <div class="panel-section">
        <div class="section-title blk-t">âš« é»‘æ–¹ Â· è¢«åƒæ£‹å­</div>
        <div id="captured-black" class="captured-container"></div>
      </div>
      <div class="panel-section">
        <div class="section-title log-t">ğŸ“œ å°å±€è¨˜éŒ„</div>
        <ul id="history-list"></ul>
      </div>
      <div class="panel-section">
        <div class="section-title rule-t">âš– åƒå­éšç´š</div>
        <div class="rank-table">
          <div class="rank-row"><span class="rank-pieces">å¸¥/å°‡</span><span class="rank-desc">æœ€é«˜ï¼ˆå…µ/å’é™¤å¤–ï¼‰</span></div>
          <div class="rank-row"><span class="rank-pieces">ä»•/å£« ç›¸/è±¡</span><span class="rank-desc">é«˜éš</span></div>
          <div class="rank-row"><span class="rank-pieces">ä¿¥/è»Š å‚Œ/é¦¬</span><span class="rank-desc">ä¸­éš</span></div>
          <div class="rank-row"><span class="rank-pieces">ç‚®/åŒ…</span><span class="rank-desc">éš”å­åƒï¼Œç„¡é™è·</span></div>
          <div class="rank-row"><span class="rank-pieces">å…µ/å’</span><span class="rank-desc">æœ€å¼±ï¼Œä½†å…‹å¸¥/å°‡</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ==============================================
// æ’’èŠ±ç‰¹æ•ˆ
// ==============================================
const confCanvas = document.getElementById('confetti-canvas');
const confCtx = confCanvas.getContext('2d');
let confParticles = [], confAnimId = null;

function fireConfetti() {
  confCanvas.width = window.innerWidth; confCanvas.height = window.innerHeight;
  confParticles = [];
  const colors = ['#fce18a','#ff726d','#b48def','#f4306d','#4caf50','#00bcd4','#ffd700','#ff9800','#e91e63'];
  for (let i = 0; i < 200; i++) {
    confParticles.push({
      x: Math.random() * confCanvas.width, y: Math.random() * confCanvas.height - confCanvas.height,
      r: Math.random() * 7 + 3, dx: Math.random() * 4 - 2, dy: Math.random() * 5 + 2,
      color: colors[Math.floor(Math.random() * colors.length)],
      tiltAngleInc: (Math.random() * 0.07) + 0.04, tiltAngle: 0, tilt: Math.random() * 10
    });
  }
  if (!confAnimId) animConf();
}
function animConf() {
  if (!isGameOver) { confCtx.clearRect(0,0,confCanvas.width,confCanvas.height); confAnimId=null; return; }
  confAnimId = requestAnimationFrame(animConf);
  confCtx.clearRect(0,0,confCanvas.width,confCanvas.height);
  confParticles.forEach(p => {
    p.tiltAngle += p.tiltAngleInc;
    p.y += (Math.cos(p.tiltAngle) + p.dy + p.r/2)/2;
    p.x += Math.sin(p.tiltAngle)*2 + p.dx;
    if (p.y > confCanvas.height) { p.y = -10; p.x = Math.random() * confCanvas.width; }
    confCtx.beginPath(); confCtx.lineWidth = p.r; confCtx.strokeStyle = p.color;
    confCtx.moveTo(p.x+p.tilt+p.r, p.y); confCtx.lineTo(p.x+p.tilt, p.y+p.tilt+p.r);
    confCtx.stroke();
  });
}
function stopConfetti() {
  if (confAnimId) cancelAnimationFrame(confAnimId);
  confAnimId = null; confCtx.clearRect(0,0,confCanvas.width,confCanvas.height);
}

// ==============================================
// éŸ³æ•ˆ
// ==============================================
let audioCtx = null;
function getAC() {
  if (!audioCtx) { try { audioCtx = new (window.AudioContext||window.webkitAudioContext)(); } catch(e){} }
  return audioCtx;
}
function playSound(f, d=0.1, type='square', vol=0.12) {
  const ac = getAC(); if (!ac) return;
  if (ac.state==='suspended') ac.resume();
  try {
    const o = ac.createOscillator(), g = ac.createGain();
    o.type=type; o.frequency.value=f;
    g.gain.setValueAtTime(vol, ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime+d);
    o.connect(g); g.connect(ac.destination); o.start(); o.stop(ac.currentTime+d);
  } catch(e){}
}
function playMelody(notes) {
  notes.forEach(([f,d,t,delay]) => setTimeout(()=>playSound(f,d,t||'square',0.1), delay||0));
}

// ==============================================
// æ¨¡æ…‹æ¡†
// ==============================================
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
document.querySelectorAll('.modal-overlay').forEach(el=>{
  el.addEventListener('click',e=>{ if(e.target===el) el.classList.remove('show'); });
});

// ==============================================
// æŒä¹…åŒ–å­˜å„²ï¼ˆlocalStorageï¼‰
// ==============================================
const STORAGE_KEY = 'darkchess_v3';
function loadStorage() {
  try {
    const d = localStorage.getItem(STORAGE_KEY);
    return d ? JSON.parse(d) : null;
  } catch(e) { return null; }
}
function saveStorage(data) {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e){}
}

let playerStats = { wins:0, losses:0, draws:0, totalGames:0 };
let sessionStats = {
  turnsThisGame: 0,
  piecesEaten: 0,
  cannonKills: 0,
  soldierKillsKing: 0,
  flipsThisGame: 0,
  winStreak: 0,
  loseStreak: 0,
  fastWinTurns: 999,
  undosUsed: 0,
  easyWin: false,
  normalWin: false,
  hardWin: false,
  pvpWin: false,
  totalCannonKills: 0,
  totalSoldierKillKing: 0,
  cleanWin: false, // æ²’æœ‰æ‚”æ£‹è´
};

// ==============================================
// æˆå°±å®šç¾©ï¼ˆ25ç¨®ï¼‰
// ==============================================
const ACHIEVEMENTS = [
  // æ–°æ‰‹
  { id:'first_flip',    name:'åˆæ¢æš—æ£‹',      icon:'ğŸ´', desc:'ç¿»é–‹ç¬¬ä¸€é¡†æ£‹å­',              rarity:'common',    cat:'æ–°æ‰‹', secret:false },
  { id:'first_win',     name:'é¦–å‹',          icon:'ğŸ‰', desc:'è´å¾—ç¬¬ä¸€å ´å°å±€',              rarity:'common',    cat:'æ–°æ‰‹', secret:false },
  { id:'first_cannon',  name:'ç ²ç«åˆè©¦',      icon:'ğŸ’¥', desc:'ç”¨ç‚®/åŒ…æˆåŠŸåƒæ‰ä¸€é¡†æ£‹å­',    rarity:'common',    cat:'æ–°æ‰‹', secret:false },
  { id:'first_soldier_king', name:'ä»¥å¼±å‹å¼·', icon:'âš¡', desc:'ç”¨å…µ/å’åƒæ‰å¸¥/å°‡',           rarity:'common',    cat:'æ–°æ‰‹', secret:false },

  // å‹å ´ç´¯ç©
  { id:'win5',          name:'äº”é€£æ·',        icon:'ğŸŒŸ', desc:'ç´¯ç©è´å¾— 5 å ´å°å±€',           rarity:'common',    cat:'å‹å ´', secret:false },
  { id:'win10',         name:'åå‹',          icon:'ğŸ–', desc:'ç´¯ç©è´å¾— 10 å ´å°å±€',          rarity:'rare',      cat:'å‹å ´', secret:false },
  { id:'win25',         name:'èº«ç¶“ç™¾æˆ°',      icon:'ğŸ…', desc:'ç´¯ç©è´å¾— 25 å ´å°å±€',          rarity:'rare',      cat:'å‹å ´', secret:false },
  { id:'win50',         name:'æ£‹å£‡å®—å¸«',      icon:'ğŸ‘‘', desc:'ç´¯ç©è´å¾— 50 å ´å°å±€',          rarity:'epic',      cat:'å‹å ´', secret:false },

  // AI é›£åº¦
  { id:'beat_easy',     name:'ç†±èº«å®Œç•¢',      icon:'ğŸ˜', desc:'æ“Šæ•—è‚‰è…³ AI',                 rarity:'common',    cat:'æŒ‘æˆ°', secret:false },
  { id:'beat_normal',   name:'ç•¥æœ‰å°æˆ',      icon:'ğŸ§ ', desc:'æ“Šæ•—æ™®é€š AI',                 rarity:'rare',      cat:'æŒ‘æˆ°', secret:false },
  { id:'beat_hard',     name:'é«˜æ‰‹éæ‹›',      icon:'â™Ÿ',  desc:'æ“Šæ•—é«˜æ‰‹ AI',                rarity:'epic',      cat:'æŒ‘æˆ°', secret:false },
  { id:'beat_pvp',      name:'å®¿æ•µ',          icon:'ğŸ‘¥', desc:'åœ¨é›™äººå°æˆ°ä¸­ç²å‹',            rarity:'rare',      cat:'æŒ‘æˆ°', secret:false },

  // é¢¨æ ¼
  { id:'fast_win',      name:'é–ƒé›»æˆ°',        icon:'âš¡', desc:'åœ¨ 15 å›åˆå…§ç²å‹',            rarity:'rare',      cat:'é¢¨æ ¼', secret:false },
  { id:'clean_win',     name:'å…‰æ˜æ­£å¤§',      icon:'âœ¨', desc:'ä¸ä½¿ç”¨ä»»ä½•æ‚”æ£‹è´å¾—å°å±€',      rarity:'rare',      cat:'é¢¨æ ¼', secret:false },
  { id:'cannon_master', name:'ç‚®å…µå¤§å¸«',      icon:'ğŸ’£', desc:'å–®å±€ç”¨ç‚®/åŒ…åƒæ‰ 3 é¡†æ£‹å­',    rarity:'epic',      cat:'é¢¨æ ¼', secret:false },
  { id:'eat_7',         name:'å¤§èƒƒç‹',        icon:'ğŸ˜‹', desc:'å–®å±€åƒæ‰ 7 é¡†æ£‹å­',           rarity:'rare',      cat:'é¢¨æ ¼', secret:false },
  { id:'flip_master',   name:'ç¿»ç‰Œç‹‚äºº',      icon:'ğŸƒ', desc:'å–®å±€ç¿»é–‹è¶…é 15 é¡†æš—æ£‹',      rarity:'rare',      cat:'é¢¨æ ¼', secret:false },

  // ç¨€æœ‰
  { id:'cannon5',       name:'ç ²ç«é€£å¤©',      icon:'ğŸ”¥', desc:'ç´¯è¨ˆç”¨ç‚®/åŒ…åƒæ‰ 5 é¡†æ£‹å­',    rarity:'epic',      cat:'ç¨€æœ‰', secret:false },
  { id:'soldier_king3', name:'ä»¥å°åšå¤§',      icon:'ğŸ‰', desc:'ç´¯è¨ˆç”¨å…µ/å’åƒæ‰å¸¥/å°‡ 3 æ¬¡',   rarity:'epic',      cat:'ç¨€æœ‰', secret:false },
  { id:'comeback',      name:'çµ•åœ°åæ”»',      icon:'ğŸ”„', desc:'ä½¿ç”¨ 3 æ¬¡æ‚”æ£‹å¾Œä»ç„¶è´å¾—æ¯”è³½', rarity:'epic',      cat:'ç¨€æœ‰', secret:true  },

  // å‚³èªª
  { id:'no_loss',       name:'ä¸æ•—é‡‘èº«',      icon:'ğŸ›¡', desc:'é€£è´ 5 å ´ä¸æ•—',               rarity:'legendary', cat:'å‚³èªª', secret:false },
  { id:'legend',        name:'æš—æ£‹å‚³èªª',      icon:'ğŸŒ™', desc:'ç´¯è¨ˆéŠæˆ² 100 å ´',             rarity:'legendary', cat:'å‚³èªª', secret:false },
  { id:'all_diff',      name:'å…¨èƒ½æ£‹æ‰‹',      icon:'ğŸ­', desc:'æ“Šæ•—æ‰€æœ‰é›£åº¦ AI ä¸”è´éé›™äººå°æˆ°', rarity:'legendary', cat:'å‚³èªª', secret:false },
  { id:'secret_flip',   name:'å‘½é‹ç¿»è½‰',      icon:'ğŸŒ€', desc:'é¦–ç¿»ç¿»åˆ°å°æ–¹çš„å¸¥/å°‡',         rarity:'legendary', cat:'å‚³èªª', secret:true  },
  { id:'dominator',     name:'å®Œå…¨åˆ¶éœ¸',      icon:'âšœ', desc:'è§£é–æ‰€æœ‰å…¶ä»–æˆå°±',            rarity:'legendary', cat:'å‚³èªª', secret:false },
];

const CATEGORIES = ['å…¨éƒ¨','æ–°æ‰‹','å‹å ´','æŒ‘æˆ°','é¢¨æ ¼','ç¨€æœ‰','å‚³èªª'];
let currentAchTab = 'å…¨éƒ¨';

let unlockedAchievements = {}; // { id: timestamp }

function loadAchievements() {
  const d = loadStorage();
  if (d) {
    unlockedAchievements = d.achievements || {};
    playerStats = { ...playerStats, ...(d.stats||{}) };
    sessionStats.winStreak = d.winStreak || 0;
    sessionStats.loseStreak = d.loseStreak || 0;
  }
}

function saveAchievements() {
  const d = loadStorage() || {};
  d.achievements = unlockedAchievements;
  d.stats = playerStats;
  d.winStreak = sessionStats.winStreak;
  d.loseStreak = sessionStats.loseStreak;
  saveStorage(d);
}

function unlockAchievement(id) {
  if (unlockedAchievements[id]) return;
  const ach = ACHIEVEMENTS.find(a=>a.id===id);
  if (!ach) return;
  unlockedAchievements[id] = Date.now();
  saveAchievements();
  showAchToast(ach);
  updateStatsUI();
  // æª¢æŸ¥æ˜¯å¦è§£é–æ‰€æœ‰æˆå°±
  const allExceptDominator = ACHIEVEMENTS.filter(a=>a.id!=='dominator');
  if (allExceptDominator.every(a=>unlockedAchievements[a.id])) {
    setTimeout(()=>unlockAchievement('dominator'), 800);
  }
}

function showAchToast(ach) {
  playMelody([[523,0.08,'sine'],[659,0.08,'sine'],[784,0.15,'sine']], );
  playSound(523,0.08,'sine');setTimeout(()=>playSound(659,0.08,'sine'),80);setTimeout(()=>playSound(784,0.15,'sine'),160);
  const container = document.getElementById('ach-toast');
  const el = document.createElement('div');
  el.className = 'ach-toast-item';
  el.innerHTML = `
    <div class="ach-toast-icon">${ach.icon}</div>
    <div class="ach-toast-text">
      <div class="ach-toast-label">ğŸ… æˆå°±è§£é–ï¼</div>
      <div class="ach-toast-name">${ach.name}</div>
      <div class="ach-toast-desc">${ach.desc}</div>
    </div>`;
  container.appendChild(el);
  setTimeout(()=>{
    el.classList.add('out');
    setTimeout(()=>el.remove(), 350);
  }, 3500);
}

function renderAchGrid() {
  // æ¨™ç±¤
  const tabsEl = document.getElementById('ach-tabs');
  tabsEl.innerHTML = '';
  CATEGORIES.forEach(cat=>{
    const btn = document.createElement('button');
    btn.className = 'ach-tab' + (currentAchTab===cat?' active':'');
    const count = cat==='å…¨éƒ¨'
      ? ACHIEVEMENTS.length
      : ACHIEVEMENTS.filter(a=>a.cat===cat).length;
    btn.textContent = `${cat} (${count})`;
    btn.onclick = ()=>{ currentAchTab=cat; renderAchGrid(); };
    tabsEl.appendChild(btn);
  });

  const unlocked = Object.keys(unlockedAchievements).length;
  const total = ACHIEVEMENTS.length;
  document.getElementById('ach-unlock-count').textContent = unlocked;
  document.getElementById('ach-total-count').textContent = total;
  document.getElementById('ach-progress-fill').style.width = (unlocked/total*100)+'%';

  const grid = document.getElementById('ach-grid');
  grid.innerHTML = '';

  const filtered = currentAchTab==='å…¨éƒ¨'
    ? ACHIEVEMENTS
    : ACHIEVEMENTS.filter(a=>a.cat===currentAchTab);

  filtered.forEach(ach=>{
    const isUnlocked = !!unlockedAchievements[ach.id];
    const card = document.createElement('div');
    card.className = 'ach-card' + (isUnlocked?' unlocked':'') + (ach.secret&&!isUnlocked?' secret':'');

    const rarityLabel = {common:'æ™®é€š',rare:'ç¨€æœ‰',epic:'å²è©©',legendary:'å‚³èªª'}[ach.rarity];
    const rarityClass = 'rarity-'+ach.rarity;

    const dateStr = isUnlocked
      ? new Date(unlockedAchievements[ach.id]).toLocaleDateString('zh-TW')
      : '';

    const displayName = ach.secret && !isUnlocked ? '????' : ach.name;
    const displayDesc = ach.secret && !isUnlocked ? 'éš±è—æˆå°±ï¼Œç¹¼çºŒéŠç©ä»¥è§£é–' : ach.desc;
    const displayIcon = ach.secret && !isUnlocked ? 'ğŸ”’' : ach.icon;

    card.innerHTML = `
      ${isUnlocked?'<div class="ach-shimmer"></div>':''}
      <div class="ach-icon">${displayIcon}</div>
      <span class="ach-rarity ${rarityClass}">${rarityLabel}</span>
      <div class="ach-name">${displayName}</div>
      <div class="ach-desc">${displayDesc}</div>
      ${isUnlocked?`<div class="ach-unlock-date">âœ“ ${dateStr} è§£é–</div>`:''}
      <div class="ach-lock-icon">ğŸ”’</div>`;
    grid.appendChild(card);
  });
}

// ==============================================
// æ£‹å­å®šç¾©
// ==============================================
const pieceTypes = [
  {name:'å¸¥',color:'red',rank:7},{name:'å°‡',color:'black',rank:7},
  {name:'ä»•',color:'red',rank:6},{name:'ä»•',color:'red',rank:6},
  {name:'å£«',color:'black',rank:6},{name:'å£«',color:'black',rank:6},
  {name:'ç›¸',color:'red',rank:5},{name:'ç›¸',color:'red',rank:5},
  {name:'è±¡',color:'black',rank:5},{name:'è±¡',color:'black',rank:5},
  {name:'ä¿¥',color:'red',rank:4},{name:'ä¿¥',color:'red',rank:4},
  {name:'è»Š',color:'black',rank:4},{name:'è»Š',color:'black',rank:4},
  {name:'å‚Œ',color:'red',rank:3},{name:'å‚Œ',color:'red',rank:3},
  {name:'é¦¬',color:'black',rank:3},{name:'é¦¬',color:'black',rank:3},
  {name:'ç‚®',color:'red',rank:2},{name:'ç‚®',color:'red',rank:2},
  {name:'åŒ…',color:'black',rank:2},{name:'åŒ…',color:'black',rank:2},
  {name:'å…µ',color:'red',rank:1},{name:'å…µ',color:'red',rank:1},{name:'å…µ',color:'red',rank:1},
  {name:'å…µ',color:'red',rank:1},{name:'å…µ',color:'red',rank:1},
  {name:'å’',color:'black',rank:1},{name:'å’',color:'black',rank:1},{name:'å’',color:'black',rank:1},
  {name:'å’',color:'black',rank:1},{name:'å’',color:'black',rank:1}
];

// ==============================================
// éŠæˆ²ç‹€æ…‹
// ==============================================
let board=[], selectedIdx=-1, validMoves=[], turn='none', isGameOver=false;
let capturedPieces={red:[],black:[]}, historyStack=[], logStack=[];
let aiColor=null, aiTimeoutId=null, undoRemaining=3;
let gameMode='PvE', aiDifficulty='normal';
let lastMovedIdx=-1;

// æœ¬å±€çµ±è¨ˆ
let gs = {}; // game session stats

function resetGameSession() {
  gs = {
    turns: 0,
    eaten: 0,
    cannonKills: 0,
    soldierKillKing: 0,
    flips: 0,
    undosUsed: 0,
    firstFlipDone: false,
    firstFlipPiece: null,
  };
}

// ==============================================
// UI æ›´æ–°
// ==============================================
function updateStatsUI() {
  document.getElementById('s-win').textContent   = playerStats.wins;
  document.getElementById('s-lose').textContent  = playerStats.losses;
  document.getElementById('s-draw').textContent  = playerStats.draws;
  document.getElementById('s-total').textContent = playerStats.totalGames;
  document.getElementById('s-ach').textContent   = Object.keys(unlockedAchievements).length;
}

function toggleDifficulty() {
  const mode = document.getElementById('mode-select').value;
  const dc = document.getElementById('difficulty-container');
  dc.style.opacity = mode==='PvE'?'1':'0.3';
  dc.style.pointerEvents = mode==='PvE'?'auto':'none';
}

function setInfo(text, color) {
  const el = document.getElementById('info-box');
  el.textContent = text; el.style.color = color||'#fff';
}

function updateInfo() {
  if (isGameOver) return;
  const isAI = (gameMode==='PvE' && turn===aiColor);
  const label = turn==='red' ? 'ğŸ”´ ç´…æ–¹' : 'âš« é»‘æ–¹';
  const who = isAI ? 'ğŸ¤– AI æ€è€ƒä¸­â€¦' : 'ğŸ‘¤ ä½ çš„å›åˆ';
  setInfo(`${label} Â· ${who}`, turn==='red'?'#ef9a9a':'#90a4ae');
}

function updateUndoUI() {
  document.getElementById('undo-count').textContent = undoRemaining;
  document.getElementById('undo-btn').disabled = (undoRemaining<=0||historyStack.length===0||isGameOver);
}

// ==============================================
// éŠæˆ²åˆå§‹åŒ–
// ==============================================
function initGame() {
  if (aiTimeoutId) clearTimeout(aiTimeoutId);
  stopConfetti();
  closeWin();
  undoRemaining = 3;
  gameMode = document.getElementById('mode-select').value;
  aiDifficulty = document.getElementById('ai-difficulty').value;
  aiColor=null; isGameOver=false; turn='none';
  selectedIdx=-1; validMoves=[]; lastMovedIdx=-1;
  capturedPieces={red:[],black:[]}; historyStack=[]; logStack=[];
  resetGameSession();

  let shuffled = [...pieceTypes].sort(()=>Math.random()-0.5);
  board = shuffled.map(p=>({piece:{...p}, isFaceUp:false, isEmpty:false}));

  renderBoard(); renderCaptured(); renderLog(); updateUndoUI();
  setInfo('è«‹ç¿»é–‹ç¬¬ä¸€é¡†æ£‹å­æ±ºå®šé™£ç‡Ÿ','#c9a84c');
}

// ==============================================
// æ ¸å¿ƒè¦å‰‡
// ==============================================
function canMove(from, to) {
  if (from<0||to<0||from===to) return false;
  const f=board[from], t=board[to];
  if (f.isEmpty||!f.isFaceUp) return false;
  if (!t.isEmpty&&!t.isFaceUp) return false; // ä¸èƒ½èµ°åˆ°æœªç¿»é¢æ£‹å­

  const r1=Math.floor(from/8), c1=from%8;
  const r2=Math.floor(to/8),   c2=to%8;
  const sameRow=(r1===r2), sameCol=(c1===c2);
  const dist = Math.abs(r1-r2)+Math.abs(c1-c2);

  // ç‚®/åŒ…
  if (f.piece.rank===2) {
    if (!sameRow&&!sameCol) return false;
    let cnt=0;
    if (sameRow) { for(let c=Math.min(c1,c2)+1;c<Math.max(c1,c2);c++) if(!board[r1*8+c].isEmpty) cnt++; }
    else         { for(let r=Math.min(r1,r2)+1;r<Math.max(r1,r2);r++) if(!board[r*8+c1].isEmpty) cnt++; }
    if (t.isEmpty) return cnt===0;          // ç§»å‹•åˆ°ç©ºæ ¼ï¼šä¸­é–“ä¸èƒ½æœ‰å­
    return cnt===1 && f.piece.color!==t.piece.color; // åƒå­ï¼šå¿…é ˆéš”ä¸€å­ï¼Œä¸”åƒå°æ–¹
  }

  // ä¸€èˆ¬æ£‹å­ï¼šåªèµ°ç›¸é„°ä¸€æ ¼
  if (dist!==1) return false;
  if (t.isEmpty) return true;
  if (f.piece.color===t.piece.color) return false;
  if (f.piece.rank===1 && t.piece.rank===7) return true;  // å…µåƒå¸¥
  if (f.piece.rank===7 && t.piece.rank===1) return false; // å¸¥ä¸èƒ½åƒå…µ
  return f.piece.rank >= t.piece.rank;
}

// ==============================================
// å‹•ä½œè™•ç†
// ==============================================
function processAction(idx) {
  if (isGameOver||(gameMode==='PvE'&&turn===aiColor)) return;
  getAC(); // å•Ÿå‹• AudioContext

  const sq = board[idx];

  if (sq.isEmpty) {
    if (selectedIdx!==-1 && canMove(selectedIdx, idx)) executeMove(selectedIdx, idx);
    else { selectedIdx=-1; validMoves=[]; renderBoard(); }
    return;
  }

  if (!sq.isFaceUp) {
    if (selectedIdx!==-1) { selectedIdx=-1; validMoves=[]; renderBoard(); return; }
    doFlip(idx);
    return;
  }

  // æ­£é¢æ£‹å­
  if (sq.piece.color===turn) {
    selectedIdx=idx; validMoves=[];
    for(let i=0;i<32;i++) if(canMove(idx,i)) validMoves.push(i);
    renderBoard(); playSound(350, 0.06,'sine');
  } else if (selectedIdx!==-1 && canMove(selectedIdx, idx)) {
    executeMove(selectedIdx, idx);
  } else {
    selectedIdx=-1; validMoves=[]; renderBoard();
  }
}

function doFlip(idx, isAI=false) {
  const sq = board[idx];
  const mover = turn==='none' ? 'é¦–ç¿»' : (turn==='red'?'ğŸ”´ ç´…':'âš« é»‘');
  saveState(`${mover} ç¿»é–‹ ã€${sq.piece.name}ã€‘`);
  sq.isFaceUp = true;
  gs.flips++;
  playSound(600, 0.12, 'sine');

  if (turn==='none') {
    // é¦–ç¿»æ±ºå®šé™£ç‡Ÿï¼šç¿»é–‹è€…å…ˆè¡Œ
    aiColor = sq.piece.color==='red' ? 'black' : 'red';
    turn = sq.piece.color;

    // æˆå°±ï¼šé¦–ç¿»
    if (!gs.firstFlipDone) {
      gs.firstFlipDone = true;
      gs.firstFlipPiece = {...sq.piece};
      unlockAchievement('first_flip');
      // éš±è—æˆå°±ï¼šé¦–ç¿»ç¿»åˆ°å¸¥/å°‡
      if (sq.piece.rank===7) unlockAchievement('secret_flip');
    }
  }

  // ç¿»ç‰Œå‹•ç•«
  const cells = document.getElementById('board').children;
  if (cells[idx]) {
    cells[idx].classList.add('flipping');
    setTimeout(()=>cells[idx].classList.remove('flipping'), 350);
  }

  renderBoard();
  switchTurn();
}

function executeMove(f, t) {
  const isCapture = !board[t].isEmpty;
  const logEntry = `${turn==='red'?'ğŸ”´ ç´…':'âš« é»‘'} ã€${board[f].piece.name}ã€‘${isCapture?'åƒ':'â†’'} ${isCapture?'ã€'+board[t].piece.name+'ã€‘':posStr(t)}`;
  saveState(logEntry);

  if (isCapture) {
    const victim = board[t].piece;
    capturedPieces[victim.color].push(victim);
    gs.eaten++;

    // ç‚®åƒå­çµ±è¨ˆ
    if (board[f].piece.rank===2) {
      gs.cannonKills++;
      sessionStats.totalCannonKills++;
      unlockAchievement('first_cannon');
      if (gs.cannonKills>=3) unlockAchievement('cannon_master');
      if (sessionStats.totalCannonKills>=5) unlockAchievement('cannon5');
    }
    // å…µåƒå¸¥
    if (board[f].piece.rank===1 && victim.rank===7) {
      gs.soldierKillKing++;
      sessionStats.totalSoldierKillKing++;
      unlockAchievement('first_soldier_king');
      if (sessionStats.totalSoldierKillKing>=3) unlockAchievement('soldier_king3');
    }

    if (gs.eaten>=7) unlockAchievement('eat_7');
    playSound(800, 0.18, 'square');
  } else {
    playSound(280, 0.1, 'sine');
  }

  board[t] = {...board[f]};
  board[f] = {piece:null, isFaceUp:false, isEmpty:true};
  lastMovedIdx = t;
  selectedIdx=-1; validMoves=[];
  gs.turns++;
  renderCaptured(); switchTurn(); renderBoard();
}

function posStr(idx) {
  const rows=['ä¸€','äºŒ','ä¸‰','å››'];
  return `${rows[Math.floor(idx/8)]}è¡Œ${idx%8+1}åˆ—`;
}

function saveState(m) {
  historyStack.push({
    board: JSON.parse(JSON.stringify(board)),
    turn, aiColor,
    capturedPieces: JSON.parse(JSON.stringify(capturedPieces)),
    lastMovedIdx
  });
  logStack.push(m); renderLog(); updateUndoUI();
}

function undoMove() {
  if (undoRemaining<=0||historyStack.length===0) return;
  if (aiTimeoutId) clearTimeout(aiTimeoutId);
  undoRemaining--;
  gs.undosUsed++;
  playSound(380, 0.18, 'triangle');
  let s = historyStack.pop(); logStack.pop();
  if (gameMode==='PvE' && historyStack.length>0 && s.turn===aiColor) {
    s = historyStack.pop(); logStack.pop();
  }
  board=s.board; turn=s.turn; aiColor=s.aiColor;
  capturedPieces=s.capturedPieces; lastMovedIdx=s.lastMovedIdx;
  selectedIdx=-1; validMoves=[];
  renderBoard(); renderCaptured(); renderLog(); updateUndoUI(); updateInfo();
}

// ==============================================
// å›åˆåˆ‡æ› & å‹è² åˆ¤å®š
// ==============================================
function switchTurn() {
  turn = turn==='red'?'black':'red';
  updateInfo();
  checkGameOver();
}

function checkHasAction(color) {
  if (board.some(s=>!s.isEmpty&&!s.isFaceUp)) return true;
  for (let i=0;i<32;i++) {
    if (!board[i].isEmpty&&board[i].isFaceUp&&board[i].piece.color===color)
      for (let j=0;j<32;j++) if(canMove(i,j)) return true;
  }
  return false;
}

function checkGameOver() {
  let totalRed=0, totalBlack=0;
  board.forEach(s=>{
    if (!s.isEmpty) { if(s.piece.color==='red') totalRed++; else totalBlack++; }
  });
  const anyFaceUp = board.some(s=>!s.isEmpty&&s.isFaceUp);
  if (!anyFaceUp) {
    if (gameMode==='PvE'&&turn===aiColor) aiTimeoutId=setTimeout(performAITurn,800);
    return;
  }

  let winner=null, reason='';
  if (totalRed===0) { winner='black'; reason='ç´…æ–¹æ£‹å­å…¨æ»…'; }
  else if (totalBlack===0) { winner='red'; reason='é»‘æ–¹æ£‹å­å…¨æ»…'; }
  else if (!checkHasAction(turn)) { winner=turn==='red'?'black':'red'; reason=`${turn==='red'?'ç´…':'é»‘'}æ–¹ç„¡æ£‹å¯èµ°`; }

  if (winner) {
    endGame(winner, reason); return;
  }
  if (gameMode==='PvE'&&turn===aiColor) aiTimeoutId=setTimeout(performAITurn,800);
}

function endGame(winner, reason) {
  isGameOver=true; updateUndoUI();
  playerStats.totalGames++;

  // åˆ¤æ–·ç©å®¶é¡è‰²
  const playerColor = gameMode==='PvE' ? (aiColor==='red'?'red':'black') : null;
  // PvP æƒ…æ³ winner å³èª°è´ï¼ŒPvE çœ‹ playerColor
  const playerWon = gameMode==='PvE' ? winner===playerColor : false; // PvP æš«å®šç´…æ–¹ç‚º P1
  const playerWonPvP = gameMode==='PvP' && winner==='red'; // PvP ç´…æ–¹ç®— P1 è´

  if (gameMode==='PvE') {
    if (playerWon) {
      playerStats.wins++;
      sessionStats.winStreak = (sessionStats.winStreak||0)+1;
      sessionStats.loseStreak = 0;
    } else {
      playerStats.losses++;
      sessionStats.loseStreak = (sessionStats.loseStreak||0)+1;
      sessionStats.winStreak = 0;
    }
  } else {
    // PvP
    playerStats.wins += (winner==='red'?1:0);
    if (winner==='red') { sessionStats.winStreak++; sessionStats.loseStreak=0; }
    else { sessionStats.loseStreak++; sessionStats.winStreak=0; }
  }

  saveAchievements(); updateStatsUI();

  // æˆå°±è§£é–
  if (gameMode==='PvE' && playerWon) {
    unlockAchievement('first_win');
    if (aiDifficulty==='easy') unlockAchievement('beat_easy');
    if (aiDifficulty==='normal') unlockAchievement('beat_normal');
    if (aiDifficulty==='hard') unlockAchievement('beat_hard');
    if (gs.turns<=15) unlockAchievement('fast_win');
    if (gs.undosUsed===0) unlockAchievement('clean_win');
    if (gs.undosUsed>=3) unlockAchievement('comeback');
    if (gs.flips>15) unlockAchievement('flip_master');
  }
  if (gameMode==='PvP' && winner) unlockAchievement('beat_pvp');
  if (playerStats.wins>=5) unlockAchievement('win5');
  if (playerStats.wins>=10) unlockAchievement('win10');
  if (playerStats.wins>=25) unlockAchievement('win25');
  if (playerStats.wins>=50) unlockAchievement('win50');
  if (sessionStats.winStreak>=5) unlockAchievement('no_loss');
  if (playerStats.totalGames>=100) unlockAchievement('legend');
  // all_diffï¼šä¸‰ç¨®é›£åº¦+PvPéƒ½è§£é–
  if (unlockedAchievements['beat_easy']&&unlockedAchievements['beat_normal']&&unlockedAchievements['beat_hard']&&unlockedAchievements['beat_pvp'])
    unlockAchievement('all_diff');

  // UI
  const winColor = winner==='red';
  const winLabel = winColor ? 'ğŸ”´ ç´…æ–¹' : 'âš« é»‘æ–¹';
  setInfo(`ğŸ† ${winLabel}ç²å‹ï¼ï¼ˆ${reason}ï¼‰`, winColor?'#ef9a9a':'#90a4ae');

  // éŸ³æ•ˆ
  playMelody([[500,0.1],[0,0],[650,0.1],[0,0],[800,0.4]].map((v,i)=>[v[0],v[1],'sine',i*130]));

  // é¡¯ç¤ºå‹åˆ©è¦†è“‹
  setTimeout(()=>{
    document.getElementById('win-icon').textContent = winColor?'ğŸ”´':'âš«';
    document.getElementById('win-title').textContent = `${winLabel} ç²å‹ï¼`;
    document.getElementById('win-sub').textContent = reason + (gameMode==='PvE'?` Â· ${aiDifficulty==='easy'?'è‚‰è…³':aiDifficulty==='normal'?'æ™®é€š':'é«˜æ‰‹'} AI`:'');
    document.getElementById('win-overlay').classList.add('show');
    fireConfetti();
  }, 800);
}

function closeWin() {
  document.getElementById('win-overlay').classList.remove('show');
  stopConfetti();
}

// ==============================================
// AI ç³»çµ±
// ==============================================
function checkThreat(idx, color) {
  for (let i=0;i<32;i++) {
    if (!board[i].isEmpty&&board[i].isFaceUp&&board[i].piece.color!==color)
      if (canMove(i,idx)) return true;
  }
  return false;
}

function simThreat(fromIdx, toIdx, myPiece) {
  const tb=board[toIdx], fb=board[fromIdx];
  board[toIdx]={isEmpty:false,isFaceUp:true,piece:myPiece};
  board[fromIdx]={isEmpty:true,isFaceUp:false,piece:null};
  const t=checkThreat(toIdx, myPiece.color);
  board[toIdx]=tb; board[fromIdx]=fb;
  return t;
}

function performAITurn() {
  if (isGameOver||turn!==aiColor) return;
  let acts=[], hids=[];

  for (let i=0;i<32;i++) {
    if (!board[i].isEmpty&&!board[i].isFaceUp) hids.push(i);
    if (!board[i].isEmpty&&board[i].isFaceUp&&board[i].piece.color===aiColor) {
      for (let j=0;j<32;j++) {
        if (!canMove(i,j)) continue;
        let score=0;
        const tp = (!board[j].isEmpty&&board[j].isFaceUp)?board[j].piece:null;
        const mp = board[i].piece;
        const threatened = checkThreat(i, aiColor);
        const safeAfter = !simThreat(i, j, mp);

        if (aiDifficulty==='easy') {
          score = (tp?tp.rank*8:0) + Math.random()*100;
        } else if (aiDifficulty==='normal') {
          if (tp) score += tp.rank*10;
          if (threatened&&safeAfter) score += 25;
          score += Math.random()*5;
        } else { // hard
          if (tp) {
            if (safeAfter) score += tp.rank*55;
            else score += (tp.rank>mp.rank ? (tp.rank-mp.rank)*15 : -mp.rank*55);
          } else {
            if (threatened) score += safeAfter ? mp.rank*45 : -mp.rank*55;
            else score += safeAfter ? 2 : -mp.rank*55;
          }
          score += Math.random()*2.5;
        }
        acts.push({f:i,t:j,s:score});
      }
    }
  }

  acts.sort((a,b)=>b.s-a.s);
  const flipThreshold = aiDifficulty==='easy'?50 : aiDifficulty==='hard'?2 : 5;

  if (acts.length>0 && (acts[0].s>flipThreshold||hids.length===0)) {
    executeMove(acts[0].f, acts[0].t);
  } else if (hids.length>0) {
    doFlip(hids[Math.floor(Math.random()*hids.length)], true);
  } else if (acts.length>0) {
    executeMove(acts[0].f, acts[0].t);
  }
}

// ==============================================
// æ¸²æŸ“
// ==============================================
function renderBoard() {
  const b = document.getElementById('board');
  b.innerHTML='';
  board.forEach((s,i)=>{
    const c = document.createElement('div');
    let cls='cell';
    if (s.isEmpty) cls+=' empty';
    else if (!s.isFaceUp) cls+=' hidden';

    if (s.isFaceUp&&!s.isEmpty) {
      c.textContent=s.piece.name;
      cls+=' '+(s.piece.color==='red'?'red-p':'black-p');
    }
    if (i===selectedIdx) cls+=' selected';
    if (i===lastMovedIdx&&!s.isEmpty) cls+=' last-moved';
    if (validMoves.includes(i)) cls+=s.isEmpty?' valid-move':' valid-capture';

    c.className=cls;
    c.onclick=()=>processAction(i);
    b.appendChild(c);
  });
}

function renderCaptured() {
  ['red','black'].forEach(color=>{
    const el=document.getElementById('captured-'+color);
    el.innerHTML='';
    capturedPieces[color].forEach(p=>{
      const d=document.createElement('div');
      d.className='captured-piece cp-'+(p.color==='red'?'red':'blk');
      d.textContent=p.name;
      el.appendChild(d);
    });
  });
}

function renderLog() {
  const l=document.getElementById('history-list');
  l.innerHTML=logStack.map((s,i)=>`<li>${i+1}. ${s}</li>`).join('');
  l.scrollTop=l.scrollHeight;
}

// ==============================================
// å•Ÿå‹•
// ==============================================
loadAchievements();
updateStatsUI();
toggleDifficulty();
initGame();

window.addEventListener('resize',()=>{
  if (confAnimId) { confCanvas.width=window.innerWidth; confCanvas.height=window.innerHeight; }
});
</script>
</body>
</html>