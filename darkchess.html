<!DOCTYPE html>
<html lang="zh-TW" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æš—æ£‹ Â· å®®å»·ç‰ˆ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700;900&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
<style>
/* ================================================
   ä¸»é¡Œç³»çµ±ï¼ˆCSS è®Šæ•¸åˆ‡æ›ï¼‰
   ================================================ */

/* ä¸»é¡Œä¸€ï¼šæš—å¤œç„é‡‘ï¼ˆåŸç‰ˆæ·±è‰²ï¼‰ */
[data-theme="dark"] {
  --bg-base:       #0a0300;
  --bg-mid:        #160800;
  --bg-panel:      rgba(18,8,0,0.94);
  --bg-card:       rgba(20,10,0,0.90);
  --bg-card-hover: rgba(30,15,0,0.95);
  --bg-input:      rgba(15,6,0,0.85);
  --bg-inset:      rgba(0,0,0,0.30);
  --text-main:     #f5e6c8;
  --text-dim:      rgba(245,230,200,0.55);
  --text-mute:     rgba(245,230,200,0.30);
  --border:        rgba(201,168,76,0.28);
  --border-hover:  rgba(201,168,76,0.55);
  --accent:        #c9a84c;
  --accent-light:  #f0d080;
  --accent-glow:   rgba(201,168,76,0.25);
  --shadow-color:  rgba(0,0,0,0.75);
  --modal-bg:      #120800;
  --modal-sticky:  #120800;
  --info-bg:       rgba(15,6,0,0.92);
  --body-grid:     rgba(201,168,76,0.03);
  --board-bg:      radial-gradient(ellipse at 30% 20%,#8a5025,#6b3a1f 40%,#4a2508 70%,#3d1f0a);
  --board-border:  #2a1008;
  --board-outline: rgba(10,4,0,0.9);
  --scroll-thumb:  rgba(201,168,76,0.25);
  --ach-bg:        linear-gradient(135deg,rgba(15,8,0,0.9),rgba(8,4,0,0.95));
  --ach-bg-unlock: linear-gradient(135deg,rgba(30,16,0,0.95),rgba(15,8,0,0.98));
  --win-bg:        linear-gradient(160deg,#1a0a00,#0a0400);
  --rank-card-bg:  rgba(0,0,0,0.30);
  --special-rule-bg: rgba(201,168,76,0.06);
  --btn-accent-end: #7a4a00;
}

/* ä¸»é¡ŒäºŒï¼šå®£ç´™å¤å·ï¼ˆæš–è‰²ç±³ç™½ï¼‰ */
[data-theme="paper"] {
  --btn-accent-end: #5a3c00;
  --bg-base:       #f0e8d0;
  --bg-mid:        #e8dcc0;
  --bg-panel:      rgba(240,232,208,0.96);
  --bg-card:       rgba(235,225,200,0.92);
  --bg-card-hover: rgba(228,218,190,0.97);
  --bg-input:      rgba(220,210,185,0.90);
  --bg-inset:      rgba(160,130,80,0.10);
  --text-main:     #2a1800;
  --text-dim:      rgba(42,24,0,0.60);
  --text-mute:     rgba(42,24,0,0.35);
  --border:        rgba(140,100,40,0.30);
  --border-hover:  rgba(140,100,40,0.60);
  --accent:        #8b5e0a;
  --accent-light:  #b8820e;
  --accent-glow:   rgba(139,94,10,0.20);
  --shadow-color:  rgba(100,60,0,0.25);
  --modal-bg:      #f4ecda;
  --modal-sticky:  #f4ecda;
  --info-bg:       rgba(235,225,200,0.95);
  --body-grid:     rgba(140,100,40,0.05);
  --board-bg:      radial-gradient(ellipse at 30% 20%,#c8904a,#a06830 40%,#7a4c18 70%,#5a3408);
  --board-border:  #4a2c0a;
  --board-outline: rgba(80,50,10,0.6);
  --scroll-thumb:  rgba(139,94,10,0.30);
  --ach-bg:        linear-gradient(135deg,rgba(235,220,190,0.9),rgba(225,210,175,0.95));
  --ach-bg-unlock: linear-gradient(135deg,rgba(240,228,200,0.95),rgba(230,218,185,0.98));
  --win-bg:        linear-gradient(160deg,#f4ecda,#e8dcc0);
  --rank-card-bg:  rgba(180,150,90,0.15);
  --special-rule-bg: rgba(139,94,10,0.07);
}

/* ä¸»é¡Œä¸‰ï¼šé’èŠ±ç“·è—ï¼ˆè—ç™½ç“·å™¨ï¼‰ */
[data-theme="blue"] {
  --btn-accent-end: #1a3a6a;
  --bg-base:       #0c1628;
  --bg-mid:        #132040;
  --bg-panel:      rgba(15,25,55,0.95);
  --bg-card:       rgba(18,30,65,0.92);
  --bg-card-hover: rgba(25,40,80,0.97);
  --bg-input:      rgba(12,20,50,0.88);
  --bg-inset:      rgba(0,20,60,0.25);
  --text-main:     #dce8f8;
  --text-dim:      rgba(220,232,248,0.55);
  --text-mute:     rgba(220,232,248,0.30);
  --border:        rgba(100,160,240,0.28);
  --border-hover:  rgba(100,160,240,0.55);
  --accent:        #5b9bd5;
  --accent-light:  #90c4f0;
  --accent-glow:   rgba(91,155,213,0.35);
  --shadow-color:  rgba(0,10,40,0.75);
  --modal-bg:      #0e1e45;
  --modal-sticky:  #0e1e45;
  --info-bg:       rgba(15,25,55,0.95);
  --body-grid:     rgba(100,160,240,0.03);
  --board-bg:      radial-gradient(ellipse at 30% 20%,#2a5090,#1a3870 40%,#0e2258 70%,#081540);
  --board-border:  #081540;
  --board-outline: rgba(5,10,30,0.9);
  --scroll-thumb:  rgba(91,155,213,0.30);
  --ach-bg:        linear-gradient(135deg,rgba(15,25,60,0.92),rgba(10,18,50,0.96));
  --ach-bg-unlock: linear-gradient(135deg,rgba(20,35,80,0.95),rgba(15,28,70,0.98));
  --win-bg:        linear-gradient(160deg,#0e1e45,#081530);
  --rank-card-bg:  rgba(30,60,120,0.25);
  --special-rule-bg: rgba(91,155,213,0.07);
}

/* ä¸»é¡Œå››ï¼šç¿¡ç¿ æ˜¥æ„ï¼ˆæ¸…çˆ½ç¶ è‰²ï¼‰ */
[data-theme="jade"] {
  --btn-accent-end: #1b4a1c;
  --bg-base:       #f2f8f2;
  --bg-mid:        #e4f0e4;
  --bg-panel:      rgba(242,248,242,0.97);
  --bg-card:       rgba(235,245,235,0.93);
  --bg-card-hover: rgba(225,240,225,0.97);
  --bg-input:      rgba(220,238,220,0.90);
  --bg-inset:      rgba(80,160,80,0.08);
  --text-main:     #1a2e1a;
  --text-dim:      rgba(26,46,26,0.58);
  --text-mute:     rgba(26,46,26,0.32);
  --border:        rgba(60,140,60,0.28);
  --border-hover:  rgba(60,140,60,0.58);
  --accent:        #2e7d32;
  --accent-light:  #4caf50;
  --accent-glow:   rgba(46,125,50,0.22);
  --shadow-color:  rgba(20,60,20,0.22);
  --modal-bg:      #f5faf5;
  --modal-sticky:  #f5faf5;
  --info-bg:       rgba(235,248,235,0.96);
  --body-grid:     rgba(60,140,60,0.05);
  --board-bg:      radial-gradient(ellipse at 30% 20%,#5a9a50,#3d7035 40%,#2a5025 70%,#1a3818);
  --board-border:  #1a3818;
  --board-outline: rgba(15,40,15,0.7);
  --scroll-thumb:  rgba(46,125,50,0.30);
  --ach-bg:        linear-gradient(135deg,rgba(230,248,230,0.92),rgba(220,242,220,0.96));
  --ach-bg-unlock: linear-gradient(135deg,rgba(238,252,238,0.96),rgba(228,248,228,0.98));
  --win-bg:        linear-gradient(160deg,#f5faf5,#e4f0e4);
  --rank-card-bg:  rgba(80,180,80,0.12);
  --special-rule-bg: rgba(46,125,50,0.07);
}

/* ================================================
   é‡ç½® & åŸºç¤
   ================================================ */
*, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
html { scroll-behavior:smooth; }

body {
  min-height:100vh;
  background:
    radial-gradient(ellipse 80% 60% at 20% 10%, var(--accent-glow) 0%, transparent 60%),
    radial-gradient(ellipse 60% 80% at 85% 90%, var(--accent-glow) 0%, transparent 60%),
    linear-gradient(160deg, var(--bg-base) 0%, var(--bg-mid) 50%, var(--bg-base) 100%);
  font-family:'Noto Serif TC',serif;
  color:var(--text-main);
  overflow-x:hidden;
  transition:background 0.5s ease, color 0.3s ease;
}
/* æ‰€æœ‰ä¸»è¦å€å¡Šè·Ÿéš¨ä¸»é¡Œéæ¸¡ */
.top-nav, .stats-bar .stat-card, .control-panel, #side-panel,
.modal-box, .ach-card, .win-box, #info-box, select, .nav-btn, .theme-picker {
  transition:background 0.4s ease, border-color 0.4s ease, color 0.3s ease, box-shadow 0.4s ease;
}
body::before {
  content:'';
  position:fixed; inset:0;
  background-image:
    repeating-linear-gradient(0deg,transparent,transparent 39px,var(--body-grid) 40px),
    repeating-linear-gradient(90deg,transparent,transparent 39px,var(--body-grid) 40px);
  pointer-events:none; z-index:0;
}

/* ================================================
   é é¢çµæ§‹
   ================================================ */
#app {
  position:relative; z-index:1;
  max-width:1200px; margin:0 auto;
  padding:12px 16px 48px;
  display:flex; flex-direction:column; align-items:center; gap:14px;
}

/* ================================================
   é ‚éƒ¨å°èˆªæ¬„
   ================================================ */
.top-nav {
  width:100%; display:flex; align-items:center; justify-content:space-between;
  padding:10px 16px;
  background:var(--bg-panel);
  border:1px solid var(--border); border-radius:14px;
  box-shadow:0 4px 20px var(--shadow-color), inset 0 1px 0 var(--accent-glow);
  backdrop-filter:blur(12px);
}
.nav-brand { display:flex; align-items:center; gap:10px; }
.nav-brand h1 {
  font-family:'Ma Shan Zheng',serif;
  font-size:clamp(20px,4vw,30px);
  color:var(--accent);
  text-shadow:0 0 18px var(--accent-glow), 1px 1px 0 var(--shadow-color);
  letter-spacing:4px; line-height:1;
}
.nav-brand .subtitle {
  font-size:10px; letter-spacing:4px;
  color:var(--text-mute);
  display:none;
}
@media(min-width:600px){ .nav-brand .subtitle { display:block; } }
.nav-actions { display:flex; gap:6px; align-items:center; }

/* ================================================
   ä¸»é¡Œåˆ‡æ›å™¨
   ================================================ */
.theme-picker {
  display:flex; gap:5px; align-items:center;
  padding:4px 8px;
  background:var(--bg-inset);
  border-radius:20px;
  border:1px solid var(--border);
}
.theme-dot {
  width:18px; height:18px; border-radius:50%;
  cursor:pointer; border:2px solid transparent;
  transition:all 0.2s; flex-shrink:0;
}
.theme-dot:hover { transform:scale(1.2); }
.theme-dot.active { border-color:var(--accent); transform:scale(1.15); box-shadow:0 0 6px var(--accent-glow); }
.theme-dot[data-t="dark"]  { background:linear-gradient(135deg,#2a1008,#c9a84c); }
.theme-dot[data-t="paper"] { background:linear-gradient(135deg,#e8dcc0,#8b5e0a); }
.theme-dot[data-t="blue"]  { background:linear-gradient(135deg,#0c1628,#5b9bd5); }
.theme-dot[data-t="jade"]  { background:linear-gradient(135deg,#1a3818,#4caf50); }

.nav-btn {
  display:flex; align-items:center; gap:5px;
  padding:7px 13px; border-radius:8px;
  font-family:'Noto Serif TC',serif; font-size:13px; font-weight:600;
  cursor:pointer; letter-spacing:1px; transition:all 0.2s;
  background:var(--accent-glow); color:var(--accent);
  border:1px solid var(--border);
}
.nav-btn:hover { background:var(--accent-glow); filter:brightness(1.4); border-color:var(--border-hover); }
.nav-btn.danger { color:#e57373; border-color:rgba(229,115,115,0.25); background:rgba(229,115,115,0.08); }
.nav-btn.danger:hover { background:rgba(229,115,115,0.18); }

/* ================================================
   çµ±è¨ˆæ¬„
   ================================================ */
.stats-bar {
  width:100%; display:grid;
  grid-template-columns:repeat(6,1fr); gap:8px;
}
@media(max-width:600px){ .stats-bar { grid-template-columns:repeat(3,1fr); } }
@media(max-width:360px){ .stats-bar { grid-template-columns:repeat(2,1fr); } }

.stat-card {
  background:var(--bg-card);
  border:1px solid var(--border); border-radius:10px;
  padding:10px 8px; text-align:center;
  box-shadow:0 4px 12px var(--shadow-color);
  transition:all 0.2s;
}
.stat-card:hover { border-color:var(--border-hover); transform:translateY(-1px); }
.stat-num {
  font-family:'Ma Shan Zheng',serif;
  font-size:clamp(18px,4vw,28px); font-weight:900; line-height:1;
}
.stat-num.win   { color:#4caf50; }
.stat-num.lose  { color:#ef5350; }
.stat-num.draw  { color:var(--text-dim); }
.stat-num.total { color:var(--accent); }
.stat-num.ach   { color:#ba68c8; }
.stat-label { font-size:10px; letter-spacing:2px; color:var(--text-mute); margin-top:4px; }

/* ================================================
   æ§åˆ¶é¢æ¿
   ================================================ */
.control-panel {
  width:100%;
  background:var(--bg-panel);
  border:1px solid var(--border); border-radius:14px;
  padding:14px 18px;
  box-shadow:0 6px 24px var(--shadow-color);
  display:flex; flex-direction:column; align-items:center; gap:10px;
}
.controls { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center; }

select {
  padding:8px 32px 8px 12px; border-radius:8px;
  border:1px solid var(--border);
  background:var(--bg-input);
  color:var(--text-main);
  font-family:'Noto Serif TC',serif; font-size:13px;
  cursor:pointer; appearance:none; -webkit-appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23888' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");
  background-repeat:no-repeat; background-position:right 10px center;
  transition:all 0.2s;
}
select:focus { outline:none; border-color:var(--accent); }
select option { background:var(--bg-input); color:var(--text-main); }

#difficulty-container { transition:opacity 0.3s; }

.game-btn {
  padding:8px 16px; border-radius:8px;
  font-family:'Noto Serif TC',serif; font-weight:700; font-size:13px;
  cursor:pointer; transition:all 0.2s; letter-spacing:1px;
}
#restart-btn {
  background:linear-gradient(135deg,#2e7d32,#1b5e20); color:#c8e6c9;
  border:1px solid #4caf50; box-shadow:0 2px 8px rgba(76,175,80,0.25);
}
#restart-btn:hover { transform:translateY(-1px); box-shadow:0 4px 16px rgba(76,175,80,0.40); }
#undo-btn {
  background:linear-gradient(135deg,#e65100,#bf360c); color:#ffe0b2;
  border:1px solid #ff6d00; box-shadow:0 2px 8px rgba(230,81,0,0.20);
}
#undo-btn:hover:not(:disabled) { transform:translateY(-1px); box-shadow:0 4px 16px rgba(230,81,0,0.35); }
#undo-btn:disabled { background:var(--bg-inset); color:var(--text-mute); cursor:not-allowed; border-color:transparent; box-shadow:none; transform:none; }
.game-btn:active:not(:disabled) { transform:translateY(2px)!important; }

#info-box {
  font-size:clamp(14px,3vw,17px); font-weight:700;
  padding:9px 28px; border-radius:30px; letter-spacing:2px;
  background:var(--info-bg);
  border:1px solid var(--border);
  transition:color 0.3s, border-color 0.3s, background 0.4s;
  text-shadow:0 0 10px currentColor;
}

/* ================================================
   éŠæˆ²ä¸»å¸ƒå±€
   ================================================ */
#game-layout {
  display:flex; flex-direction:row; gap:16px;
  width:100%; align-items:flex-start; justify-content:center;
}
@media(max-width:950px){ #game-layout { flex-direction:column; align-items:center; } }

/* ================================================
   æ£‹ç›¤
   ================================================ */
.board-wrap { flex-shrink:0; display:flex; flex-direction:column; align-items:center; gap:6px; }
.board-label { font-size:11px; letter-spacing:4px; color:var(--text-mute); text-align:center; }

#board {
  width:min(580px,96vw);
  display:grid; grid-template-columns:repeat(8,1fr); gap:5px;
  padding:13px; border-radius:14px;
  background:var(--board-bg);
  border:3px solid var(--board-border);
  outline:7px solid var(--board-outline); outline-offset:3px;
  box-shadow:
    0 0 0 1px var(--accent-glow),
    0 15px 50px var(--shadow-color),
    inset 0 0 40px rgba(0,0,0,0.3),
    inset 0 2px 0 rgba(255,255,255,0.1);
  position:relative;
}
#board::before {
  content:''; position:absolute; inset:13px; border-radius:4px;
  background:
    repeating-linear-gradient(90deg,transparent,transparent calc(12.5% - 0.5px),rgba(0,0,0,0.1) calc(12.5% - 0.5px),rgba(0,0,0,0.1) 12.5%),
    repeating-linear-gradient(0deg,transparent,transparent calc(25% - 0.5px),rgba(0,0,0,0.1) calc(25% - 0.5px),rgba(0,0,0,0.1) 25%);
  pointer-events:none; z-index:0;
}

/* ================================================
   æ£‹å­
   ================================================ */
.cell {
  width:100%; aspect-ratio:1/1; cursor:pointer; border-radius:50%;
  display:flex; justify-content:center; align-items:center;
  font-size:clamp(15px,4.2vw,30px);
  font-family:'Ma Shan Zheng','Noto Serif TC',serif; font-weight:900;
  position:relative; z-index:1;
  transition:transform 0.12s ease, box-shadow 0.12s ease;
  background:radial-gradient(circle at 33% 25%,#f2deb0,#caa568 45%,#9a7038);
  box-shadow:0 5px 0 #6b4a18, 0 7px 14px rgba(0,0,0,0.55),
             inset 0 1px 3px rgba(255,245,200,0.5), inset 0 -1px 2px rgba(0,0,0,0.2);
  border:1px solid rgba(190,150,70,0.3);
  user-select:none;
}
.cell:hover:not(.empty) {
  transform:translateY(-3px);
  box-shadow:0 8px 0 #6b4a18, 0 12px 20px rgba(0,0,0,0.7),
             inset 0 1px 3px rgba(255,245,200,0.5);
}
.cell:active:not(.empty) {
  transform:translateY(4px)!important;
  box-shadow:0 1px 0 #6b4a18, 0 2px 6px rgba(0,0,0,0.5)!important;
}

.hidden {
  background:radial-gradient(circle at 38% 28%,#5c3520,#2e1308);
  box-shadow:0 5px 0 #1e0900, 0 7px 14px rgba(0,0,0,0.7),
             inset 0 1px 2px rgba(200,120,40,0.08);
  border-color:rgba(100,50,15,0.4);
}
.hidden::after { content:"ï¼Ÿ"; color:rgba(201,168,76,0.15); font-size:80%; }
.hidden:hover {
  background:radial-gradient(circle at 38% 28%,#6e4030,#3a1a10);
  transform:translateY(-3px);
}

.red-p  { color:#cc2200; text-shadow:0 0 10px rgba(200,40,0,0.5), 1px 1px 0 rgba(255,180,150,0.2); }
.black-p{ color:#1a1a2e; text-shadow:0 0 6px rgba(20,20,50,0.3),  1px 1px 0 rgba(200,200,220,0.15); }

.selected {
  transform:translateY(-7px)!important;
  background:radial-gradient(circle at 33% 25%,#fff8d0,#e8c858 45%,#b89030)!important;
  box-shadow:0 13px 0 #b09020, 0 18px 35px rgba(201,168,76,0.50),
             inset 0 1px 3px rgba(255,255,200,0.6)!important;
  border:2px solid #c9a84c!important;
}

.empty {
  background:var(--bg-inset);
  box-shadow:inset 0 2px 8px rgba(0,0,0,0.30);
  border:1px solid rgba(0,0,0,0.08);
  border-radius:8px; cursor:default;
}
.empty:hover, .empty:active { transform:none!important; box-shadow:inset 0 2px 8px rgba(0,0,0,0.30)!important; }

.valid-move::before {
  content:''; position:absolute; width:34%; height:34%; border-radius:50%;
  background:radial-gradient(circle,rgba(80,220,80,0.95),rgba(40,160,40,0.7));
  box-shadow:0 0 14px rgba(80,220,80,0.85);
  animation:dot-pulse 1.1s ease-in-out infinite;
}
.valid-capture {
  box-shadow:0 5px 0 #8b1a1a, 0 7px 14px rgba(0,0,0,0.6),
             0 0 0 3px rgba(200,40,0,0.8),
             inset 0 1px 3px rgba(255,200,180,0.3)!important;
}
.valid-capture::after {
  content:''; position:absolute; inset:-4px; border:2px solid #ff4444;
  border-radius:50%; animation:capture-ring 0.85s ease-in-out infinite;
}
.last-moved {
  box-shadow:0 5px 0 #6b4a18, 0 7px 14px rgba(0,0,0,0.55),
             0 0 0 2px rgba(80,160,255,0.55),
             inset 0 1px 3px rgba(200,220,255,0.3)!important;
}

@keyframes dot-pulse { 0%,100%{opacity:.55;transform:scale(.88);}  50%{opacity:1;transform:scale(1.12);} }
@keyframes capture-ring {
  0%,100%{opacity:.45;transform:scale(1);}
  50%{opacity:1;transform:scale(1.08);box-shadow:0 0 10px rgba(255,68,68,0.4);}
}
@keyframes piece-flip {
  0%  { transform:scaleY(1);       filter:brightness(1); }
  30% { transform:scaleY(0) scaleX(0.7); filter:brightness(0.3); }
  65% { transform:scaleY(1.08) scaleX(1.04); filter:brightness(1.35); }
  100%{ transform:scaleY(1) scaleX(1); filter:brightness(1); }
}
.flipping { animation:piece-flip 0.36s cubic-bezier(.4,0,.2,1); }

.coord-row {
  display:flex; justify-content:space-around;
  width:min(580px,96vw); padding:0 13px;
}
.coord-row span { width:calc(100%/8); text-align:center; font-size:9px; color:var(--text-mute); }

/* ================================================
   å´é‚Šæ¬„
   ================================================ */
#side-panel {
  background:var(--bg-panel); border:1px solid var(--border);
  border-radius:14px; padding:16px;
  width:100%; max-width:260px;
  box-shadow:0 6px 24px var(--shadow-color);
  display:flex; flex-direction:column; gap:14px; flex-shrink:0;
}
@media(max-width:950px){ #side-panel { max-width:min(580px,96vw); } }

.panel-section { display:flex; flex-direction:column; gap:6px; }
.section-title {
  font-size:10px; letter-spacing:3px; font-weight:600;
  padding-bottom:6px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:6px;
  color:var(--text-dim);
}
.section-title.red-t  { color:#ef9a9a; }
.section-title.blk-t  { color:#90a4ae; }
.section-title.log-t  { color:#81d4fa; }
.section-title.rule-t { color:var(--accent); opacity:0.8; }

.captured-container {
  display:flex; flex-wrap:wrap; gap:4px;
  background:var(--bg-inset); padding:7px; border-radius:8px; min-height:40px;
  border:1px solid var(--border);
}
.captured-piece {
  width:27px; height:27px; border-radius:50%;
  display:flex; justify-content:center; align-items:center;
  font-size:12px; font-family:'Ma Shan Zheng',serif;
  background:radial-gradient(circle at 33% 28%,#f0dab0,#c8a068 45%,#9a7030);
  box-shadow:0 2px 4px rgba(0,0,0,0.4), 0 3px 0 #6b4a18;
  border:1px solid rgba(190,150,70,0.3);
}
.captured-piece.cp-red { color:#b71c1c; }
.captured-piece.cp-blk { color:#1a1a2e; }

#history-list {
  list-style:none; max-height:180px; overflow-y:auto;
  font-size:11px; color:var(--text-dim);
  scrollbar-width:thin; scrollbar-color:var(--scroll-thumb) transparent;
}
#history-list li {
  padding:5px 6px; border-bottom:1px solid var(--border);
  border-radius:3px; transition:background 0.1s;
}
#history-list li:hover { background:var(--bg-inset); }
#history-list li:last-child { color:var(--accent-light); font-weight:bold; }

.rank-table { width:100%; }
.rank-row {
  display:flex; align-items:center; gap:5px;
  font-size:11px; color:var(--text-dim);
  padding:3px 0; border-bottom:1px solid var(--border);
}
.rank-pieces { color:var(--accent-light); font-family:'Ma Shan Zheng',serif; letter-spacing:1px; min-width:80px; }
.rank-desc { font-size:10px; color:var(--text-mute); }

/* ================================================
   æ’’èŠ±
   ================================================ */
#confetti-canvas { position:fixed; inset:0; width:100vw; height:100vh; pointer-events:none; z-index:9999; }

/* ================================================
   æˆå°±é€šçŸ¥
   ================================================ */
#ach-toast {
  position:fixed; bottom:28px; right:20px;
  display:flex; flex-direction:column; gap:10px;
  z-index:10000; pointer-events:none;
}
.ach-toast-item {
  display:flex; align-items:center; gap:12px;
  background:var(--bg-panel);
  border:1px solid var(--accent); border-radius:12px;
  padding:12px 16px; min-width:260px; max-width:320px;
  box-shadow:0 8px 32px var(--shadow-color), 0 0 18px var(--accent-glow);
  animation:toast-in 0.4s cubic-bezier(.34,1.56,.64,1) forwards;
}
.ach-toast-item.out { animation:toast-out 0.3s ease-in forwards; }
.ach-toast-icon { font-size:28px; flex-shrink:0; }
.ach-toast-text { flex:1; }
.ach-toast-label { font-size:10px; letter-spacing:2px; color:var(--accent); margin-bottom:3px; }
.ach-toast-name  { font-size:14px; font-weight:700; color:var(--text-main); }
.ach-toast-desc  { font-size:11px; color:var(--text-dim); margin-top:2px; }
@keyframes toast-in  { from{opacity:0;transform:translateX(calc(100% + 40px));}  to{opacity:1;transform:translateX(0);} }
@keyframes toast-out { from{opacity:1;transform:translateX(0);} to{opacity:0;transform:translateX(calc(100% + 40px));} }

/* ================================================
   æ¨¡æ…‹æ¡†
   ================================================ */
.modal-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.7);
  display:flex; align-items:center; justify-content:center;
  z-index:5000; opacity:0; pointer-events:none; transition:opacity 0.3s;
  padding:16px;
}
.modal-overlay.show { opacity:1; pointer-events:auto; }
.modal-box {
  background:var(--modal-bg);
  border:1px solid var(--border); border-radius:18px;
  width:100%; max-width:740px; max-height:90vh; overflow-y:auto;
  box-shadow:0 30px 80px var(--shadow-color), 0 0 50px var(--accent-glow);
  transform:scale(0.92) translateY(20px); transition:transform 0.3s;
  scrollbar-width:thin; scrollbar-color:var(--scroll-thumb) transparent;
}
.modal-overlay.show .modal-box { transform:scale(1) translateY(0); }
.modal-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:20px 24px 14px;
  border-bottom:1px solid var(--border);
  position:sticky; top:0; background:var(--modal-sticky); z-index:1;
}
.modal-header h2 {
  font-family:'Ma Shan Zheng',serif; font-size:24px;
  color:var(--accent); letter-spacing:4px;
}
.modal-close {
  background:none; border:1px solid var(--border);
  color:var(--text-dim); font-size:18px; cursor:pointer;
  width:34px; height:34px; border-radius:50%; transition:all 0.2s;
  display:flex; align-items:center; justify-content:center;
}
.modal-close:hover { background:var(--accent-glow); color:var(--accent); border-color:var(--accent); }
.modal-body { padding:20px 24px 28px; }

/* è¦å‰‡æ¨¡æ…‹æ¡† */
.rule-section { margin-bottom:24px; }
.rule-section h3 {
  font-family:'Ma Shan Zheng',serif; font-size:18px;
  color:var(--accent-light); letter-spacing:3px; margin-bottom:10px;
  padding-bottom:6px; border-bottom:1px solid var(--border);
}
.rule-section p { font-size:13px; line-height:1.9; color:var(--text-dim); margin-bottom:8px; }
.rule-section p strong { color:var(--accent-light); }

.rank-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(130px,1fr)); gap:8px; margin-top:10px; }
.rank-card {
  background:var(--rank-card-bg); border:1px solid var(--border);
  border-radius:8px; padding:10px; text-align:center;
}
.rank-card .piece-name { font-family:'Ma Shan Zheng',serif; font-size:22px; display:flex; gap:6px; justify-content:center; margin-bottom:5px; }
.rn-r { color:#cc2200; }
.rn-b { color:#3a5080; }
.rank-card .piece-info { font-size:11px; color:var(--text-dim); line-height:1.6; }
.rank-card .rank-badge {
  display:inline-block; font-size:10px; letter-spacing:1px;
  background:var(--accent-glow); color:var(--accent);
  padding:2px 8px; border-radius:4px; margin-bottom:4px;
}
.special-rule {
  background:var(--special-rule-bg); border:1px solid var(--border);
  border-radius:8px; padding:12px; margin-bottom:8px;
}
.special-rule .sr-title { font-size:13px; font-weight:700; color:var(--accent-light); margin-bottom:4px; }
.special-rule .sr-desc  { font-size:12px; color:var(--text-dim); line-height:1.7; }

/* æˆå°±æ¨¡æ…‹æ¡† */
.ach-tabs { display:flex; gap:6px; margin-bottom:16px; flex-wrap:wrap; }
.ach-tab {
  padding:7px 16px; border-radius:8px; border:1px solid var(--border);
  background:transparent; color:var(--text-dim); font-size:12px; font-weight:600;
  cursor:pointer; transition:all 0.2s; letter-spacing:1px;
  font-family:'Noto Serif TC',serif;
}
.ach-tab.active, .ach-tab:hover {
  background:var(--accent-glow); color:var(--accent); border-color:var(--border-hover);
}
.ach-progress-bar {
  width:100%; height:6px; background:var(--bg-inset); border-radius:3px; margin-bottom:16px; overflow:hidden;
}
.ach-progress-fill {
  height:100%; border-radius:3px;
  background:linear-gradient(90deg,var(--accent),var(--accent-light));
  transition:width 0.6s ease;
}
.ach-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:10px; }
.ach-card {
  background:var(--ach-bg); border:1px solid var(--border); border-radius:10px;
  padding:14px; display:flex; flex-direction:column; gap:8px;
  transition:all 0.2s; position:relative; overflow:hidden;
}
.ach-card:hover { transform:translateY(-2px); border-color:var(--border-hover); }
.ach-card.unlocked { border-color:var(--border-hover); background:var(--ach-bg-unlock); }
.ach-card.unlocked::before {
  content:''; position:absolute; inset:0;
  background:linear-gradient(135deg,var(--accent-glow),transparent);
  pointer-events:none;
}
.ach-card.secret:not(.unlocked) { border-style:dashed; border-color:var(--border); }
.ach-icon      { font-size:30px; line-height:1; }
.ach-name      { font-size:13px; font-weight:700; color:var(--text-main); }
.ach-card:not(.unlocked) .ach-name { color:var(--text-mute); }
.ach-desc      { font-size:11px; color:var(--text-dim); line-height:1.6; }
.ach-card.unlocked .ach-desc { color:var(--text-dim); }
.ach-unlock-date { font-size:10px; color:var(--accent); letter-spacing:1px; margin-top:auto; }
.ach-lock-icon { position:absolute; top:10px; right:10px; font-size:14px; color:var(--text-mute); }
.ach-card.unlocked .ach-lock-icon { display:none; }
.ach-rarity { font-size:9px; letter-spacing:2px; padding:2px 7px; border-radius:4px; display:inline-block; width:fit-content; }
.rarity-common    { background:rgba(100,180,100,0.15); color:#80c880; }
.rarity-rare      { background:rgba(100,150,220,0.15); color:#80a8e0; }
.rarity-epic      { background:rgba(180,100,220,0.15); color:#c090d8; }
.rarity-legendary { background:rgba(220,160,40,0.15);  color:#c9a84c; }
.ach-shimmer {
  position:absolute; inset:0;
  background:linear-gradient(105deg,transparent 40%,var(--accent-glow) 50%,transparent 60%);
  animation:shimmer 3s infinite; pointer-events:none;
}
@keyframes shimmer { 0%{transform:translateX(-100%);} 100%{transform:translateX(200%);} }

/* ================================================
   å‹åˆ©è¦†è“‹
   ================================================ */
#win-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.65);
  display:flex; align-items:center; justify-content:center;
  z-index:4000; opacity:0; pointer-events:none; transition:opacity 0.5s;
}
#win-overlay.show { opacity:1; pointer-events:auto; }
.win-box {
  background:var(--win-bg);
  border:2px solid var(--accent); border-radius:20px;
  padding:32px 44px; text-align:center;
  box-shadow:0 0 50px var(--accent-glow), 0 30px 80px var(--shadow-color);
  transform:scale(0.85); transition:transform 0.4s cubic-bezier(.34,1.56,.64,1);
  max-width:480px; width:calc(100% - 32px);
}
#win-overlay.show .win-box { transform:scale(1); }
.win-icon  { font-size:52px; line-height:1; margin-bottom:12px; }
.win-title {
  font-family:'Ma Shan Zheng',serif; font-size:34px;
  color:var(--accent); letter-spacing:6px; margin-bottom:8px;
  text-shadow:0 0 20px var(--accent-glow);
}
.win-sub   { font-size:13px; color:var(--text-dim); letter-spacing:2px; margin-bottom:16px; }
.win-stats {
  display:flex; gap:14px; justify-content:center; flex-wrap:wrap;
  margin-bottom:22px; padding:12px 14px;
  background:var(--bg-inset); border-radius:10px;
  border:1px solid var(--border);
}
.win-stat-item { text-align:center; }
.win-stat-val  { font-family:'Ma Shan Zheng',serif; font-size:22px; color:var(--accent-light); line-height:1; }
.win-stat-lbl  { font-size:10px; letter-spacing:1px; color:var(--text-mute); margin-top:3px; }
.win-actions   { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
.win-btn {
  padding:11px 28px; border-radius:10px; border:none;
  font-family:'Noto Serif TC',serif; font-size:14px; font-weight:700;
  cursor:pointer; letter-spacing:2px; transition:all 0.2s;
  background:linear-gradient(135deg,var(--accent),var(--btn-accent-end));
  color:var(--bg-base);
  box-shadow:0 4px 18px var(--accent-glow);
}
.win-btn:hover { transform:translateY(-2px); box-shadow:0 6px 26px var(--accent-glow); filter:brightness(1.1); }
.win-btn.secondary {
  background:var(--accent-glow); color:var(--accent);
  border:1px solid var(--border);
  box-shadow:none;
}
.win-btn.secondary:hover { filter:brightness(1.3); }
</style>
</head>
<body>
<canvas id="confetti-canvas"></canvas>
<div id="ach-toast"></div>

<!-- è¦å‰‡æ¨¡æ…‹æ¡† -->
<div class="modal-overlay" id="rules-modal">
  <div class="modal-box">
    <div class="modal-header">
      <h2>æš—æ£‹è¦å‰‡</h2>
      <button class="modal-close" onclick="closeModal('rules-modal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="rule-section">
        <h3>éŠæˆ²æ¦‚è¿°</h3>
        <p>æš—æ£‹ä½¿ç”¨ <strong>4è¡ŒÃ—8åˆ—</strong> å…± <strong>32æ ¼</strong> çš„æ£‹ç›¤ï¼Œæ‰€æœ‰ 32 é¡†æ£‹å­æ­£é¢æœä¸‹éš¨æ©Ÿæ’åˆ—ã€‚ç©å®¶è¼ªæµç¿»æ£‹ã€ç§»å‹•æˆ–åƒå­ï¼Œæ¶ˆæ»…å°æ–¹æ‰€æœ‰æ£‹å­è€…ç²å‹ã€‚</p>
      </div>
      <div class="rule-section">
        <h3>æ±ºå®šé™£ç‡Ÿ</h3>
        <p><strong>ç¬¬ä¸€å€‹ç¿»é–‹æ£‹å­çš„é¡è‰²å³ç‚ºç¿»æ£‹è€…çš„é™£ç‡Ÿã€‚</strong>é¦–ç¿»å¾Œï¼Œç¿»æ£‹è€…ç¹¼çºŒèµ°æ£‹ï¼ˆé¦–ç¿»ç®—è¡Œå‹•ï¼‰ï¼Œå°æ–¹æ¥è‘—è¼ªåˆ°ã€‚</p>
      </div>
      <div class="rule-section">
        <h3>æ£‹å­éšç´šèˆ‡åƒå­è¦å‰‡</h3>
        <p>ä¸€èˆ¬æ£‹å­åªèƒ½èµ°ä¸€æ ¼ï¼ˆä¸Šä¸‹å·¦å³ï¼‰ï¼Œä¸”åªèƒ½åƒæ‰éšç´šç›¸åŒæˆ–æ›´ä½çš„å°æ–¹æ£‹å­ï¼š</p>
        <div class="rank-grid">
          <div class="rank-card"><div class="piece-name"><span class="rn-r">å¸¥</span><span class="rn-b">å°‡</span></div><div class="rank-badge">éšç´š 7ãƒ»æœ€é«˜</div><div class="piece-info">æœ€å¼·ï¼Œå¯åƒé™¤å…µ/å’å¤–æ‰€æœ‰æ£‹å­</div></div>
          <div class="rank-card"><div class="piece-name"><span class="rn-r">ä»•</span><span class="rn-b">å£«</span></div><div class="rank-badge">éšç´š 6</div><div class="piece-info">å¯åƒè±¡/ç›¸åŠä»¥ä¸‹</div></div>
          <div class="rank-card"><div class="piece-name"><span class="rn-r">ç›¸</span><span class="rn-b">è±¡</span></div><div class="rank-badge">éšç´š 5</div><div class="piece-info">å¯åƒè»Š/ä¿¥åŠä»¥ä¸‹</div></div>
          <div class="rank-card"><div class="piece-name"><span class="rn-r">ä¿¥</span><span class="rn-b">è»Š</span></div><div class="rank-badge">éšç´š 4</div><div class="piece-info">å¯åƒé¦¬/å‚ŒåŠä»¥ä¸‹</div></div>
          <div class="rank-card"><div class="piece-name"><span class="rn-r">å‚Œ</span><span class="rn-b">é¦¬</span></div><div class="rank-badge">éšç´š 3</div><div class="piece-info">å¯åƒç‚®/åŒ…åŠä»¥ä¸‹</div></div>
          <div class="rank-card"><div class="piece-name"><span class="rn-r">ç‚®</span><span class="rn-b">åŒ…</span></div><div class="rank-badge">éšç´š 2ãƒ»ç‰¹æ®Š</div><div class="piece-info">ç§»å‹•ï¼šç›´ç·šä¸è¶Šå­<br>åƒå­ï¼šå¿…é ˆéš”ä¸€ç ²å°</div></div>
          <div class="rank-card"><div class="piece-name"><span class="rn-r">å…µ</span><span class="rn-b">å’</span></div><div class="rank-badge">éšç´š 1ãƒ»ååˆ¶</div><div class="piece-info">æœ€å¼±ï¼Œä½†å¯åƒå¸¥/å°‡</div></div>
        </div>
      </div>
      <div class="rule-section">
        <h3>ç‰¹æ®Šè¦å‰‡</h3>
        <div class="special-rule">
          <div class="sr-title">ğŸ¯ ç‚®ï¼ˆåŒ…ï¼‰çš„ç§»å‹•èˆ‡åƒå­</div>
          <div class="sr-desc">ç‚®æ²¿<strong>ç›´ç·š</strong>ç§»å‹•åˆ°ç©ºæ ¼ï¼ˆä¸­é–“ä¸èƒ½æœ‰ä»»ä½•æ£‹å­ï¼‰ã€‚åƒå­æ™‚ï¼Œç‚®èˆ‡ç›®æ¨™ä¹‹é–“å¿…é ˆ<strong>æ°å¥½éš”ä¸€é¡†æ£‹å­</strong>ï¼ˆç ²å°ï¼‰ï¼Œæ‰å¯åƒæ‰ç›®æ¨™ï¼ˆä¸å—éšç´šé™åˆ¶ï¼‰ã€‚</div>
        </div>
        <div class="special-rule">
          <div class="sr-title">âš¡ å…µ/å’ vs å¸¥/å°‡</div>
          <div class="sr-desc">å…µï¼ˆå’ï¼‰å¯åƒå¸¥ï¼ˆå°‡ï¼‰ï¼›å¸¥ï¼ˆå°‡ï¼‰ç„¡æ³•åƒå…µï¼ˆå’ï¼‰ã€‚</div>
        </div>
        <div class="special-rule">
          <div class="sr-title">ğŸƒ ç¿»é–‹æš—æ£‹</div>
          <div class="sr-desc">ç¿»æ£‹è¦–ç‚ºä¸€æ¬¡è¡Œå‹•ï¼Œç¿»é–‹å¾Œè¼ªåˆ°å°æ–¹ã€‚</div>
        </div>
        <div class="special-rule">
          <div class="sr-title">ğŸ† å‹åˆ©æ¢ä»¶</div>
          <div class="sr-desc">æ¶ˆæ»…å°æ–¹<strong>æ‰€æœ‰æ£‹å­</strong>ï¼ˆå«æœªç¿»ï¼‰å³ç²å‹ï¼›è‹¥ä¸€æ–¹ç„¡æ£‹å¯èµ°ï¼Œå‰‡è©²æ–¹èªè² ã€‚</div>
        </div>
      </div>
      <div class="rule-section">
        <h3>æ“ä½œèªªæ˜</h3>
        <p>â€¢ <strong>ç¿»ç‰Œ</strong>ï¼šé»æ“ŠèƒŒé¢æœä¸Šçš„æ£‹å­å³ç¿»é–‹</p>
        <p>â€¢ <strong>ç§»å‹•</strong>ï¼šå…ˆé»é¸å·±æ–¹æ£‹å­ï¼Œå†é»é¸ç›®æ¨™ï¼ˆç¶ é»=å¯ç§»å‹•ï¼Œç´…æ¡†=å¯åƒå­ï¼‰</p>
        <p>â€¢ <strong>æ‚”æ£‹</strong>ï¼šæ¯å±€æœ€å¤š 3 æ¬¡ï¼Œäººæ©Ÿæ¨¡å¼è‡ªå‹•æ’¤å› AI é‚£æ­¥</p>
        <p>â€¢ <strong>å¿«æ·éµ</strong>ï¼š<strong>R</strong> é‡é–‹ãƒ»<strong>U</strong> / <strong>Ctrl+Z</strong> æ‚”æ£‹ãƒ»<strong>Esc</strong> é—œé–‰è¦–çª—</p>
      </div>
    </div>
  </div>
</div>

<!-- æˆå°±æ¨¡æ…‹æ¡† -->
<div class="modal-overlay" id="ach-modal">
  <div class="modal-box">
    <div class="modal-header">
      <h2>æˆå°±æ®¿å ‚</h2>
      <button class="modal-close" onclick="closeModal('ach-modal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="ach-progress-bar">
        <div class="ach-progress-fill" id="ach-progress-fill"></div>
      </div>
      <div style="text-align:center;font-size:12px;color:var(--text-mute);margin-bottom:16px;">
        å·²è§£é– <span id="ach-unlock-count" style="color:var(--accent);font-weight:700;">0</span>
        / <span id="ach-total-count">0</span> é …æˆå°±
      </div>
      <div class="ach-tabs" id="ach-tabs"></div>
      <div class="ach-grid" id="ach-grid"></div>
    </div>
  </div>
</div>

<!-- å‹åˆ©è¦†è“‹ -->
<div id="win-overlay">
  <div class="win-box">
    <div class="win-icon" id="win-icon">ğŸ†</div>
    <div class="win-title" id="win-title">ç²å‹ï¼</div>
    <div class="win-sub"   id="win-sub">æœ¬å±€å°æˆ°çµæŸ</div>
    <div class="win-stats" id="win-stats"></div>
    <div class="win-actions">
      <button class="win-btn" onclick="closeWin();initGame();">å†æˆ°ä¸€å±€</button>
      <button class="win-btn secondary" onclick="closeWin();openModal('ach-modal');renderAchGrid();">æŸ¥çœ‹æˆå°±</button>
    </div>
  </div>
</div>

<!-- ä¸»æ‡‰ç”¨ -->
<div id="app">
  <nav class="top-nav">
    <div class="nav-brand">
      <div>
        <h1>æš—ã€€æ£‹</h1>
        <p class="subtitle">å®®å»·ç‰ˆ Â· éš¨æ©Ÿæ£‹å±€</p>
      </div>
    </div>
    <div class="nav-actions">
      <!-- ä¸»é¡Œé¸æ“‡å™¨ -->
      <div class="theme-picker" title="åˆ‡æ›ä¸»é¡Œ">
        <div class="theme-dot active" data-t="dark"  onclick="setTheme('dark')"  title="æš—å¤œç„é‡‘"></div>
        <div class="theme-dot"       data-t="paper" onclick="setTheme('paper')" title="å®£ç´™å¤å·"></div>
        <div class="theme-dot"       data-t="blue"  onclick="setTheme('blue')"  title="é’èŠ±ç“·è—"></div>
        <div class="theme-dot"       data-t="jade"  onclick="setTheme('jade')"  title="ç¿¡ç¿ æ˜¥æ„"></div>
      </div>
      <button class="nav-btn" onclick="openModal('rules-modal')">ğŸ“– è¦å‰‡</button>
      <button class="nav-btn" onclick="openModal('ach-modal');renderAchGrid()">ğŸ… æˆå°±</button>
      <button class="nav-btn danger" onclick="confirmResetStats()" title="é‡ç½®æ‰€æœ‰æˆ°ç¸¾èˆ‡æˆå°±">ğŸ—‘</button>
    </div>
  </nav>

  <div class="stats-bar">
    <div class="stat-card"><div class="stat-num win"   id="s-win">0</div>   <div class="stat-label">å‹åˆ©</div></div>
    <div class="stat-card"><div class="stat-num lose"  id="s-lose">0</div>  <div class="stat-label">æ•—åŒ—</div></div>
    <div class="stat-card"><div class="stat-num draw"  id="s-draw">0</div>  <div class="stat-label">å¹³å±€</div></div>
    <div class="stat-card"><div class="stat-num total" id="s-total">0</div> <div class="stat-label">ç¸½å ´æ¬¡</div></div>
    <div class="stat-card"><div class="stat-num ach"   id="s-ach">0</div>   <div class="stat-label">æˆå°±</div></div>
    <div class="stat-card" id="s-winrate-card" style="display:none">
      <div class="stat-num" id="s-winrate" style="color:#ffd54f">-%</div>
      <div class="stat-label">å‹ç‡</div>
    </div>
  </div>

  <div class="control-panel">
    <div class="controls">
      <select id="mode-select" onchange="toggleDifficulty();initGame();">
        <option value="PvE">âš” äººæ©Ÿå°æˆ°</option>
        <option value="PvP">ğŸ‘¥ é›™äººå°æˆ°</option>
      </select>
      <div id="difficulty-container">
        <select id="ai-difficulty" onchange="initGame()">
          <option value="easy">ğŸ² è‚‰è…³ AIï¼ˆéš¨æ©Ÿï¼‰</option>
          <option value="normal" selected>ğŸ§  æ™®é€š AIï¼ˆè²ªå©ªï¼‰</option>
          <option value="hard">â™Ÿ é«˜æ‰‹ AIï¼ˆæ·±è¬€ï¼‰</option>
        </select>
      </div>
      <button class="game-btn" id="undo-btn" onclick="undoMove()" title="å¿«æ·éµï¼šU / Ctrl+Z">âª æ‚”æ£‹ï¼ˆ<span id="undo-count">3</span>ï¼‰</button>
      <button class="game-btn" id="restart-btn" onclick="initGame()" title="å¿«æ·éµï¼šR">ğŸ”„ é‡æ–°é–‹å§‹</button>
    </div>
    <div id="info-box">è«‹ç¿»é–‹ç¬¬ä¸€é¡†æ£‹å­æ±ºå®šé™£ç‡Ÿ</div>
  </div>

  <div id="game-layout">
    <div class="board-wrap">
      <div class="board-label">æš—æ£‹æ£‹ç›¤ Â· å››è¡Œå…«åˆ— Â· å…±ä¸‰åäºŒæ ¼</div>
      <div id="board"></div>
      <div class="coord-row">
        <span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span>
        <span>äº”</span><span>å…­</span><span>ä¸ƒ</span><span>å…«</span>
      </div>
    </div>

    <div id="side-panel">
      <div class="panel-section">
        <div class="section-title red-t">ğŸ”´ ç´…æ–¹ Â· è¢«åƒæ£‹å­</div>
        <div id="captured-red" class="captured-container"></div>
      </div>
      <div class="panel-section">
        <div class="section-title blk-t">âš« é»‘æ–¹ Â· è¢«åƒæ£‹å­</div>
        <div id="captured-black" class="captured-container"></div>
      </div>
      <div class="panel-section">
        <div class="section-title log-t">ğŸ“œ å°å±€è¨˜éŒ„</div>
        <ul id="history-list"></ul>
      </div>
      <div class="panel-section">
        <div class="section-title rule-t">âš– åƒå­éšç´š</div>
        <div class="rank-table">
          <div class="rank-row"><span class="rank-pieces">å¸¥/å°‡</span><span class="rank-desc">æœ€é«˜ï¼ˆå…µ/å’é™¤å¤–ï¼‰</span></div>
          <div class="rank-row"><span class="rank-pieces">ä»•/å£« ç›¸/è±¡</span><span class="rank-desc">é«˜éš</span></div>
          <div class="rank-row"><span class="rank-pieces">ä¿¥/è»Š å‚Œ/é¦¬</span><span class="rank-desc">ä¸­éš</span></div>
          <div class="rank-row"><span class="rank-pieces">ç‚®/åŒ…</span><span class="rank-desc">éš”å­åƒï¼Œç„¡é™è·</span></div>
          <div class="rank-row"><span class="rank-pieces">å…µ/å’</span><span class="rank-desc">æœ€å¼±ï¼Œä½†å…‹å¸¥/å°‡</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
'use strict';

// ================================================
// ä¸»é¡Œç³»çµ±
// ================================================
const THEMES = ['dark','paper','blue','jade'];
let currentTheme = 'dark';

function setTheme(t) {
  if (!THEMES.includes(t)) return;
  currentTheme = t;
  document.documentElement.setAttribute('data-theme', t);
  document.querySelectorAll('.theme-dot').forEach(d => {
    d.classList.toggle('active', d.dataset.t === t);
  });
  try { localStorage.setItem('darkchess_theme', t); } catch(e){}
}

function loadTheme() {
  try {
    const saved = localStorage.getItem('darkchess_theme');
    if (saved && THEMES.includes(saved)) setTheme(saved);
  } catch(e) {}
}

// ================================================
// æ’’èŠ±ç‰¹æ•ˆ
// ================================================
const confCanvas = document.getElementById('confetti-canvas');
const confCtx    = confCanvas.getContext('2d');
let confParticles = [], confAnimId = null;

function fireConfetti() {
  confCanvas.width  = window.innerWidth;
  confCanvas.height = window.innerHeight;
  confParticles = [];
  const colors = ['#fce18a','#ff726d','#b48def','#f4306d','#4caf50','#00bcd4','#ffd700','#ff9800'];
  for (let i = 0; i < 200; i++) {
    confParticles.push({
      x: Math.random() * confCanvas.width,
      y: Math.random() * confCanvas.height - confCanvas.height,
      r: Math.random() * 7 + 3,
      dx: Math.random() * 4 - 2,
      dy: Math.random() * 5 + 2,
      color: colors[Math.floor(Math.random() * colors.length)],
      tiltAngleInc: Math.random() * 0.07 + 0.04,
      tiltAngle: 0,
      tilt: Math.random() * 10
    });
  }
  if (!confAnimId) animConf();
}

function animConf() {
  if (!isGameOver) { confCtx.clearRect(0,0,confCanvas.width,confCanvas.height); confAnimId = null; return; }
  confAnimId = requestAnimationFrame(animConf);
  confCtx.clearRect(0, 0, confCanvas.width, confCanvas.height);
  confParticles.forEach(p => {
    p.tiltAngle += p.tiltAngleInc;
    p.y += (Math.cos(p.tiltAngle) + p.dy + p.r/2) / 2;
    p.x += Math.sin(p.tiltAngle) * 2 + p.dx;
    if (p.y > confCanvas.height) { p.y = -10; p.x = Math.random() * confCanvas.width; }
    confCtx.beginPath();
    confCtx.lineWidth   = p.r;
    confCtx.strokeStyle = p.color;
    confCtx.moveTo(p.x + p.tilt + p.r, p.y);
    confCtx.lineTo(p.x + p.tilt, p.y + p.tilt + p.r);
    confCtx.stroke();
  });
}

function stopConfetti() {
  if (confAnimId) cancelAnimationFrame(confAnimId);
  confAnimId = null;
  confCtx.clearRect(0, 0, confCanvas.width, confCanvas.height);
}

// ================================================
// éŸ³æ•ˆç³»çµ±
// ================================================
let audioCtx = null;

function getAC() {
  if (!audioCtx) {
    try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){}
  }
  return audioCtx;
}

function playSound(freq, dur = 0.1, type = 'square', vol = 0.12) {
  const ac = getAC();
  if (!ac) return;
  if (ac.state === 'suspended') ac.resume();
  try {
    const o = ac.createOscillator();
    const g = ac.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.setValueAtTime(vol, ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + dur);
    o.connect(g);
    g.connect(ac.destination);
    o.start();
    o.stop(ac.currentTime + dur);
  } catch(e) {}
}

// ================================================
// æ¨¡æ…‹æ¡†
// ================================================
function openModal(id)  { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if (e.target === el) el.classList.remove('show'); });
});

// ================================================
// æŒä¹…åŒ–å­˜å„²
// ================================================
const STORAGE_KEY = 'darkchess_v4';

function loadStorage() {
  try { const d = localStorage.getItem(STORAGE_KEY); return d ? JSON.parse(d) : null; }
  catch(e) { return null; }
}
function saveStorage(data) {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e){}
}

let playerStats     = { wins:0, losses:0, draws:0, totalGames:0 };
let cumulativeStats = { totalCannonKills:0, totalSoldierKillKing:0, winStreak:0, loseStreak:0 };
let unlockedAchievements = {};

// ================================================
// æˆå°±å®šç¾©ï¼ˆ25ç¨®ï¼‰
// ================================================
const ACHIEVEMENTS = [
  { id:'first_flip',      name:'åˆæ¢æš—æ£‹',   icon:'ğŸ´', desc:'ç¿»é–‹ç¬¬ä¸€é¡†æ£‹å­',                  rarity:'common',    cat:'æ–°æ‰‹', secret:false },
  { id:'first_win',       name:'é¦–å‹',       icon:'ğŸ‰', desc:'è´å¾—ç¬¬ä¸€å ´å°å±€',                  rarity:'common',    cat:'æ–°æ‰‹', secret:false },
  { id:'first_cannon',    name:'ç ²ç«åˆè©¦',   icon:'ğŸ’¥', desc:'ç”¨ç‚®/åŒ…æˆåŠŸåƒæ‰ä¸€é¡†æ£‹å­',        rarity:'common',    cat:'æ–°æ‰‹', secret:false },
  { id:'first_soldier_king', name:'ä»¥å¼±å‹å¼·',icon:'âš¡', desc:'ç”¨å…µ/å’åƒæ‰å¸¥/å°‡',               rarity:'common',    cat:'æ–°æ‰‹', secret:false },
  { id:'win5',            name:'äº”é€£æ·',     icon:'ğŸŒŸ', desc:'ç´¯ç©è´å¾— 5 å ´å°å±€',               rarity:'common',    cat:'å‹å ´', secret:false },
  { id:'win10',           name:'åå‹',       icon:'ğŸ–', desc:'ç´¯ç©è´å¾— 10 å ´å°å±€',              rarity:'rare',      cat:'å‹å ´', secret:false },
  { id:'win25',           name:'èº«ç¶“ç™¾æˆ°',   icon:'ğŸ…', desc:'ç´¯ç©è´å¾— 25 å ´å°å±€',              rarity:'rare',      cat:'å‹å ´', secret:false },
  { id:'win50',           name:'æ£‹å£‡å®—å¸«',   icon:'ğŸ‘‘', desc:'ç´¯ç©è´å¾— 50 å ´å°å±€',              rarity:'epic',      cat:'å‹å ´', secret:false },
  { id:'beat_easy',       name:'ç†±èº«å®Œç•¢',   icon:'ğŸ˜', desc:'æ“Šæ•—è‚‰è…³ AI',                     rarity:'common',    cat:'æŒ‘æˆ°', secret:false },
  { id:'beat_normal',     name:'ç•¥æœ‰å°æˆ',   icon:'ğŸ§ ', desc:'æ“Šæ•—æ™®é€š AI',                     rarity:'rare',      cat:'æŒ‘æˆ°', secret:false },
  { id:'beat_hard',       name:'é«˜æ‰‹éæ‹›',   icon:'â™Ÿ',  desc:'æ“Šæ•—é«˜æ‰‹ AI',                    rarity:'epic',      cat:'æŒ‘æˆ°', secret:false },
  { id:'beat_pvp',        name:'å®¿æ•µ',       icon:'ğŸ‘¥', desc:'åœ¨é›™äººå°æˆ°ä¸­ç²å‹',                rarity:'rare',      cat:'æŒ‘æˆ°', secret:false },
  { id:'fast_win',        name:'é–ƒé›»æˆ°',     icon:'âš¡', desc:'åœ¨ 15 å›åˆå…§ç²å‹',                rarity:'rare',      cat:'é¢¨æ ¼', secret:false },
  { id:'clean_win',       name:'å…‰æ˜æ­£å¤§',   icon:'âœ¨', desc:'ä¸ä½¿ç”¨ä»»ä½•æ‚”æ£‹è´å¾—å°å±€',          rarity:'rare',      cat:'é¢¨æ ¼', secret:false },
  { id:'cannon_master',   name:'ç‚®å…µå¤§å¸«',   icon:'ğŸ’£', desc:'å–®å±€ç”¨ç‚®/åŒ…åƒæ‰ 3 é¡†æ£‹å­',        rarity:'epic',      cat:'é¢¨æ ¼', secret:false },
  { id:'eat_7',           name:'å¤§èƒƒç‹',     icon:'ğŸ˜‹', desc:'å–®å±€åƒæ‰ 7 é¡†æ£‹å­',               rarity:'rare',      cat:'é¢¨æ ¼', secret:false },
  { id:'flip_master',     name:'ç¿»ç‰Œç‹‚äºº',   icon:'ğŸƒ', desc:'å–®å±€ç¿»é–‹è¶…é 15 é¡†æš—æ£‹',          rarity:'rare',      cat:'é¢¨æ ¼', secret:false },
  { id:'cannon5',         name:'ç ²ç«é€£å¤©',   icon:'ğŸ”¥', desc:'ç´¯è¨ˆç”¨ç‚®/åŒ…åƒæ‰ 5 é¡†æ£‹å­',        rarity:'epic',      cat:'ç¨€æœ‰', secret:false },
  { id:'soldier_king3',   name:'ä»¥å°åšå¤§',   icon:'ğŸ‰', desc:'ç´¯è¨ˆç”¨å…µ/å’åƒæ‰å¸¥/å°‡ 3 æ¬¡',       rarity:'epic',      cat:'ç¨€æœ‰', secret:false },
  { id:'comeback',        name:'çµ•åœ°åæ”»',   icon:'ğŸ”„', desc:'ä½¿ç”¨ 3 æ¬¡æ‚”æ£‹å¾Œä»ç„¶è´å¾—æ¯”è³½',     rarity:'epic',      cat:'ç¨€æœ‰', secret:true  },
  { id:'no_loss',         name:'ä¸æ•—é‡‘èº«',   icon:'ğŸ›¡', desc:'é€£è´ 5 å ´ä¸æ•—',                   rarity:'legendary', cat:'å‚³èªª', secret:false },
  { id:'legend',          name:'æš—æ£‹å‚³èªª',   icon:'ğŸŒ™', desc:'ç´¯è¨ˆéŠæˆ² 100 å ´',                 rarity:'legendary', cat:'å‚³èªª', secret:false },
  { id:'all_diff',        name:'å…¨èƒ½æ£‹æ‰‹',   icon:'ğŸ­', desc:'æ“Šæ•—æ‰€æœ‰é›£åº¦ AI ä¸”è´éé›™äººå°æˆ°',  rarity:'legendary', cat:'å‚³èªª', secret:false },
  { id:'secret_flip',     name:'å‘½é‹ç¿»è½‰',   icon:'ğŸŒ€', desc:'é¦–ç¿»ç¿»åˆ°å¸¥/å°‡',                   rarity:'legendary', cat:'å‚³èªª', secret:true  },
  { id:'dominator',       name:'å®Œå…¨åˆ¶éœ¸',   icon:'âšœ', desc:'è§£é–æ‰€æœ‰å…¶ä»–æˆå°±',               rarity:'legendary', cat:'å‚³èªª', secret:false },
];
const CATEGORIES = ['å…¨éƒ¨','æ–°æ‰‹','å‹å ´','æŒ‘æˆ°','é¢¨æ ¼','ç¨€æœ‰','å‚³èªª'];
let currentAchTab = 'å…¨éƒ¨';

function loadAchievements() {
  const d = loadStorage();
  if (d) {
    unlockedAchievements = d.achievements || {};
    playerStats     = { ...playerStats,     ...(d.stats || {}) };
    cumulativeStats = { ...cumulativeStats, ...(d.cumulativeStats || {}) };
  }
}

function saveAchievements() {
  const d = loadStorage() || {};
  d.achievements    = unlockedAchievements;
  d.stats           = playerStats;
  d.cumulativeStats = cumulativeStats;
  saveStorage(d);
}

function unlockAchievement(id) {
  if (unlockedAchievements[id]) return;
  const ach = ACHIEVEMENTS.find(a => a.id === id);
  if (!ach) return;
  unlockedAchievements[id] = Date.now();
  saveAchievements();
  showAchToast(ach);
  updateStatsUI();
  // å…¨æˆå°±è§£é–å¾Œè§¸ç™¼ dominator
  const others = ACHIEVEMENTS.filter(a => a.id !== 'dominator');
  if (others.every(a => unlockedAchievements[a.id])) {
    setTimeout(() => unlockAchievement('dominator'), 900);
  }
}

function showAchToast(ach) {
  playSound(523, 0.08, 'sine', 0.12);
  setTimeout(() => playSound(659, 0.10, 'sine', 0.12), 110);
  setTimeout(() => playSound(784, 0.18, 'sine', 0.14), 230);
  const container = document.getElementById('ach-toast');
  const el = document.createElement('div');
  el.className = 'ach-toast-item';
  el.innerHTML = `
    <div class="ach-toast-icon">${ach.icon}</div>
    <div class="ach-toast-text">
      <div class="ach-toast-label">ğŸ… æˆå°±è§£é–ï¼</div>
      <div class="ach-toast-name">${ach.name}</div>
      <div class="ach-toast-desc">${ach.desc}</div>
    </div>`;
  container.appendChild(el);
  setTimeout(() => {
    el.classList.add('out');
    setTimeout(() => el.remove(), 360);
  }, 3600);
}

function renderAchGrid() {
  const tabsEl = document.getElementById('ach-tabs');
  tabsEl.innerHTML = '';
  CATEGORIES.forEach(cat => {
    const btn = document.createElement('button');
    btn.className = 'ach-tab' + (currentAchTab === cat ? ' active' : '');
    const cnt = cat === 'å…¨éƒ¨' ? ACHIEVEMENTS.length : ACHIEVEMENTS.filter(a => a.cat === cat).length;
    btn.textContent = `${cat} (${cnt})`;
    btn.onclick = () => { currentAchTab = cat; renderAchGrid(); };
    tabsEl.appendChild(btn);
  });
  const unlocked = Object.keys(unlockedAchievements).length;
  const total    = ACHIEVEMENTS.length;
  document.getElementById('ach-unlock-count').textContent = unlocked;
  document.getElementById('ach-total-count').textContent  = total;
  document.getElementById('ach-progress-fill').style.width = (unlocked / total * 100) + '%';
  const grid     = document.getElementById('ach-grid');
  grid.innerHTML = '';
  const filtered = currentAchTab === 'å…¨éƒ¨' ? ACHIEVEMENTS : ACHIEVEMENTS.filter(a => a.cat === currentAchTab);
  filtered.forEach(ach => {
    const isUnlocked = !!unlockedAchievements[ach.id];
    const card = document.createElement('div');
    card.className = 'ach-card' + (isUnlocked ? ' unlocked' : '') + (ach.secret && !isUnlocked ? ' secret' : '');
    const rarityLabel = { common:'æ™®é€š', rare:'ç¨€æœ‰', epic:'å²è©©', legendary:'å‚³èªª' }[ach.rarity];
    const dateStr     = isUnlocked ? new Date(unlockedAchievements[ach.id]).toLocaleDateString('zh-TW') : '';
    const dName = ach.secret && !isUnlocked ? '????' : ach.name;
    const dDesc = ach.secret && !isUnlocked ? 'éš±è—æˆå°±ï¼Œç¹¼çºŒéŠç©ä»¥è§£é–' : ach.desc;
    const dIcon = ach.secret && !isUnlocked ? 'ğŸ”’' : ach.icon;
    card.innerHTML = `
      ${isUnlocked ? '<div class="ach-shimmer"></div>' : ''}
      <div class="ach-icon">${dIcon}</div>
      <span class="ach-rarity rarity-${ach.rarity}">${rarityLabel}</span>
      <div class="ach-name">${dName}</div>
      <div class="ach-desc">${dDesc}</div>
      ${isUnlocked ? `<div class="ach-unlock-date">âœ“ ${dateStr} è§£é–</div>` : ''}
      <div class="ach-lock-icon">ğŸ”’</div>`;
    grid.appendChild(card);
  });
}

// ================================================
// æ£‹å­å®šç¾©
// ================================================
const pieceTypes = [
  {name:'å¸¥',color:'red',rank:7},{name:'å°‡',color:'black',rank:7},
  {name:'ä»•',color:'red',rank:6},{name:'ä»•',color:'red',rank:6},
  {name:'å£«',color:'black',rank:6},{name:'å£«',color:'black',rank:6},
  {name:'ç›¸',color:'red',rank:5},{name:'ç›¸',color:'red',rank:5},
  {name:'è±¡',color:'black',rank:5},{name:'è±¡',color:'black',rank:5},
  {name:'ä¿¥',color:'red',rank:4},{name:'ä¿¥',color:'red',rank:4},
  {name:'è»Š',color:'black',rank:4},{name:'è»Š',color:'black',rank:4},
  {name:'å‚Œ',color:'red',rank:3},{name:'å‚Œ',color:'red',rank:3},
  {name:'é¦¬',color:'black',rank:3},{name:'é¦¬',color:'black',rank:3},
  {name:'ç‚®',color:'red',rank:2},{name:'ç‚®',color:'red',rank:2},
  {name:'åŒ…',color:'black',rank:2},{name:'åŒ…',color:'black',rank:2},
  {name:'å…µ',color:'red',rank:1},{name:'å…µ',color:'red',rank:1},{name:'å…µ',color:'red',rank:1},
  {name:'å…µ',color:'red',rank:1},{name:'å…µ',color:'red',rank:1},
  {name:'å’',color:'black',rank:1},{name:'å’',color:'black',rank:1},{name:'å’',color:'black',rank:1},
  {name:'å’',color:'black',rank:1},{name:'å’',color:'black',rank:1}
];

// ================================================
// éŠæˆ²ç‹€æ…‹
// ================================================
let board=[], selectedIdx=-1, validMoves=[], turn='none', isGameOver=false;
let capturedPieces={red:[],black:[]}, historyStack=[], logStack=[];
let aiColor=null, aiTimeoutId=null, undoRemaining=3;
let gameMode='PvE', aiDifficulty='normal', lastMovedIdx=-1;
let gs = {};  // æœ¬å±€çµ±è¨ˆ

function resetGs() {
  gs = { turns:0, eaten:0, cannonKills:0, soldierKillKing:0, flips:0, undosUsed:0, firstFlipDone:false };
}

// ================================================
// UI æ›´æ–°
// ================================================
function updateStatsUI() {
  document.getElementById('s-win').textContent   = playerStats.wins;
  document.getElementById('s-lose').textContent  = playerStats.losses;
  document.getElementById('s-draw').textContent  = playerStats.draws;
  document.getElementById('s-total').textContent = playerStats.totalGames;
  document.getElementById('s-ach').textContent   = Object.keys(unlockedAchievements).length;
  const pveGames = playerStats.wins + playerStats.losses;
  const wrCard   = document.getElementById('s-winrate-card');
  if (pveGames > 0) {
    const wr = Math.round(playerStats.wins / pveGames * 100);
    const el = document.getElementById('s-winrate');
    el.textContent  = wr + '%';
    el.style.color  = wr >= 60 ? '#66bb6a' : wr >= 40 ? '#ffd54f' : '#ef5350';
    wrCard.style.display = '';
  } else {
    wrCard.style.display = 'none';
  }
}

function toggleDifficulty() {
  const mode = document.getElementById('mode-select').value;
  const dc   = document.getElementById('difficulty-container');
  dc.style.opacity      = mode === 'PvE' ? '1' : '0.3';
  dc.style.pointerEvents= mode === 'PvE' ? 'auto' : 'none';
}

function setInfo(text, color) {
  const el = document.getElementById('info-box');
  el.textContent  = text;
  el.style.color  = color || 'var(--text-main)';
}

function updateInfo() {
  if (isGameOver) return;
  const isAI  = gameMode === 'PvE' && turn === aiColor;
  const label = turn === 'red' ? 'ğŸ”´ ç´…æ–¹' : 'âš« é»‘æ–¹';
  let who;
  if (gameMode === 'PvE') {
    who = isAI ? 'ğŸ¤– AI æ€è€ƒä¸­â€¦' : 'ğŸ‘¤ ä½ çš„å›åˆ';
  } else {
    who = turn === 'red' ? 'ğŸ‘¤ ç´…æ–¹ç©å®¶' : 'ğŸ‘¤ é»‘æ–¹ç©å®¶';
  }
  setInfo(`${label} Â· ${who}`, turn === 'red' ? '#ef9a9a' : '#90a4ae');
}

function updateUndoUI() {
  document.getElementById('undo-count').textContent = undoRemaining;
  document.getElementById('undo-btn').disabled =
    undoRemaining <= 0 || historyStack.length === 0 || isGameOver;
}

// ================================================
// éŠæˆ²åˆå§‹åŒ–
// ================================================
function initGame() {
  if (aiTimeoutId) { clearTimeout(aiTimeoutId); aiTimeoutId = null; }
  stopConfetti(); closeWin();
  undoRemaining = 3;
  gameMode     = document.getElementById('mode-select').value;
  aiDifficulty = document.getElementById('ai-difficulty').value;
  aiColor = null; isGameOver = false; turn = 'none';
  selectedIdx = -1; validMoves = []; lastMovedIdx = -1;
  capturedPieces = {red:[], black:[]}; historyStack = []; logStack = [];
  resetGs();
  const shuffled = [...pieceTypes].sort(() => Math.random() - 0.5);
  board = shuffled.map(p => ({ piece:{...p}, isFaceUp:false, isEmpty:false }));
  renderBoard(); renderCaptured(); renderLog(); updateUndoUI();
  setInfo('è«‹ç¿»é–‹ç¬¬ä¸€é¡†æ£‹å­æ±ºå®šé™£ç‡Ÿ', 'var(--accent)');
}

// ================================================
// æ ¸å¿ƒè¦å‰‡ï¼ˆå·²ä¿®æ­£ç‚®ç§»å‹• & ç›¸é„°åˆ¤æ–·ï¼‰
// ================================================
function canMove(from, to) {
  if (from < 0 || to < 0 || from === to) return false;
  const f = board[from], t = board[to];
  if (f.isEmpty || !f.isFaceUp) return false;
  if (!t.isEmpty && !t.isFaceUp) return false; // ä¸èƒ½èµ°å‘æœªç¿»é¢æ£‹å­

  const r1 = Math.floor(from / 8), c1 = from % 8;
  const r2 = Math.floor(to   / 8), c2 = to   % 8;
  const sameRow = r1 === r2, sameCol = c1 === c2;
  const dist = Math.abs(r1 - r2) + Math.abs(c1 - c2);

  // ç‚®/åŒ…ï¼šç‰¹æ®Šç§»å‹•è¦å‰‡
  if (f.piece.rank === 2) {
    if (!sameRow && !sameCol) return false;
    let cnt = 0;
    if (sameRow) {
      for (let c = Math.min(c1,c2)+1; c < Math.max(c1,c2); c++)
        if (!board[r1*8+c].isEmpty) cnt++;
    } else {
      for (let r = Math.min(r1,r2)+1; r < Math.max(r1,r2); r++)
        if (!board[r*8+c1].isEmpty) cnt++;
    }
    if (t.isEmpty) return cnt === 0;                                   // ç§»å‹•åˆ°ç©ºæ ¼
    return cnt === 1 && f.piece.color !== t.piece.color;               // åƒå­
  }

  // ä¸€èˆ¬æ£‹å­ï¼šåªèƒ½èµ°ç›¸é„°ä¸€æ ¼
  if (dist !== 1) return false;
  if (t.isEmpty) return true;
  if (f.piece.color === t.piece.color) return false;
  if (f.piece.rank === 1 && t.piece.rank === 7) return true;           // å…µåƒå¸¥
  if (f.piece.rank === 7 && t.piece.rank === 1) return false;          // å¸¥ä¸èƒ½åƒå…µ
  return f.piece.rank >= t.piece.rank;
}

// ================================================
// å‹•ä½œè™•ç†
// ================================================
function processAction(idx) {
  if (isGameOver || (gameMode === 'PvE' && turn === aiColor)) return;
  getAC(); // ç¢ºä¿ AudioContext å•Ÿå‹•
  const sq = board[idx];

  // é»åˆ°ç©ºæ ¼
  if (sq.isEmpty) {
    if (selectedIdx !== -1 && canMove(selectedIdx, idx)) executeMove(selectedIdx, idx);
    else { selectedIdx = -1; validMoves = []; renderBoard(); }
    return;
  }

  // é»åˆ°æœªç¿»é¢æ£‹å­
  if (!sq.isFaceUp) {
    if (selectedIdx !== -1) { selectedIdx = -1; validMoves = []; renderBoard(); return; }
    doFlip(idx);
    return;
  }

  // é»åˆ°æ­£é¢æ£‹å­
  if (sq.piece.color === turn) {
    selectedIdx = idx; validMoves = [];
    for (let i = 0; i < 32; i++) if (canMove(idx, i)) validMoves.push(i);
    renderBoard(); playSound(350, 0.06, 'sine');
  } else if (selectedIdx !== -1 && canMove(selectedIdx, idx)) {
    executeMove(selectedIdx, idx);
  } else {
    selectedIdx = -1; validMoves = []; renderBoard();
  }
}

// ================================================
// ç¿»ç‰Œï¼ˆä¿®æ­£é¦–ç¿»å¾Œå›åˆé‚è¼¯ï¼‰
// ================================================
function doFlip(idx) {
  const sq = board[idx];
  const mover = turn === 'none' ? 'é¦–ç¿»' : (turn === 'red' ? 'ğŸ”´ ç´…' : 'âš« é»‘');
  saveState(`${mover} ç¿»é–‹ ã€${sq.piece.name}ã€‘`);
  sq.isFaceUp = true;
  gs.flips++;
  playSound(600, 0.12, 'sine');

  if (turn === 'none') {
    // âœ… ä¿®æ­£ï¼šé¦–ç¿»å¾Œç¿»ç‰Œè€…å…ˆè¡Œï¼ŒAI æ˜¯å°æ–¹é¡è‰²
    // turn å…ˆè¨­ç‚ºç¿»ç‰Œè€…é¡è‰²ï¼ŒswitchTurn å¾Œè¼ªåˆ°å°æ–¹
    aiColor = sq.piece.color === 'red' ? 'black' : 'red';
    turn    = sq.piece.color;  // ç¿»ç‰Œè€…çš„é¡è‰²

    if (!gs.firstFlipDone) {
      gs.firstFlipDone = true;
      unlockAchievement('first_flip');
      if (sq.piece.rank === 7) unlockAchievement('secret_flip');
    }
  }

  // å…ˆæ¸²æŸ“ï¼Œå†è§¸ç™¼ç¿»ç‰Œå‹•ç•«
  renderBoard();
  requestAnimationFrame(() => {
    const cells = document.getElementById('board').children;
    if (cells[idx]) {
      cells[idx].classList.add('flipping');
      setTimeout(() => { if (cells[idx]) cells[idx].classList.remove('flipping'); }, 380);
    }
  });

  // âœ… ç¿»ç‰Œå¾Œåˆ‡æ›å›åˆï¼ˆç¿»ç‰Œè€…è¡Œå‹•å®Œï¼Œè¼ªåˆ°å°æ–¹ï¼‰
  switchTurn();
}

// ================================================
// åŸ·è¡Œç§»å‹•
// ================================================
function executeMove(f, t) {
  const isCapture = !board[t].isEmpty && board[t].isFaceUp;
  // âœ… ä¿®æ­£ï¼šåªè¨ˆæ­£é¢æ£‹å­ç‚ºåƒå­ï¼ˆboard[t].isFaceUp ä¿è­·ï¼‰
  const logEntry = `${turn==='red'?'ğŸ”´ ç´…':'âš« é»‘'} ã€${board[f].piece.name}ã€‘${isCapture?'åƒ':'â†’'} ${isCapture?'ã€'+board[t].piece.name+'ã€‘':posStr(t)}`;
  saveState(logEntry);

  if (isCapture) {
    const victim = board[t].piece;
    capturedPieces[victim.color].push(victim);
    gs.eaten++;

    if (board[f].piece.rank === 2) {
      gs.cannonKills++;
      cumulativeStats.totalCannonKills++;
      unlockAchievement('first_cannon');
      if (gs.cannonKills >= 3)                      unlockAchievement('cannon_master');
      if (cumulativeStats.totalCannonKills >= 5)     unlockAchievement('cannon5');
    }
    if (board[f].piece.rank === 1 && victim.rank === 7) {
      gs.soldierKillKing++;
      cumulativeStats.totalSoldierKillKing++;
      unlockAchievement('first_soldier_king');
      if (cumulativeStats.totalSoldierKillKing >= 3) unlockAchievement('soldier_king3');
    }
    if (gs.eaten >= 7) unlockAchievement('eat_7');
    playSound(800, 0.18, 'square');
  } else {
    playSound(280, 0.10, 'sine');
  }

  board[t]       = { ...board[f] };
  board[f]       = { piece:null, isFaceUp:false, isEmpty:true };
  lastMovedIdx   = t;
  selectedIdx    = -1; validMoves = [];
  gs.turns++;
  renderCaptured(); switchTurn(); renderBoard();
}

function posStr(idx) {
  return `${ ['ä¸€','äºŒ','ä¸‰','å››'][Math.floor(idx/8)] }è¡Œ${ idx%8+1 }åˆ—`;
}

// ================================================
// ç‹€æ…‹å­˜å–
// ================================================
function saveState(m) {
  historyStack.push({
    board:          JSON.parse(JSON.stringify(board)),
    turn, aiColor,
    capturedPieces: JSON.parse(JSON.stringify(capturedPieces)),
    lastMovedIdx
  });
  logStack.push(m); renderLog(); updateUndoUI();
}

function undoMove() {
  if (undoRemaining <= 0 || historyStack.length === 0) return;
  if (aiTimeoutId) { clearTimeout(aiTimeoutId); aiTimeoutId = null; }
  undoRemaining--; gs.undosUsed++;
  playSound(380, 0.18, 'triangle');
  let s = historyStack.pop(); logStack.pop();
  // PvE æ¨¡å¼ï¼šåŒæ™‚æ’¤å› AI é‚£æ­¥
  if (gameMode === 'PvE' && historyStack.length > 0 && s.turn === aiColor) {
    s = historyStack.pop(); logStack.pop();
  }
  board = s.board; turn = s.turn; aiColor = s.aiColor;
  capturedPieces = s.capturedPieces; lastMovedIdx = s.lastMovedIdx;
  selectedIdx = -1; validMoves = [];
  renderBoard(); renderCaptured(); renderLog(); updateUndoUI(); updateInfo();
}

// ================================================
// å›åˆåˆ‡æ› & å‹è² åˆ¤å®š
// ================================================
function switchTurn() {
  turn = turn === 'red' ? 'black' : 'red';
  updateInfo();
  checkGameOver();
}

function checkHasAction(color) {
  // æœ‰æœªç¿»çš„æ£‹å­å¯ç¿»
  if (board.some(s => !s.isEmpty && !s.isFaceUp)) return true;
  // æœ‰åˆæ³•ç§»å‹•
  for (let i = 0; i < 32; i++) {
    if (!board[i].isEmpty && board[i].isFaceUp && board[i].piece.color === color)
      for (let j = 0; j < 32; j++) if (canMove(i, j)) return true;
  }
  return false;
}

function checkGameOver() {
  // âœ… ä¿®æ­£ï¼šè¨ˆç®—æ¯æ–¹ã€Œå…¨éƒ¨æ£‹å­æ•¸ã€ï¼ˆå«æœªç¿»ï¼‰ï¼Œæ­¸é›¶æ‰ç®—è¼¸
  let totalRed = 0, totalBlack = 0;
  board.forEach(s => {
    if (!s.isEmpty) {
      if (s.piece.color === 'red') totalRed++; else totalBlack++;
    }
  });

  // å°šæœªæœ‰ä»»ä½•æ£‹å­ç¿»é–‹æ™‚ï¼Œä¸åˆ¤å®šå‹è² ï¼ˆé˜²æ­¢é¦–ç¿»èª¤åˆ¤ï¼‰
  const anyFaceUp = board.some(s => !s.isEmpty && s.isFaceUp);
  if (!anyFaceUp) {
    scheduleAI(); return;
  }

  let winner = null, reason = '';
  if (totalRed   === 0) { winner = 'black'; reason = 'ç´…æ–¹æ£‹å­å…¨æ»…'; }
  else if (totalBlack === 0) { winner = 'red';   reason = 'é»‘æ–¹æ£‹å­å…¨æ»…'; }
  else if (!checkHasAction(turn)) {
    winner = turn === 'red' ? 'black' : 'red';
    reason = `${turn === 'red' ? 'ç´…' : 'é»‘'}æ–¹ç„¡æ£‹å¯èµ°`;
  }

  if (winner) { endGame(winner, reason); return; }
  scheduleAI();
}

function scheduleAI() {
  if (gameMode === 'PvE' && turn === aiColor && !isGameOver) {
    aiTimeoutId = setTimeout(performAITurn, 800);
  }
}

function endGame(winner, reason) {
  isGameOver = true; updateUndoUI();
  playerStats.totalGames++;

  // âœ… æ­£ç¢ºåˆ¤æ–·ç©å®¶é¡è‰²
  const playerColor = gameMode === 'PvE' ? (aiColor === 'red' ? 'black' : 'red') : null;
  const playerWon   = gameMode === 'PvE' ? winner === playerColor : false;

  if (gameMode === 'PvE') {
    if (playerWon) {
      playerStats.wins++;
      cumulativeStats.winStreak  = (cumulativeStats.winStreak  || 0) + 1;
      cumulativeStats.loseStreak = 0;
    } else {
      playerStats.losses++;
      cumulativeStats.loseStreak = (cumulativeStats.loseStreak || 0) + 1;
      cumulativeStats.winStreak  = 0;
    }
  } else {
    // PvPï¼šè¨ˆå…¥ç¸½å ´æ¬¡ï¼Œå‹è€…ç´¯åŠ  winStreakï¼ˆä¸è¨ˆå€‹äºº lossï¼Œè¦–ç‚ºå‹èª¼è³½ï¼‰
    playerStats.wins++;
    cumulativeStats.winStreak  = (cumulativeStats.winStreak  || 0) + 1;
    cumulativeStats.loseStreak = 0;
  }

  saveAchievements(); updateStatsUI();

  // æˆå°±è§£é–
  if (gameMode === 'PvE' && playerWon) {
    unlockAchievement('first_win');
    if (aiDifficulty === 'easy')   unlockAchievement('beat_easy');
    if (aiDifficulty === 'normal') unlockAchievement('beat_normal');
    if (aiDifficulty === 'hard')   unlockAchievement('beat_hard');
    if (gs.turns    <= 15) unlockAchievement('fast_win');
    if (gs.undosUsed === 0) unlockAchievement('clean_win');
    if (gs.undosUsed >= 3)  unlockAchievement('comeback');
    if (gs.flips    >  15)  unlockAchievement('flip_master');
  }
  if (gameMode === 'PvP' && winner)     unlockAchievement('beat_pvp');
  if (playerStats.wins >= 5)  unlockAchievement('win5');
  if (playerStats.wins >= 10) unlockAchievement('win10');
  if (playerStats.wins >= 25) unlockAchievement('win25');
  if (playerStats.wins >= 50) unlockAchievement('win50');
  if (cumulativeStats.winStreak >= 5)  unlockAchievement('no_loss');
  if (playerStats.totalGames >= 100)   unlockAchievement('legend');
  if (unlockedAchievements['beat_easy']  && unlockedAchievements['beat_normal'] &&
      unlockedAchievements['beat_hard']  && unlockedAchievements['beat_pvp'])
    unlockAchievement('all_diff');

  // UI
  const isRedWin = winner === 'red';
  const winLabel = isRedWin ? 'ğŸ”´ ç´…æ–¹' : 'âš« é»‘æ–¹';
  setInfo(`ğŸ† ${winLabel}ç²å‹ï¼ï¼ˆ${reason}ï¼‰`, isRedWin ? '#ef9a9a' : '#90a4ae');

  // å‹åˆ©éŸ³æ•ˆ
  playSound(500, 0.10, 'sine', 0.12);
  setTimeout(() => playSound(650, 0.10, 'sine', 0.12), 150);
  setTimeout(() => playSound(800, 0.35, 'sine', 0.14), 310);

  // å‹åˆ©ç•«é¢ï¼ˆå»¶é² 800ms è®“å‹•ç•«å…ˆå®Œæˆï¼‰
  setTimeout(() => {
    document.getElementById('win-icon').textContent  = isRedWin ? 'ğŸ”´' : 'âš«';
    document.getElementById('win-title').textContent = `${winLabel} ç²å‹ï¼`;
    document.getElementById('win-sub').textContent   =
      reason + (gameMode === 'PvE'
        ? ` Â· ${ aiDifficulty==='easy'?'è‚‰è…³':aiDifficulty==='normal'?'æ™®é€š':'é«˜æ‰‹' } AI`
        : ' Â· é›™äººå°æˆ°');

    const pveWR = (playerStats.wins + playerStats.losses) > 0
      ? Math.round(playerStats.wins / (playerStats.wins + playerStats.losses) * 100) + '%'
      : '-';
    document.getElementById('win-stats').innerHTML = `
      <div class="win-stat-item"><div class="win-stat-val">${gs.turns}</div>       <div class="win-stat-lbl">å›åˆæ•¸</div></div>
      <div class="win-stat-item"><div class="win-stat-val">${gs.eaten}</div>       <div class="win-stat-lbl">åƒå­æ•¸</div></div>
      <div class="win-stat-item"><div class="win-stat-val">${gs.flips}</div>       <div class="win-stat-lbl">ç¿»ç‰Œæ•¸</div></div>
      <div class="win-stat-item"><div class="win-stat-val">${gs.cannonKills}</div> <div class="win-stat-lbl">ç‚®æ“Š</div></div>
      <div class="win-stat-item"><div class="win-stat-val">${playerStats.wins}</div><div class="win-stat-lbl">ç¸½å‹å ´</div></div>
      <div class="win-stat-item"><div class="win-stat-val">${pveWR}</div>          <div class="win-stat-lbl">å‹ç‡</div></div>`;

    document.getElementById('win-overlay').classList.add('show');
    fireConfetti();
  }, 800);
}

function closeWin() {
  document.getElementById('win-overlay').classList.remove('show');
  stopConfetti();
}

// ================================================
// AI ç³»çµ±
// ================================================
function checkThreat(idx, color) {
  for (let i = 0; i < 32; i++) {
    if (!board[i].isEmpty && board[i].isFaceUp && board[i].piece.color !== color)
      if (canMove(i, idx)) return true;
  }
  return false;
}

function simThreat(fromIdx, toIdx, myPiece) {
  const tb = board[toIdx], fb = board[fromIdx];
  board[toIdx]   = { isEmpty:false, isFaceUp:true, piece:myPiece };
  board[fromIdx] = { isEmpty:true,  isFaceUp:false, piece:null };
  const threatened = checkThreat(toIdx, myPiece.color);
  board[toIdx]   = tb; board[fromIdx] = fb;
  return threatened;
}

function performAITurn() {
  if (isGameOver || turn !== aiColor) return;
  const acts = [], hids = [];

  for (let i = 0; i < 32; i++) {
    if (!board[i].isEmpty && !board[i].isFaceUp) hids.push(i);
    if (!board[i].isEmpty && board[i].isFaceUp && board[i].piece.color === aiColor) {
      for (let j = 0; j < 32; j++) {
        if (!canMove(i, j)) continue;
        let score = 0;
        const tp   = (!board[j].isEmpty && board[j].isFaceUp) ? board[j].piece : null;
        const mp   = board[i].piece;
        const threatened  = checkThreat(i, aiColor);
        const safeAfter   = !simThreat(i, j, mp);

        if (aiDifficulty === 'easy') {
          score = (tp ? tp.rank * 8 : 0) + Math.random() * 100;
        } else if (aiDifficulty === 'normal') {
          if (tp) score += tp.rank * 10;
          if (threatened && safeAfter) score += 25;
          score += Math.random() * 5;
        } else { // hard
          if (tp) {
            if (safeAfter) score += tp.rank * 55;
            else score += tp.rank > mp.rank ? (tp.rank - mp.rank) * 15 : -mp.rank * 55;
          } else {
            if (threatened) score += safeAfter ? mp.rank * 45 : -mp.rank * 55;
            else             score += safeAfter ? 2            : -mp.rank * 55;
          }
          score += Math.random() * 2.5;
        }
        acts.push({ f:i, t:j, s:score });
      }
    }
  }

  acts.sort((a, b) => b.s - a.s);
  const threshold = aiDifficulty === 'easy' ? 50 : aiDifficulty === 'hard' ? 2 : 5;

  if (acts.length > 0 && (acts[0].s > threshold || hids.length === 0)) {
    executeMove(acts[0].f, acts[0].t);
  } else if (hids.length > 0) {
    doFlip(hids[Math.floor(Math.random() * hids.length)]);
  } else if (acts.length > 0) {
    executeMove(acts[0].f, acts[0].t);
  }
}

// ================================================
// æ¸²æŸ“
// ================================================
function renderBoard() {
  const b = document.getElementById('board');
  b.innerHTML = '';
  board.forEach((s, i) => {
    const c = document.createElement('div');
    let cls = 'cell';
    if (s.isEmpty)       cls += ' empty';
    else if (!s.isFaceUp) cls += ' hidden';
    if (s.isFaceUp && !s.isEmpty) {
      c.textContent = s.piece.name;
      cls += ' ' + (s.piece.color === 'red' ? 'red-p' : 'black-p');
    }
    if (i === selectedIdx)  cls += ' selected';
    if (i === lastMovedIdx && !s.isEmpty) cls += ' last-moved';
    if (validMoves.includes(i)) cls += s.isEmpty ? ' valid-move' : ' valid-capture';
    c.className = cls;
    c.onclick   = () => processAction(i);
    b.appendChild(c);
  });
}

function renderCaptured() {
  ['red','black'].forEach(color => {
    const el = document.getElementById('captured-' + color);
    el.innerHTML = '';
    capturedPieces[color].forEach(p => {
      const d = document.createElement('div');
      d.className = 'captured-piece cp-' + (p.color === 'red' ? 'red' : 'blk');
      d.textContent = p.name;
      el.appendChild(d);
    });
  });
}

function renderLog() {
  const l = document.getElementById('history-list');
  l.innerHTML = logStack.map((s, i) => `<li>${i+1}. ${s}</li>`).join('');
  l.scrollTop = l.scrollHeight;
}

// ================================================
// é‡ç½®æˆ°ç¸¾
// ================================================
function confirmResetStats() {
  if (!confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰æˆ°ç¸¾èˆ‡æˆå°±å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;
  localStorage.removeItem(STORAGE_KEY);
  playerStats     = { wins:0, losses:0, draws:0, totalGames:0 };
  cumulativeStats = { totalCannonKills:0, totalSoldierKillKing:0, winStreak:0, loseStreak:0 };
  unlockedAchievements = {};
  updateStatsUI();
  playSound(220, 0.2, 'triangle', 0.08);
}

// ================================================
// éµç›¤å¿«æ·éµ
// ================================================
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay.show').forEach(m => m.classList.remove('show'));
    closeWin(); return;
  }
  if (document.querySelector('.modal-overlay.show')) return;
  if ((e.key === 'r' || e.key === 'R') && !e.ctrlKey && !e.metaKey) initGame();
  if ((e.key === 'z' || e.key === 'Z') && (e.ctrlKey || e.metaKey)) { e.preventDefault(); undoMove(); }
  if (e.key === 'u' || e.key === 'U') undoMove();
});

window.addEventListener('resize', () => {
  if (confAnimId) { confCanvas.width = window.innerWidth; confCanvas.height = window.innerHeight; }
});

// ================================================
// å•Ÿå‹•
// ================================================
loadTheme();
loadAchievements();
updateStatsUI();
toggleDifficulty();
initGame();
</script>
</body>
</html>
